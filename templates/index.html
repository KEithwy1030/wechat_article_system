<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾®ä¿¡å…¬ä¼—å·AIè‡ªåŠ¨å‘å¸ƒç³»ç»Ÿ</title>
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- CodeMirror CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
    
    <!-- è‡ªå®šä¹‰CSS -->
    <link href="{{ url_for('static', filename='css/layout.css') }}?v=3" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/components.css') }}?v=3" rel="stylesheet">
    <style>
        /* æ—¥æœŸåˆ†ç»„èœå•æ æ ·å¼ */
        .date-navbar {
            background: #f8f9fa;
            padding: 0;
        }
        
        /* é¢„æµ‹ç»“æœæ˜¾ç¤ºæ ·å¼ */
        .prediction-info {
            font-size: 0.9em;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            flex-wrap: nowrap;
        }
        
        .reason-tooltip {
            display: inline-flex;
            align-items: center;
        }
        
        .reason-tooltip i {
            cursor: pointer;
        }
        
        .badge-action {
            cursor: pointer;
        }
        
        .prediction-scores {
            font-weight: bold;
            color: #495057;
            margin-bottom: 0;
            white-space: nowrap;
        }
        
        .prediction-source {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .source-icon {
            font-size: 1.1em;
        }
        
        .source-text {
            font-size: 0.8em;
        }
        
        /* æ·±åº¦åˆ†æè¡Œæ ·å¼ */
        .table-warning {
            background-color: #fff3cd !important;
        }
        
        .selected-for-analysis {
            background-color: #e7f3ff !important;
        }
        
        /* ç»Ÿä¸€è¡Œé«˜ */
        .table tbody tr {
            height: 60px;
        }
        
        .table tbody td {
            vertical-align: middle;
        }
        
        .sporttery-matches-table {
            width: 100%;
        }
        
        .sporttery-matches-table th {
            white-space: nowrap;
        }
        
        .league-header,
        .league-cell {
            width: 4em;
            min-width: 4em;
            max-width: 4em;
            text-align: center;
            white-space: nowrap;
        }
        
        .matchup-cell {
            min-width: 260px;
            white-space: nowrap;
            text-align: center;
        }
        
        .matchup-cell .team-name {
            display: inline-block;
            max-width: 45%;
            overflow: hidden;
            text-overflow: ellipsis;
            vertical-align: middle;
            padding: 0 6px;
        }
        
        .matchup-cell .vs-divider {
            margin: 0 6px;
            color: #6c757d;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .scheduler-config-table th,
        .scheduler-config-table td {
            vertical-align: middle;
        }

        .scheduler-hint {
            color: #6c757d;
            font-size: 0.85rem;
        }
        
        @media (max-width: 1400px) {
            .matchup-cell {
                min-width: 220px;
            }
        }
        
        /* å¿«é€Ÿé¢„æµ‹ç†ç”±tooltipæ ·å¼ */
        .quick-reason-tooltip {
            display: inline-block;
            cursor: help;
        }
        
        .quick-reason-tooltip:hover {
            color: #0d6efd !important;
        }
        
        /* é¢„æµ‹ç±»å‹åˆ—æ ·å¼ */
        .prediction-type-cell {
            min-width: 120px;
        }
        
        /* ç»Ÿè®¡é¢æ¿æ ·å¼ */
        .stats-panel .card {
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .stats-panel .card-title {
            font-size: 0.9em;
            font-weight: 600;
        }
        
        .date-navbar .d-flex {
            min-width: max-content;
        }
        
        .date-nav-item {
            display: inline-block;
            padding: 12px 20px;
            text-decoration: none;
            color: #6c757d;
            font-weight: 500;
            border-right: 1px solid #dee2e6;
            white-space: nowrap;
            transition: all 0.3s ease;
            cursor: pointer;
            background: transparent;
            border: none;
            font-size: 14px;
        }
        
        .date-nav-item:hover {
            background-color: #e9ecef;
            color: #495057;
            text-decoration: none;
        }
        
        .date-nav-item.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .date-nav-item:last-child {
            border-right: none;
        }
        
        /* æŒ‰é’®ç»„æ ·å¼ä¼˜åŒ– */
        .btn-group {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-radius: 6px;
            overflow: hidden;
        }
        
        .btn-group .btn {
            border-radius: 0;
            margin: 0;
        }
        
        .btn-group .btn:first-child {
            border-top-left-radius: 6px;
            border-bottom-left-radius: 6px;
        }
        
        .btn-group .btn:last-child {
            border-top-right-radius: 6px;
            border-bottom-right-radius: 6px;
        }
        
        /* æŒ‰é’®ç»„é—´è· */
        .btn-group + .btn-group {
            margin-left: 8px;
        }
        
        /* çŠ¶æ€æŒ‡ç¤ºå™¨æ ·å¼ */
        .status-indicator {
            background: rgba(255,255,255,0.9);
            padding: 8px 12px;
            border-radius: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .status-badge {
            white-space: normal;
            line-height: 1.4;
        }
        
        /* ç»Ÿè®¡å¡ç‰‡æ ·å¼ */
        .stats-card {
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 12px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .stats-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        .stats-content {
            text-align: center;
            color: white;
        }
        
        /* è¿›è¡Œä¸­æ¯”èµ›çš„å¼€èµ›æ—¶é—´é«˜äº®æ ·å¼ */
        .match-time-in-progress {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(255, 107, 107, 0.3);
            animation: pulse-glow 2s ease-in-out infinite;
        }
        
        @keyframes pulse-glow {
            0%, 100% {
                box-shadow: 0 2px 4px rgba(255, 107, 107, 0.3);
            }
            50% {
                box-shadow: 0 2px 8px rgba(255, 107, 107, 0.6);
            }
        }
        
        .stat-item {
            margin: 8px 0;
        }
        
        .stat-label {
            font-size: 11px;
            opacity: 0.9;
            margin-bottom: 2px;
        }
        
        .stat-value {
            font-size: 16px;
            font-weight: bold;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .btn-group {
                margin-bottom: 8px;
            }
            

            .status-indicator {
                margin-top: 10px;
                width: 100%;
                justify-content: center;
            }
        }
        
        @media (max-width: 576px) {
            .btn-group .btn {
                font-size: 0.875rem;
                padding: 0.375rem 0.75rem;
            }
        }
        
        /* æ—¥æœŸå†…å®¹åŒºåŸŸ */
        .date-content {
            display: none;
        }
        
        .date-content.active {
            display: block;
        }
  .option-badge {
    position: relative;
    padding-right: 40px;
  }
  .badge-free {
    position: absolute;
    top: 6px;
    right: 8px;
    background: #ff9800;
    color: #fff;
    font-size: 12px;
    border-radius: 8px;
    padding: 2px 6px;
    z-index: 2;
    pointer-events: none;
  }
  
  /* æ–‡ç« å·¥ä½œå°æ ·å¼ */
  .editor-control-section {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1rem;
  }
  
  .editor-main-section {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    overflow: hidden;
  }
  
  .editor-container {
    position: relative;
  }
  
  .editor-container textarea {
    width: 100%;
    height: 100%;
    border: none;
    padding: 1rem;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 14px;
    line-height: 1.5;
    resize: none;
    outline: none;
    background: #f8f9fa;
  }
  
  .preview-container {
    background: #fff;
  }
  
  .wechat-preview {
    max-width: 375px;
    margin: 0 auto;
    background: #fff;
    border: 1px solid #e5e5e5;
    border-radius: 8px;
    padding: 1rem;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'Helvetica Neue', Helvetica, Arial, sans-serif;
    font-size: 16px;
    line-height: 1.6;
    color: #333;
  }
  
  .wechat-preview h1,
  .wechat-preview h2,
  .wechat-preview h3,
  .wechat-preview h4,
  .wechat-preview h5,
  .wechat-preview h6 {
    color: #333;
    margin-top: 1.5em;
    margin-bottom: 0.5em;
    font-weight: 600;
  }
  
  .wechat-preview h1 { font-size: 1.5em; }
  .wechat-preview h2 { font-size: 1.3em; }
  .wechat-preview h3 { font-size: 1.2em; }
  
  .wechat-preview p {
    margin-bottom: 1em;
    text-align: justify;
  }
  
  .wechat-preview img {
    max-width: 100%;
    height: auto;
    border-radius: 4px;
    margin: 1em 0;
  }
  
  .wechat-preview blockquote {
    border-left: 4px solid #1aad19;
    padding-left: 1em;
    margin: 1em 0;
    color: #666;
    background: #f7f7f7;
    padding: 1em;
    border-radius: 4px;
  }
  
  .wechat-preview strong {
    font-weight: 600;
    color: #1aad19;
  }
  
  .wechat-preview code {
    background: #f1f1f1;
    padding: 2px 4px;
    border-radius: 3px;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 0.9em;
  }
  
  .wechat-preview pre {
    background: #f1f1f1;
    padding: 1em;
    border-radius: 4px;
    overflow-x: auto;
    margin: 1em 0;
  }
  
  .wechat-preview pre code {
    background: none;
    padding: 0;
  }
  
  .wechat-preview ul,
  .wechat-preview ol {
    padding-left: 1.5em;
    margin: 1em 0;
  }
  
  .wechat-preview li {
    margin-bottom: 0.5em;
  }

  .chat-options-bar {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    align-items: center;
    margin-bottom: 10px;
  }
  
  .chat-options-bar .form-switch {
    margin-bottom: 0;
  }
  
  .chat-options-bar .form-select {
    width: auto;
    min-width: 160px;
  }
  
  .editor-publish-section {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 8px;
  }
  
  /* æ–‡ä»¶å¤¹ç®¡ç†å™¨æ ·å¼ */
  .file-manager-panel {
    background: #f8f9fa;
    border-right: 1px solid #dee2e6;
  }
  
  .file-manager-header {
    background: #e9ecef;
    border-bottom: 1px solid #dee2e6;
  }
  
  .file-tree {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  
  .folder-item {
    display: flex;
    align-items: center;
    padding: 8px 12px;
    margin: 2px 0;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s ease;
    user-select: none;
  }
  
  .folder-item:hover {
    background-color: #e9ecef;
  }
  
  .folder-item.active {
    background-color: #007bff;
    color: white;
  }
  
  .folder-item.active i {
    color: white !important;
  }
  
  .folder-item i {
    margin-right: 8px;
    font-size: 16px;
  }
  
  .folder-item span {
    font-size: 14px;
    font-weight: 500;
  }
  
  .folder-name {
    cursor: pointer;
    padding: 2px 4px;
    border-radius: 3px;
    transition: background-color 0.2s;
  }
  
  .folder-name:hover {
    background-color: rgba(0, 123, 255, 0.1);
  }
  
  .folder-name.editing {
    background-color: #fff;
    border: 2px solid #007bff;
    border-radius: 3px;
  }
  
  .folder-name input {
    border: none;
    outline: none;
    background: transparent;
    font-size: inherit;
    color: inherit;
    width: 100%;
    padding: 0;
    margin: 0;
  }
  
  .empty-state {
    text-align: center;
    color: #6c757d;
    padding: 2rem;
  }
  
  .empty-state i {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
  }
  
  .empty-state h6 {
    margin-bottom: 0.5rem;
  }
  
  .empty-state p {
    margin-bottom: 0;
    font-size: 0.9rem;
  }
  
        /* AIåŠ©æ‰‹æ ·å¼ */
        .message-bubble {
          max-width: 80%;
          padding: 0.75rem 1rem;
          border-radius: 1rem;
          position: relative;
        }
        
        .user-message {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          margin-left: auto;
        }
        
        .ai-message {
          background: white;
          border: 1px solid #e9ecef;
          color: #333;
          margin-right: auto;
        }
        
        .ai-message.thinking {
          opacity: 0.7;
          animation: pulse 1.5s ease-in-out infinite;
        }
        
        .message-header {
          display: flex;
          align-items: center;
          gap: 0.5rem;
          margin-bottom: 0.5rem;
          font-size: 0.875rem;
          font-weight: 500;
        }
        
        .message-text {
          line-height: 1.5;
        }
        
        @keyframes pulse {
          0%, 100% { opacity: 0.7; }
          50% { opacity: 1; }
        }
        
        .capability-item {
          padding: 0.75rem;
          border-radius: 0.5rem;
          transition: background-color 0.2s;
        }
        
        .capability-item:hover {
          background-color: #f8f9fa;
        }

        /* é¦–é¡µèŠå¤©ç•Œé¢æ ·å¼ */
        .welcome-section {
          padding: 2rem 0;
          background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
          border-radius: 1rem;
          margin-bottom: 2rem;
        }

        .chat-container {
          max-width: 800px;
          margin: 0 auto;
          height: calc(100vh - 300px);
          display: flex;
          flex-direction: column;
        }

        .chat-messages {
          flex: 1;
          overflow-y: auto;
          padding: 1rem;
          background: #f8f9fa;
          border-radius: 0.5rem;
          margin-bottom: 1rem;
        }

        .chat-input-section {
          background: white;
          padding: 1rem;
          border-radius: 0.5rem;
          box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .ai-welcome-message {
          animation: fadeInUp 0.6s ease-out;
        }

        @keyframes fadeInUp {
          from {
            opacity: 0;
            transform: translateY(20px);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }

        .quick-actions {
          display: flex;
          flex-wrap: wrap;
          gap: 0.5rem;
          justify-content: center;
        }

        .quick-actions .btn {
          border-radius: 20px;
          font-size: 0.875rem;
  }
  
        /* è¿›åº¦é¢æ¿æ ·å¼ */
        .progress-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 400px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 9999;
            transition: all 0.3s ease;
        }
        
        .progress-panel.minimized {
            width: 200px;
        }
        
        .progress-panel.minimized .progress-body {
            display: none;
        }
        
        .progress-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .progress-header h5 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
        }
        
        .btn-close-panel {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .btn-close-panel:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .progress-body {
            padding: 20px;
        }
        
        .progress-info {
            margin-bottom: 15px;
        }
        
        .progress-step, .progress-matches, .progress-eta {
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .progress-step {
            font-weight: 600;
            color: #667eea;
        }
        
        .progress-matches {
            color: #666;
        }
        
        .progress-eta {
            color: #f39c12;
            font-weight: 500;
        }
        
        .progress-eta i {
            margin-right: 5px;
        }
        
        .progress-bar-container {
            margin-top: 10px;
  }

        .prompt-list {
            max-height: 520px;
            overflow-y: auto;
        }
        .prompt-list .list-group-item-action {
            cursor: pointer;
        }
        .prompt-category-header {
            cursor: default;
  }
</style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="bi bi-robot"></i>
                å¾®ä¿¡å…¬ä¼—å·AIè‡ªåŠ¨å‘å¸ƒç³»ç»Ÿ
            </a>
            <span class="navbar-text">
                <i class="bi bi-clock"></i>
                <span id="current-time" data-current-time="true">--:--:--</span>
            </span>
            <div class="ms-auto d-flex align-items-center">
                <a href="https://github.com/wojiadexiaoming-copy-copy/AIWeChatauto" target="_blank" class="btn btn-outline-dark btn-sm ms-2" style="display:flex;align-items:center;gap:4px;">
                    <i class="bi bi-github"></i> å¼€æºé¡¹ç›®
                    <span id="github-star-count" style="margin-left:6px;"><i class="bi bi-star"></i> <span id="star-num">--</span></span>
                </a>
                <button id="check-update-btn" class="btn btn-outline-info btn-sm ms-2" style="display:flex;align-items:center;gap:4px;" title="æ£€æŸ¥å¹¶è‡ªåŠ¨æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬">
                    <i class="bi bi-arrow-repeat"></i> æ£€æŸ¥æ›´æ–°
                </button>
            </div>
        </div>
    </nav>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <div class="container-fluid">
        <!-- æ±‰å ¡èœå•æŒ‰é’®ï¼ˆç§»åŠ¨ç«¯ï¼‰ -->
        <button class="mobile-menu-toggle" id="mobile-menu-toggle">
            <i class="bi bi-list"></i>
        </button>
        
        <!-- ä¾§è¾¹æ é®ç½©å±‚ï¼ˆç§»åŠ¨ç«¯ï¼‰ -->
        <div class="sidebar-overlay" id="sidebar-overlay"></div>
        
        <div class="main-layout">
            <!-- ä¾§è¾¹æ  -->
            <div class="sidebar">
                <div class="sidebar-header">
                    <i class="bi bi-robot"></i>
                    <h5>AIåŠ©æ‰‹</h5>
                </div>
                
                <!-- ä¾§è¾¹æ å¯¼èˆª -->
                <nav class="sidebar-nav">
                    <div class="nav-section">
                        <h6 class="nav-section-title">æ ¸å¿ƒåŠŸèƒ½</h6>
                        <a href="#ai-home" class="nav-item active" data-target="ai-home-panel">
                        <i class="bi bi-house"></i>
                            <span>AIåŠ©æ‰‹é¦–é¡µ</span>
                        </a>
                        <a href="#config" class="nav-item" data-target="config-panel">
                        <i class="bi bi-gear"></i>
                            <span>é…ç½®ç®¡ç†</span>
                        </a>
                        <a href="#editor" class="nav-item" data-target="editor-panel">
                            <i class="bi bi-pencil-square"></i>
                            <span>æ–‡ç« å·¥ä½œå°</span>
                        </a>
                        <a href="#sporttery" class="nav-item" data-target="sporttery-panel">
                            <i class="bi bi-trophy"></i>
                            <span>ç«å½©æ•°æ®</span>
                        </a>
                        <a href="#scheduler" class="nav-item" data-target="scheduler-panel">
                            <i class="bi bi-clock-history"></i>
                            <span>å®šæ—¶ä»»åŠ¡</span>
                        </a>
                    </div>
                    
                    <div class="nav-section">
                        <h6 class="nav-section-title">é«˜çº§åŠŸèƒ½</h6>
                        <a href="#prompt" class="nav-item" data-target="prompt-panel">
                            <i class="bi bi-code-slash"></i>
                            <span>æç¤ºè¯ç®¡ç†</span>
                        </a>
                        <a href="#features" class="nav-item" data-target="features-panel">
                            <i class="bi bi-ui-checks"></i>
                            <span>åŠŸèƒ½æ¸…å•</span>
                        </a>
                        <a href="#runtime-logs" class="nav-item" data-target="runtime-logs-panel">
                            <i class="bi bi-journal-text"></i>
                            <span>è¿è¡Œæ—¥å¿—</span>
                        </a>
                    </div>
                    
                    <div class="nav-section">
                        <h6 class="nav-section-title">ç³»ç»Ÿä¿¡æ¯</h6>
                        <div class="nav-info">
                            <i class="bi bi-clock"></i>
                            <span data-current-time="true">--:--:--</span>
                        </div>
                        <div class="nav-info">
                            <i class="bi bi-globe"></i>
                            <span id="user-ip">è·å–ä¸­...</span>
                        </div>
                    </div>
                </nav>
            </div>
            
            <!-- ä¸»å†…å®¹åŒº -->
        <div class="main-content">
                <!-- AIåŠ©æ‰‹é¦–é¡µèŠå¤©é¢æ¿ -->
                <div class="content-panel active" id="ai-home-panel">
                    <div class="panel-header text-center">
                        <div class="welcome-section">
                            <i class="bi bi-robot fs-1 text-primary mb-3"></i>
                            <h1 class="display-4 fw-bold text-primary">Helloï¼Œè€kï¼</h1>
                            <p class="lead text-muted">æˆ‘æ˜¯æ‚¨çš„AIåŠ©ç†ï¼Œéšæ—¶ä¸ºæ‚¨æœåŠ¡</p>
                        </div>
                    </div>
                    
                    <!-- èŠå¤©ç•Œé¢ -->
                    <div class="chat-container">
                        <div class="chat-options-bar">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="home-chat-websearch">
                                <label class="form-check-label text-muted small" for="home-chat-websearch">
                                    å¯ç”¨æ™ºè°±è”ç½‘æœç´¢
                                </label>
                            </div>
                            <div class="d-flex align-items-center gap-2">
                                <label for="home-chat-engine" class="form-label mb-0 text-muted small">æœç´¢å¼•æ“</label>
                                <select class="form-select form-select-sm" id="home-chat-engine">
                                    <option value="search_std">search_stdï¼ˆåŸºç¡€ï¼‰</option>
                                    <option value="search_pro">search_proï¼ˆé«˜çº§ï¼‰</option>
                                    <option value="search_pro_sogou">search_pro_sogou</option>
                                    <option value="search_pro_quark">search_pro_quark</option>
                                </select>
                            </div>
                        </div>
                        <div id="home-chat-messages" class="chat-messages">
                            <div class="ai-welcome-message">
                                <div class="message-bubble ai-message">
                                    <div class="message-header">
                                        <i class="bi bi-robot text-primary"></i>
                                        <span>AIåŠ©ç†</span>
                                        <small class="text-muted">åˆšåˆš</small>
                                    </div>
                                    <div class="message-text">
                                        æ‚¨å¥½ï¼Œè€kï¼æˆ‘æ˜¯æ‚¨çš„AIåŠ©ç†ï¼Œå¯ä»¥å¸®åŠ©æ‚¨ï¼š<br>
                                        â€¢ ğŸ“Š æŸ¥çœ‹ç³»ç»ŸçŠ¶æ€å’Œæ•°æ®æœé›†æƒ…å†µ<br>
                                        â€¢ âœï¸ ç”Ÿæˆå’Œå®¡æ ¸æ–‡ç« <br>
                                        â€¢ âš™ï¸ ç®¡ç†é…ç½®å’Œè®¾ç½®<br>
                                        â€¢ ğŸ” ç›‘æ§ç«å½©æ•°æ®å’Œèµ›ç¨‹<br><br>
                                        è¯·ç›´æ¥å‘Šè¯‰æˆ‘æ‚¨éœ€è¦ä»€ä¹ˆå¸®åŠ©ï¼
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="chat-input-section">
                            <div class="input-group">
                                <input type="text" class="form-control form-control-lg" id="home-chat-input" 
                                       placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜æˆ–æŒ‡ä»¤..." onkeypress="handleHomeChatEnter(event)">
                                <button class="btn btn-primary btn-lg" onclick="sendHomeMessage()">
                                    <i class="bi bi-send"></i>
                                </button>
                            </div>
                            <div class="quick-actions mt-3">
                                <button class="btn btn-outline-primary btn-sm me-2" onclick="quickHomeAction('check-status')">
                                    <i class="bi bi-eye"></i> æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
                                </button>
                                <button class="btn btn-outline-success btn-sm me-2" onclick="quickHomeAction('generate-article')">
                                    <i class="bi bi-magic"></i> ç”Ÿæˆæ–°æ–‡ç« 
                                </button>
                                <button class="btn btn-outline-warning btn-sm me-2" onclick="quickHomeAction('review-articles')">
                                    <i class="bi bi-check-circle"></i> å®¡æ ¸æ–‡ç« 
                                </button>
                                <button class="btn btn-outline-info btn-sm" onclick="quickHomeAction('trigger-collection')">
                                    <i class="bi bi-arrow-clockwise"></i> è§¦å‘æ•°æ®æœé›†
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- é…ç½®ç®¡ç†é¢æ¿ -->
                <div class="content-panel" id="config-panel">
                    <div class="panel-header">
                        <i class="bi bi-gear"></i>
                        <h4>é…ç½®ç®¡ç†</h4>
                        <p>é…ç½®å¾®ä¿¡å…¬ä¼—å·å’ŒAIæ¨¡å‹å‚æ•°</p>
                    </div>
                    
                    <!-- å¾®ä¿¡é…ç½® -->
                    <div class="config-section">
                        <h6><i class="bi bi-wechat"></i> å¾®ä¿¡å…¬ä¼—å·é…ç½®</h6>
                        <div class="mb-3">
                            <label for="wechat-appid" class="form-label">AppID</label>
                            <input type="text" class="form-control" id="wechat-appid" placeholder="è¯·è¾“å…¥å¾®ä¿¡å…¬ä¼—å·AppID">
                            <div class="form-text">ä»¥wxå¼€å¤´çš„18ä½å­—ç¬¦ä¸²</div>
                        </div>
                        <div class="mb-3">
                            <label for="wechat-appsecret" class="form-label">AppSecret</label>
                            <input type="password" class="form-control" id="wechat-appsecret" placeholder="è¯·è¾“å…¥å¾®ä¿¡å…¬ä¼—å·AppSecret">
                            <div class="form-text">è¯·å¦¥å–„ä¿ç®¡ï¼Œä¸è¦æ³„éœ²</div>
                        </div>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-outline-primary btn-sm" id="test-wechat">
                                <i class="bi bi-plug"></i> æµ‹è¯•è¿æ¥
                            </button>
                            <span class="badge bg-secondary" id="wechat-status">æœªé…ç½®</span>
                        </div>
                    </div>
                    
                    <!-- Geminié…ç½® -->
                    <div class="config-section">
                        <h6><i class="bi bi-lightning"></i> Gemini AIé…ç½®</h6>
                        <div class="mb-3">
                            <label for="gemini-api-key" class="form-label">APIå¯†é’¥</label>
                            <input type="password" class="form-control" id="gemini-api-key" placeholder="è¯·è¾“å…¥Gemini APIå¯†é’¥">
                            <div class="form-text">ä»¥AIzaå¼€å¤´çš„APIå¯†é’¥</div>
                        </div>
                        <div class="mb-3">
                            <label for="gemini-model" class="form-label">æ¨¡å‹é€‰æ‹©</label>
                            <div class="d-flex gap-2 mb-2">
                            <select class="form-select" id="gemini-model">
                                <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                                <option value="gemini-2.5-pro">Gemini 2.5 Pro</option>
                            </select>
                                <button type="button" class="btn btn-outline-secondary btn-sm" id="load-gemini-models">
                                    <i class="bi bi-arrow-clockwise"></i> åˆ·æ–°æ¨¡å‹
                                </button>
                            </div>
                            <div class="form-text">é¡¹ç›®å¯åŠ¨æ—¶è‡ªåŠ¨åŠ è½½ä¸€æ¬¡æ¨¡å‹åˆ—è¡¨ï¼Œå¦‚éœ€æ›´æ–°è¯·æ‰‹åŠ¨ç‚¹å‡»"åˆ·æ–°æ¨¡å‹"æŒ‰é’®</div>
                        </div>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-outline-primary btn-sm" id="test-gemini">
                                <i class="bi bi-plug"></i> æµ‹è¯•è¿æ¥
                            </button>
                            <span class="badge bg-secondary" id="gemini-status">æœªé…ç½®</span>
                        </div>
                    </div>
                    
                    <!-- DeepSeeké…ç½® -->
                    <div class="config-section">
                        <h6><i class="bi bi-cpu"></i> DeepSeek AIé…ç½®</h6>
                        <div class="mb-3">
                            <label for="deepseek-api-key" class="form-label">APIå¯†é’¥</label>
                            <input type="password" class="form-control" id="deepseek-api-key" placeholder="è¯·è¾“å…¥DeepSeek APIå¯†é’¥">
                            <div class="form-text">DeepSeek APIå¯†é’¥</div>
                        </div>
                        <div class="mb-3">
                            <label for="deepseek-model" class="form-label">æ¨¡å‹é€‰æ‹©</label>
                            <div class="d-flex gap-2 mb-2">
                                <select class="form-select" id="deepseek-model">
                                    <option value="deepseek-chat">DeepSeek Chat</option>
                                    <option value="deepseek-coder">DeepSeek Coder</option>
                                    <option value="deepseek-chat-instruct">DeepSeek Chat Instruct</option>
                                    <option value="deepseek-reasoner">DeepSeek Reasoner</option>
                                </select>
                                <button type="button" class="btn btn-outline-secondary btn-sm" id="load-deepseek-models">
                                    <i class="bi bi-arrow-clockwise"></i> åˆ·æ–°æ¨¡å‹
                                </button>
                            </div>
                            <div class="form-text">é¡¹ç›®å¯åŠ¨æ—¶è‡ªåŠ¨åŠ è½½ä¸€æ¬¡æ¨¡å‹åˆ—è¡¨ï¼Œå¦‚éœ€æ›´æ–°è¯·æ‰‹åŠ¨ç‚¹å‡»"åˆ·æ–°æ¨¡å‹"æŒ‰é’®</div>
                        </div>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-outline-primary btn-sm" id="test-deepseek">
                                <i class="bi bi-plug"></i> æµ‹è¯•è¿æ¥
                            </button>
                            <span class="badge bg-secondary" id="deepseek-status">æœªé…ç½®</span>
                        </div>
                    </div>
                    
                    <!-- æ™ºè°±AIé…ç½® -->
                    <div class="config-section">
                        <h6><i class="bi bi-robot"></i> æ™ºè°±AIé…ç½®</h6>
                        <div class="mb-3">
                            <label for="zhipu-api-key" class="form-label">APIå¯†é’¥</label>
                            <input type="password" class="form-control" id="zhipu-api-key" placeholder="è¯·è¾“å…¥æ™ºè°±AI APIå¯†é’¥">
                            <div class="form-text">æ™ºè°±AI APIå¯†é’¥ï¼Œç”¨äºAIåŠ©æ‰‹åŠŸèƒ½</div>
                        </div>
                        <div class="mb-3">
                            <label for="zhipu-model" class="form-label">æ¨¡å‹é€‰æ‹©</label>
                            <div class="d-flex gap-2 mb-2">
                                <select class="form-select" id="zhipu-model">
                                    <option value="glm-4.5-air">GLM-4.5-AIRï¼ˆæ–‡æœ¬å¯¹è¯ï¼‰</option>
                                    <option value="glm-4.5v">GLM-4.5Vï¼ˆå¤šæ¨¡æ€å›¾ç‰‡è¯†åˆ«ï¼‰</option>
                                </select>
                                <button type="button" class="btn btn-outline-secondary btn-sm" id="load-zhipu-models">
                                    <i class="bi bi-arrow-clockwise"></i> åˆ·æ–°æ¨¡å‹
                                </button>
                            </div>
                            <div class="form-text">
                                <strong>æ–‡æœ¬å¯¹è¯ï¼š</strong> GLM-4.5-AIRï¼ˆé€Ÿåº¦å¿«æˆæœ¬ä½ï¼‰<br>
                                <strong>å›¾ç‰‡è¯†åˆ«ï¼š</strong> GLM-4.5Vï¼ˆæ”¯æŒå¤šæ¨¡æ€å›¾ç‰‡åˆ†æï¼‰
                            </div>
                        </div>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-outline-primary btn-sm" id="test-zhipu">
                                <i class="bi bi-plug"></i> æµ‹è¯•è¿æ¥
                            </button>
                            <span class="badge bg-secondary" id="zhipu-status">æœªé…ç½®</span>
                        </div>
                    </div>
                    
                    <!-- é˜¿é‡Œäº‘ç™¾ç‚¼é…ç½® -->
                    <div class="config-section">
                        <h6><i class="bi bi-cloud"></i> é˜¿é‡Œäº‘ç™¾ç‚¼é…ç½®</h6>
                        <div class="mb-3">
                            <label for="dashscope-api-key" class="form-label">APIå¯†é’¥</label>
                            <input type="password" class="form-control" id="dashscope-api-key" placeholder="è¯·è¾“å…¥é˜¿é‡Œäº‘ç™¾ç‚¼APIå¯†é’¥">
                            <div class="form-text">é˜¿é‡Œäº‘ç™¾ç‚¼APIå¯†é’¥</div>
                        </div>
                        <div class="mb-3">
                            <label for="dashscope-model" class="form-label">æ¨¡å‹é€‰æ‹©</label>
                            <div class="d-flex gap-2 mb-2">
                                <select class="form-select" id="dashscope-model">
                                    <option value="qwen-turbo">é€šä¹‰åƒé—®-Turbo</option>
                                    <option value="qwen-plus">é€šä¹‰åƒé—®-Plus</option>
                                    <option value="qwen-max">é€šä¹‰åƒé—®-Max</option>
                                    <option value="qwen-omni-turbo">é€šä¹‰åƒé—®-Omni-Turbo</option>
                                </select>
                                <button type="button" class="btn btn-outline-secondary btn-sm" id="load-dashscope-models">
                                    <i class="bi bi-arrow-clockwise"></i> åˆ·æ–°æ¨¡å‹
                                </button>
                            </div>
                            <div class="form-text">é¡¹ç›®å¯åŠ¨æ—¶è‡ªåŠ¨åŠ è½½ä¸€æ¬¡æ¨¡å‹åˆ—è¡¨ï¼Œå¦‚éœ€æ›´æ–°è¯·æ‰‹åŠ¨ç‚¹å‡»"åˆ·æ–°æ¨¡å‹"æŒ‰é’®</div>
                        </div>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-outline-primary btn-sm" id="test-dashscope">
                                <i class="bi bi-plug"></i> æµ‹è¯•è¿æ¥
                            </button>
                            <span class="badge bg-secondary" id="dashscope-status">æœªé…ç½®</span>
                        </div>
                    </div>
                    
                    <!-- Pexelsé…ç½®ï¼šå·²ç§»é™¤æ˜¾ç¤º -->
                    <!-- Cozeé…ç½®ï¼šå·²ç§»é™¤æ˜¾ç¤º -->
                    
                    <!-- ä½œè€…é…ç½® -->
                    <div class="config-section">
                        <h6><i class="bi bi-person"></i> ä½œè€…ä¿¡æ¯</h6>
                        <div class="mb-3">
                            <label for="author-name" class="form-label">ä½œè€…åç§°</label>
                            <input type="text" class="form-control" id="author-name" placeholder="è¯·è¾“å…¥ä½œè€…åç§°" value="AIç¬”è®°">
                        </div>
                        <div class="mb-3">
                            <label for="content-source-url" class="form-label">åŸæ–‡é“¾æ¥</label>
                            <input type="url" class="form-control" id="content-source-url" placeholder="å¯é€‰ï¼ŒåŸæ–‡é“¾æ¥åœ°å€">
                        </div>
                    </div>
                    
                    <!-- ä¿å­˜é…ç½® -->
                    <div class="d-grid">
                        <button type="button" class="btn btn-primary" id="save-config">
                            <i class="bi bi-save"></i> ä¿å­˜é…ç½®
                        </button>
                    </div>
                </div>
                
                <!-- æ–‡ç« å·¥ä½œå°é¢æ¿ -->
                <div class="content-panel" id="editor-panel">
                    <div class="panel-header">
                        <i class="bi bi-pencil-square"></i>
                        <h4>æ–‡ç« å·¥ä½œå°</h4>
                        <p>Markdownç¼–è¾‘å™¨ + å¾®ä¿¡å…¬ä¼—å·å®æ—¶é¢„è§ˆ</p>
                    </div>
                    
                    <!-- ç”Ÿæˆæ§åˆ¶é¢æ¿ -->
                    <div class="editor-control-section">
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <label for="ai-model-select" class="form-label">AIæ¨¡å‹</label>
                                <select class="form-select form-select-sm" id="ai-model-select">
                                <option value="gemini">Google Gemini</option>
                                <option value="deepseek">DeepSeek AI</option>
                                <option value="dashscope">é˜¿é‡Œäº‘ç™¾ç‚¼</option>
                            </select>
                        </div>
                            <div class="col-md-3">
                                <label for="article-word-count" class="form-label">æ–‡ç« å­—æ•°</label>
                                <input type="number" class="form-control form-control-sm" id="article-word-count" min="100" max="20000" value="8000">
                            </div>
                            <div class="col-md-3">
                                <label for="article-image-count" class="form-label">é…å›¾æ•°é‡</label>
                                <input type="number" class="form-control form-control-sm" id="article-image-count" min="1" max="20" value="3">
                            </div>
                            <div class="col-md-3 d-flex align-items-end">
                                <button type="button" class="btn btn-success btn-sm w-100" id="generate-article">
                                <i class="bi bi-magic"></i> ç”Ÿæˆæ–‡ç« 
                                        </button>
                                    </div>
                                </div>
                    
                    <!-- ç”Ÿæˆè¿›åº¦ -->
                        <div id="generation-progress" style="display: none;">
                            <div class="progress mb-2">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" style="width: 0%" id="progress-bar"></div>
                            </div>
                            <small class="text-muted" id="progress-text">å‡†å¤‡ä¸­...</small>
                                    </div>
                                    </div>
                    
                    <!-- ç¼–è¾‘å™¨ä¸»ä½“ -->
                    <div class="editor-main-section">
                        <div class="row g-0" style="height: 600px;">
                            <!-- å·¦ä¾§ï¼šæ–‡ä»¶å¤¹è§†å›¾ -->
                            <div class="col-md-2">
                                <div class="file-manager-panel h-100 border-end">
                                    <div class="file-manager-header d-flex justify-content-between align-items-center p-2 border-bottom">
                                        <h6 class="mb-0"><i class="bi bi-folder"></i> æ–‡ä»¶å¤¹</h6>
                                        <button class="btn btn-sm btn-outline-primary" id="new-folder-btn" title="æ–°å»ºæ–‡ä»¶å¤¹">
                                            <i class="bi bi-plus"></i>
                                        </button>
                                    </div>
                                    <div class="file-manager-body" style="height: calc(100% - 50px); overflow-y: auto; padding: 8px;">
                                        <div class="file-tree" id="file-tree">
                                            <div class="folder-item active" data-folder="default">
                                                <i class="bi bi-folder-fill text-primary"></i>
                                                <span class="folder-name" data-editable="true">é»˜è®¤æ–‡ä»¶å¤¹</span>
                                    </div>
                                            <div class="folder-item" data-folder="laok-nankantai">
                                                <i class="bi bi-folder-fill text-warning"></i>
                                                <span class="folder-name" data-editable="true">è€kå—çœ‹å°</span>
                                            </div>
                                            <div class="folder-item" data-folder="laok-pinglunxi">
                                                <i class="bi bi-folder-fill text-success"></i>
                                                <span class="folder-name" data-editable="true">è€kè¯„è®ºå¸­</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ä¸­é—´ï¼šMarkdownç¼–è¾‘å™¨ -->
                            <div class="col-md-5">
                                <div class="editor-header d-flex justify-content-between align-items-center p-2 border-bottom">
                                    <h6 class="mb-0"><i class="bi bi-code-slash"></i> Markdownç¼–è¾‘å™¨</h6>
                                </div>
                                <div class="editor-container" style="height: 550px;">
                                    <textarea id="markdown-editor" placeholder="åœ¨è¿™é‡Œè¾“å…¥Markdownå†…å®¹ï¼Œå³ä¾§å°†å®æ—¶é¢„è§ˆå¾®ä¿¡å…¬ä¼—å·æ•ˆæœ..." style="height: 550px; resize: none; width: 100%;"></textarea>
                                </div>
                            </div>
                
                            <!-- å³ä¾§ï¼šå¾®ä¿¡å…¬ä¼—å·é¢„è§ˆ -->
                            <div class="col-md-5">
                                <div class="preview-header d-flex justify-content-between align-items-center p-2 border-bottom">
                                    <h6 class="mb-0"><i class="bi bi-phone"></i> å¾®ä¿¡å…¬ä¼—å·é¢„è§ˆ</h6>
                        </div>
                                <div class="preview-container" style="height: 550px; overflow-y: auto;">
                                    <div class="wechat-preview" id="wechat-preview">
                            <div class="empty-state">
                                <i class="bi bi-file-earmark"></i>
                                <h6>æš‚æ— é¢„è§ˆå†…å®¹</h6>
                                            <p>åœ¨å·¦ä¾§ç¼–è¾‘å™¨ä¸­è¾“å…¥å†…å®¹ï¼Œè¿™é‡Œå°†æ˜¾ç¤ºå¾®ä¿¡å…¬ä¼—å·æ•ˆæœ</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- å‘å¸ƒæ“ä½œ -->
                    <div class="editor-publish-section mt-3">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="enable-mass-send">
                            <label class="form-check-label" for="enable-mass-send">
                                <i class="bi bi-broadcast"></i> åŒæ—¶ç¾¤å‘ç»™æ‰€æœ‰ç²‰ä¸
                                <i class="bi bi-exclamation-triangle text-warning ms-1" 
                                   data-bs-toggle="tooltip" 
                                   data-bs-placement="top" 
                                   title="éœ€è¦å¾®ä¿¡è®¤è¯å¼€é€šç¾¤å‘æ¥å£æ‰å¯ä»¥ä½¿ç”¨æ­¤åŠŸèƒ½"></i>
                            </label>
                        </div>
                            </div>
                            <div class="col-md-4">
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-warning" id="publish-article" disabled>
                                <i class="bi bi-cloud-upload"></i> å‘å¸ƒåˆ°å¾®ä¿¡
                            </button>
                            <button type="button" class="btn btn-outline-secondary" id="save-draft" disabled>
                                <i class="bi bi-save"></i> ä¿å­˜è‰ç¨¿
                            </button>
                                </div>
                        </div>
                    </div>
                    
                    <!-- å‘å¸ƒçŠ¶æ€ -->
                        <div id="publish-status" style="display: none;" class="mt-3">
                        <div class="alert alert-info" role="alert">
                            <div class="d-flex align-items-center">
                                <div class="loading-spinner me-2"></div>
                                <span id="publish-message">æ­£åœ¨å‘å¸ƒ...</span>
                                </div>
                            </div>
                            </div>
                        </div>
                    </div>
                    
                <!-- ç«å½©æ•°æ®é¢æ¿ -->
                <div class="content-panel" id="sporttery-panel">
                    <div class="panel-header">
                        <i class="bi bi-trophy"></i>
                        <h4>ç«å½©æ•°æ®</h4>
                        <p>ä¸­å›½ç«å½©å®˜ç½‘èµ›ç¨‹æ•°æ®å®æ—¶æŠ“å–ä¸å±•ç¤º</p>
                            </div>
                    
                    <!-- æ•°æ®æ§åˆ¶é¢æ¿ -->
                    <div class="sporttery-control-section">
                        <!-- æ•°æ®ç®¡ç†åŒºåŸŸ -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <div class="d-flex flex-wrap gap-2 align-items-center">
                                    <!-- æ•°æ®æ“ä½œæŒ‰é’®ç»„ -->
                                    <div class="d-flex gap-2">
                                <button type="button" class="btn btn-primary" id="refresh-sporttery-data">
                                            <i class="bi bi-arrow-clockwise"></i> èµ›ç¨‹æ›´æ–°
                                </button>
                                        <button type="button" class="btn btn-outline-info" id="view-results">
                                            <i class="bi bi-trophy-fill"></i> èµ›æœæ›´æ–°
                                </button>
                                        <button type="button" class="btn btn-outline-secondary" id="refresh-display-data">
                                            <i class="bi bi-arrow-repeat"></i> åˆ·æ–°
                                </button>
                            </div>
                                    
                                    <!-- å¿«é€Ÿé¢„æµ‹æŒ‰é’® -->
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-warning" id="quick-prediction">
                                            <i class="bi bi-lightning"></i> å¿«é€Ÿé¢„æµ‹
                                        </button>
                                    </div>
                                    
                                    <!-- æ·±åº¦åˆ†ææŒ‰é’® -->
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-success" id="deep-analysis">
                                            <i class="bi bi-cpu"></i> æ·±åº¦åˆ†æ
                                        </button>
                            </div>
                                    
                                    <!-- ç»Ÿè®¡å¡ç‰‡ -->
                                    <div class="stats-card" id="accuracy-stats-card" role="button">
                                        <div class="stats-content">
                                            <div class="stat-item">
                                                <div class="stat-label">å¿«é€Ÿé¢„æµ‹</div>
                                                <div class="stat-value" id="quick-accuracy">--%</div>
                                            </div>
                                            <div class="stat-item">
                                                <div class="stat-label">æ·±åº¦åˆ†æ</div>
                                                <div class="stat-value" id="deep-accuracy">--%</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- ç³»ç»Ÿç®¡ç†æŒ‰é’® -->
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-danger" id="run-all-workflow">
                                            <i class="bi bi-lightning"></i> ä¸€é”®è§¦å‘
                                        </button>
                                    </div>
                                    
                                    <!-- çŠ¶æ€æŒ‡ç¤ºå™¨ -->
                                    <div class="status-indicator d-flex flex-column flex-md-row align-items-start align-items-md-center ms-auto me-3 gap-2" style="min-width: 260px; max-width: 420px;">
                                        <span class="badge status-badge bg-success w-100 text-start" id="sporttery-status">æ•°æ®å·²åŠ è½½</span>
                                        <small class="text-muted text-nowrap" id="sporttery-last-update">æœ€åæ›´æ–°: --</small>
                                        <!-- ä¸­æ–­ä»»åŠ¡æŒ‰é’® -->
                                        <button type="button" class="btn btn-danger btn-sm ms-md-auto flex-shrink-0" id="interrupt-task-btn" style="display: none; white-space: nowrap;" title="ä¸­æ–­å½“å‰ä»»åŠ¡">
                                            <i class="bi bi-stop-circle"></i> ä¸­æ–­ä»»åŠ¡
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- æ–°å¢ï¼šç»Ÿè®¡é¢æ¿ -->
                        <div class="row mb-3" id="stats-panel" style="display: none;">
                            <div class="col-md-6">
                                <div class="card border-primary">
                                    <div class="card-body p-2">
                                        <h6 class="card-title mb-1 text-primary">
                                            <i class="bi bi-graph-up"></i> å¿«é€Ÿé¢„æµ‹ç»Ÿè®¡
                                        </h6>
                                        <div class="row text-center">
                                            <div class="col-4">
                                                <div class="fw-bold" id="quick-total">0</div>
                                                <small class="text-muted">æ€»é¢„æµ‹</small>
                                            </div>
                                            <div class="col-4">
                                                <div class="fw-bold text-success" id="quick-hits">0</div>
                                                <small class="text-muted">å‘½ä¸­</small>
                                            </div>
                                            <div class="col-4">
                                                <div class="fw-bold text-primary" id="quick-rate">0%</div>
                                                <small class="text-muted">å‘½ä¸­ç‡</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card border-warning">
                                    <div class="card-body p-2">
                                        <h6 class="card-title mb-1 text-warning">
                                            <i class="bi bi-target"></i> æ·±åº¦åˆ†æç»Ÿè®¡
                                        </h6>
                                        <div class="row text-center">
                                            <div class="col-4">
                                                <div class="fw-bold" id="deep-total">0</div>
                                                <small class="text-muted">æ€»åˆ†æ</small>
                                            </div>
                                            <div class="col-4">
                                                <div class="fw-bold text-success" id="deep-hits">0</div>
                                                <small class="text-muted">å‘½ä¸­</small>
                                            </div>
                                            <div class="col-4">
                                                <div class="fw-bold text-warning" id="deep-rate">0%</div>
                                                <small class="text-muted">å‘½ä¸­ç‡</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- æ•°æ®å±•ç¤ºåŒºåŸŸ -->
                    <div class="sporttery-data-section">
                        <div class="row">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">
                                            <i class="bi bi-calendar-event"></i> ç«å½©èµ›ç¨‹
                                        </h6>
                                    </div>
                                    
                                    <!-- æ—¥æœŸåˆ†ç»„èœå•æ  -->
                                    <div id="date-navbar" class="border-bottom" style="display: none;">
                                        <div class="d-flex overflow-auto">
                                            <!-- æ—¥æœŸæ ‡ç­¾å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <!-- åŠ è½½çŠ¶æ€ -->
                                        <div id="sporttery-loading" class="text-center py-4" style="display: none;">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">åŠ è½½ä¸­...</span>
                                                        </div>
                                            <p class="mt-2 text-muted">æ­£åœ¨è·å–ç«å½©æ•°æ®...</p>
                                                        </div>
                                        
                                        <!-- èµ›ç¨‹æ•°æ®è¡¨æ ¼ -->
                                        <div id="sporttery-matches-content">
                                            <div class="table-responsive">
                                                <table class="table table-hover" id="sporttery-matches-table">
                                                    <thead class="table-light">
                                                        <tr>
                                                            <th>æ¯”èµ›ç¼–å·</th>
                                                            <th>è”èµ›</th>
                                                            <th>å¯¹é˜µ</th>
                                                   <th>å¼€èµ›æ—¶é—´</th>
                                                   <th>é¢„æµ‹ç»“æœ</th>
                                                   <th>å®é™…æ¯”åˆ†</th>
                                                   <th>é¢„æµ‹ç±»å‹</th>
                                                            <th>æ“ä½œ</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="sporttery-matches-tbody">
                                                        <tr>
                                                            <td colspan="8" class="text-center text-muted py-4">
                                                                <i class="bi bi-info-circle"></i> ç‚¹å‡»"åˆ·æ–°æ•°æ®"è·å–æœ€æ–°èµ›ç¨‹
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                        
                                        <!-- èµ›æœæ•°æ®è¡¨æ ¼ -->
                                        <div id="sporttery-results-content" style="display: none;">
                                            <!-- èµ›æœæ—¥æœŸå¯¼èˆªæ  -->
                                            <div id="results-date-navbar" class="border-bottom" style="display: none;">
                                                <div class="d-flex overflow-auto">
                                                    <!-- æ—¥æœŸæ ‡ç­¾å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                                                </div>
                                            </div>
                                            <div class="table-responsive">
                                                <table class="table table-hover" id="sporttery-results-table">
                                                    <thead class="table-light">
                                                        <tr>
                                                            <th>æ¯”èµ›ç¼–å·</th>
                                                            <th>è”èµ›</th>
                                                            <th>å¯¹é˜µ</th>
                                                            <th>é¢„æµ‹æ¯”åˆ†</th>
                                                            <th>å®é™…æ¯”åˆ†</th>
                                                            <th>å‘½ä¸­çŠ¶æ€</th>
                                                            <th>æ¯”èµ›æ—¶é—´</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="sporttery-results-tbody">
                                                        <tr>
                                                            <td colspan="7" class="text-center text-muted py-4">
                                                                <i class="bi bi-info-circle"></i> ç‚¹å‡»"æŸ¥çœ‹èµ›æœ"è·å–æœ€æ–°èµ›æœ
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å®šæ—¶ä»»åŠ¡é…ç½®é¢æ¿ -->
                <div class="content-panel" id="scheduler-panel">
                    <div class="panel-header">
                        <i class="bi bi-clock-history"></i>
                        <h4>å®šæ—¶ä»»åŠ¡</h4>
                        <p>é…ç½®èµ›ç¨‹æŠ“å–ã€èµ›æœæŠ“å–ç­‰è‡ªåŠ¨åŒ–æµç¨‹çš„è§¦å‘æ—¶é—´</p>
                    </div>

                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
                                <div>
                                    <h6 class="mb-1">ä»»åŠ¡è°ƒåº¦</h6>
                                    <p class="scheduler-hint mb-0">æ¯è¡Œå¯¹åº”ä¸€ä¸ªä»»åŠ¡ï¼›è¾“å…¥æ‰§è¡Œæ—¶é—´ï¼ˆ24å°æ—¶åˆ¶ï¼‰ï¼Œé€‰æ‹©å‘¨æœŸåä¿å­˜å³å¯ã€‚</p>
                                </div>
                                <div class="d-flex flex-wrap align-items-center gap-2">
                                    <span class="badge bg-secondary" id="scheduler-running-status">çŠ¶æ€æœªçŸ¥</span>
                                    <button type="button" class="btn btn-outline-success btn-sm" id="scheduler-start-btn">
                                        <i class="bi bi-play-circle"></i> å¯åŠ¨
                                    </button>
                                    <button type="button" class="btn btn-outline-danger btn-sm" id="scheduler-stop-btn">
                                        <i class="bi bi-stop-circle"></i> åœæ­¢
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" id="scheduler-refresh-btn">
                                        <i class="bi bi-arrow-repeat"></i> é‡æ–°åŠ è½½
                                    </button>
                                    <button type="button" class="btn btn-primary btn-sm" id="scheduler-save-btn">
                                        <i class="bi bi-save"></i> ä¿å­˜é…ç½®
                                    </button>
                                </div>
                            </div>

                            <div class="table-responsive">
                                <table class="table align-middle scheduler-config-table">
                                    <thead class="table-light">
                                        <tr>
                                            <th style="min-width: 180px;">ä»»åŠ¡</th>
                                            <th style="width: 90px;">å¯ç”¨</th>
                                            <th style="width: 120px;">å‘¨æœŸ</th>
                                            <th style="min-width: 180px;">æ‰§è¡Œæ—¶é—´</th>
                                            <th style="min-width: 160px;">å‘¨å‡ ï¼ˆæŒ‰å‘¨æ—¶å¯é€‰ï¼‰</th>
                                        </tr>
                                    </thead>
                                    <tbody id="scheduler-config-tbody">
                                        <tr>
                                            <td colspan="5" class="text-center text-muted py-4">
                                                <i class="bi bi-hourglass-split"></i> æ­£åœ¨åŠ è½½é…ç½®...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <div class="alert alert-info mt-3 mb-0">
                                <i class="bi bi-info-circle"></i>
                                <span class="ms-2">ç›®å‰ä¼˜å…ˆä¿éšœ"èµ›ç¨‹æŠ“å–ã€èµ›æœæŠ“å–"èƒ½å¤ŸæŒ‰è®¡åˆ’æ‰§è¡Œï¼Œå…¶å®ƒä»»åŠ¡å·²ä¿ç•™é…ç½®å…¥å£ï¼Œåç»­å¯è¡¥å…¨åŠŸèƒ½ã€‚</span>
                            </div>
                        </div>
                    </div>
                </div>
                    
                <!-- æç¤ºè¯ç®¡ç†é¢æ¿ -->
                <div class="content-panel" id="prompt-panel">
                    <div class="panel-header">
                        <i class="bi bi-code-slash"></i>
                        <h4>æç¤ºè¯ç®¡ç†</h4>
                        <p>ç®¡ç†å’Œç¼–è¾‘AIç”Ÿæˆæ–‡ç« æ—¶ä½¿ç”¨çš„æç¤ºè¯æ¨¡æ¿</p>
                    </div>
                    
                    <div class="prompt-section">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="card h-100 shadow-sm">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <span class="fw-semibold"><i class="bi bi-collection me-1"></i>æç¤ºè¯æ¨¡æ¿</span>
                                        <button type="button" class="btn btn-sm btn-outline-secondary" id="prompt-refresh-btn" title="åˆ·æ–°æ¨¡æ¿">
                                            <i class="bi bi-arrow-clockwise"></i>
                                        </button>
                            </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label for="prompt-category-select" class="form-label text-muted small mb-1">é€‰æ‹©åˆ†ç±»</label>
                                            <select class="form-select form-select-sm" id="prompt-category-select" aria-label="æç¤ºè¯åˆ†ç±»é€‰æ‹©" disabled>
                                                <option value="">åŠ è½½ä¸­...</option>
                                </select>
                            </div>
                                        <div class="mb-3">
                                            <label for="prompt-template-select" class="form-label text-muted small mb-1">é€‰æ‹©æç¤ºè¯æ¨¡æ¿</label>
                                            <select class="form-select" id="prompt-template-select" aria-label="æç¤ºè¯æ¨¡æ¿é€‰æ‹©" disabled>
                                                <option value="">è¯·å…ˆé€‰æ‹©åˆ†ç±»</option>
                                            </select>
                        </div>
                                        <div class="bg-light border rounded p-3 small" id="prompt-template-summary">
                                            <span class="text-muted">æ­£åœ¨åŠ è½½æç¤ºè¯æ¨¡æ¿...</span>
                            </div>
                             </div>
                         </div>
                     </div>
                            <div class="col-md-8">
                                <div class="card h-100 shadow-sm">
                                    <div class="card-header">
                                        <h6 class="mb-1" id="prompt-template-title">è¯·é€‰æ‹©å·¦ä¾§æ¨¡æ¿</h6>
                                        <small class="text-muted" id="prompt-template-desc">æç¤ºè¯åŠŸèƒ½è¯´æ˜å°†æ˜¾ç¤ºåœ¨è¿™é‡Œã€‚</small>
                        </div>
                                    <div class="card-body d-flex flex-column">
                                        <div class="mb-3" id="prompt-template-meta"></div>
                                        <textarea class="form-control flex-grow-1 mb-3" id="prompt-editor" placeholder="è¯·é€‰æ‹©å·¦ä¾§æ¨¡æ¿åè¿›è¡Œç¼–è¾‘..." style="min-height: 280px;" disabled></textarea>
                                        <div>
                                            <label class="form-label text-muted small mb-1">å®æ—¶é¢„è§ˆ</label>
                                            <div class="border rounded p-3 bg-light" id="prompt-preview-content" style="min-height: 120px; max-height: 220px; overflow-y: auto;">
                                                <small class="text-muted">é¢„è§ˆå†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º</small>
                            </div>
                        </div>
                        </div>
                                    <div class="card-footer text-end">
                                        <button type="button" class="btn btn-outline-secondary btn-sm me-2" id="prompt-reset-btn" disabled>
                                            <i class="bi bi-arrow-counterclockwise"></i> æ¢å¤åŸæ–‡
                            </button>
                                        <button type="button" class="btn btn-primary btn-sm" id="prompt-save-btn" disabled>
                                            <i class="bi bi-save"></i> ä¿å­˜ä¿®æ”¹
                            </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- åŠŸèƒ½æ¸…å•é¢æ¿ -->
                <div class="content-panel" id="features-panel">
                    <div class="panel-header">
                        <i class="bi bi-ui-checks"></i>
                        <h4>åŠŸèƒ½æ¸…å•</h4>
                        <p>ç®¡ç†ç³»ç»ŸåŠŸèƒ½å¼€å…³å’Œé…ç½®é€‰é¡¹</p>
                    </div>
                    
                    <div class="features-section">
                        <h6><i class="bi bi-toggle-on"></i> åŠŸèƒ½å¼€å…³</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="feature-auto-save" checked>
                                    <label class="form-check-label" for="feature-auto-save">
                                        <strong>è‡ªåŠ¨ä¿å­˜</strong>
                                        <br><small class="text-muted">è‡ªåŠ¨ä¿å­˜è‰ç¨¿å’Œé…ç½®</small>
                                    </label>
                        </div>
                                
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="feature-image-gen" checked>
                                    <label class="form-check-label" for="feature-image-gen">
                                        <strong>AIç”Ÿå›¾</strong>
                                        <br><small class="text-muted">è‡ªåŠ¨ç”Ÿæˆæ–‡ç« é…å›¾</small>
                                    </label>
                            </div>
                                
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="feature-schedule" checked>
                                    <label class="form-check-label" for="feature-schedule">
                                        <strong>å®šæ—¶å‘å¸ƒ</strong>
                                        <br><small class="text-muted">æ”¯æŒå®šæ—¶å‘å¸ƒåŠŸèƒ½</small>
                                    </label>
                        </div>
                    </div>
                    
                            <div class="col-md-6">
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="feature-analytics">
                                    <label class="form-check-label" for="feature-analytics">
                                        <strong>æ•°æ®åˆ†æ</strong>
                                        <br><small class="text-muted">æ–‡ç« é˜…è¯»æ•°æ®åˆ†æ</small>
                            </label>
                        </div>
                                
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="feature-backup" checked>
                                    <label class="form-check-label" for="feature-backup">
                                        <strong>è‡ªåŠ¨å¤‡ä»½</strong>
                                        <br><small class="text-muted">å®šæœŸå¤‡ä»½é‡è¦æ•°æ®</small>
                                    </label>
                                </div>
                                
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="feature-notifications">
                                    <label class="form-check-label" for="feature-notifications">
                                        <strong>æ¶ˆæ¯é€šçŸ¥</strong>
                                        <br><small class="text-muted">å‘å¸ƒçŠ¶æ€é€šçŸ¥</small>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="features-section">
                            <h6><i class="bi bi-gear"></i> ç³»ç»Ÿè®¾ç½®</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="setting-language" class="form-label">ç•Œé¢è¯­è¨€</label>
                                        <select class="form-select" id="setting-language">
                                            <option value="zh-CN">ç®€ä½“ä¸­æ–‡</option>
                                            <option value="en-US">English</option>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="setting-theme" class="form-label">ä¸»é¢˜æ¨¡å¼</label>
                                        <select class="form-select" id="setting-theme">
                                            <option value="light">æµ…è‰²æ¨¡å¼</option>
                                            <option value="dark">æ·±è‰²æ¨¡å¼</option>
                                            <option value="auto">è·Ÿéšç³»ç»Ÿ</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="setting-timeout" class="form-label">è¯·æ±‚è¶…æ—¶ (ç§’)</label>
                                        <input type="number" class="form-control" id="setting-timeout" min="10" max="300" value="60">
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="setting-retry" class="form-label">é‡è¯•æ¬¡æ•°</label>
                                        <input type="number" class="form-control" id="setting-retry" min="0" max="5" value="3">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-primary" id="save-features">
                                <i class="bi bi-save"></i> ä¿å­˜è®¾ç½®
                            </button>
                            <button type="button" class="btn btn-outline-secondary" id="reset-features">
                                <i class="bi bi-arrow-clockwise"></i> æ¢å¤é»˜è®¤
                            </button>
                        </div>
                        </div>
                    </div>
                    
                <!-- è¿è¡Œæ—¥å¿—é¢æ¿ -->
                <div class="content-panel" id="runtime-logs-panel">
                    <div class="panel-header">
                        <i class="bi bi-journal-text"></i>
                        <h4>ç³»ç»Ÿè¿è¡Œæ—¥å¿—</h4>
                        <p>æŸ¥çœ‹ç³»ç»Ÿå·¥ä½œçŠ¶æ€å’Œä»»åŠ¡æ‰§è¡Œæƒ…å†µ</p>
                    </div>
                    
                    <div class="runtime-logs-section">
                        <!-- æ—¥å¿—åˆ—è¡¨ -->
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="card-title mb-0">è¿è¡Œæ—¥å¿—</h6>
                                    <button class="btn btn-sm btn-outline-primary" onclick="loadRuntimeLogs()">
                                        <i class="bi bi-arrow-clockwise"></i> åˆ·æ–°
                                    </button>
                                </div>
                                <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                                    <table class="table table-sm table-hover">
                                        <thead class="table-light sticky-top">
                                            <tr>
                                                <th style="width: 150px;">æ—¶é—´</th>
                                                <th style="width: 120px;">ä»»åŠ¡ç±»å‹</th>
                                                <th style="width: 100px;">æ¯”èµ›ç¼–å·</th>
                                                <th style="width: 80px;">çŠ¶æ€</th>
                                                <th>æ¶ˆæ¯</th>
                                            </tr>
                                        </thead>
                                        <tbody id="runtime-logs-list">
                                            <tr>
                                                <td colspan="5" class="text-center text-muted">åŠ è½½ä¸­...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div class="mt-3 text-end">
                                    <small class="text-muted" id="runtime-logs-count">å…± 0 æ¡è®°å½•</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <script>
                // è¿è¡Œæ—¥å¿—åŠŸèƒ½
                function loadRuntimeLogs() {
                    fetch('/api/lottery/runtime-logs?limit=100')
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                renderRuntimeLogs(data.data);
                                document.getElementById('runtime-logs-count').textContent = `å…± ${data.count} æ¡è®°å½•`;
                            } else {
                                document.getElementById('runtime-logs-list').innerHTML = 
                                    '<tr><td colspan="5" class="text-center text-danger">åŠ è½½å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯') + '</td></tr>';
                            }
                        })
                        .catch(error => {
                            console.error('åŠ è½½è¿è¡Œæ—¥å¿—å¤±è´¥:', error);
                            document.getElementById('runtime-logs-list').innerHTML = 
                                '<tr><td colspan="5" class="text-center text-danger">åŠ è½½å¤±è´¥: ' + error.message + '</td></tr>';
                        });
                }
                
                function renderRuntimeLogs(logs) {
                    const tbody = document.getElementById('runtime-logs-list');
                    
                    if (!logs || logs.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">æš‚æ— æ—¥å¿—è®°å½•</td></tr>';
                        return;
                    }
                    
                    tbody.innerHTML = logs.map(log => {
                        const time = new Date(log.created_at).toLocaleString('zh-CN');
                        const statusBadge = getStatusBadge(log.status);
                        const message = log.message || '-';
                        const errorDetails = log.error_details ? ` <span class="text-danger small">(${log.error_details})</span>` : '';
                        
                        return `
                            <tr>
                                <td>${time}</td>
                                <td>${log.task_name || log.task_type || '-'}</td>
                                <td>${log.match_code || '-'}</td>
                                <td>${statusBadge}</td>
                                <td>${message}${errorDetails}</td>
                            </tr>
                        `;
                    }).join('');
                }
                
                function getStatusBadge(status) {
                    const badges = {
                        'success': '<span class="badge bg-success">æˆåŠŸ</span>',
                        'failed': '<span class="badge bg-warning">å¤±è´¥</span>',
                        'error': '<span class="badge bg-danger">é”™è¯¯</span>',
                        'skipped': '<span class="badge bg-secondary">è·³è¿‡</span>',
                        'started': '<span class="badge bg-info">å¼€å§‹</span>',
                        'completed': '<span class="badge bg-primary">å®Œæˆ</span>'
                    };
                    return badges[status] || `<span class="badge bg-secondary">${status}</span>`;
                }
                
                // å½“åˆ‡æ¢åˆ°è¿è¡Œæ—¥å¿—é¢æ¿æ—¶è‡ªåŠ¨åŠ è½½
                document.addEventListener('DOMContentLoaded', function() {
                    const runtimeLogsNav = document.querySelector('[data-target="runtime-logs-panel"]');
                    if (runtimeLogsNav) {
                        runtimeLogsNav.addEventListener('click', function() {
                            setTimeout(() => {
                                loadRuntimeLogs();
                            }, 100);
                        });
                    }
                });
                </script>
                
            </div>
        </div>
        
        <!-- é¡µè„š -->
        <div class="footer">
            <small>
                &copy; 2024 å¾®ä¿¡å…¬ä¼—å·AIå‘å¸ƒç³»ç»Ÿ | åŸºäºFlaskå’ŒGemini AIæ„å»º<br>
                <span style="color: #d9534f;">æç¤ºï¼šæ­¤IPéœ€è¦æ·»åŠ åˆ°å…¬ä¼—å·çš„ç™½åå•ä¹‹åé¡¹ç›®æ‰èƒ½è¿è¡Œ</span>
            </small>
        </div>
    </div>

    <!-- Toast å®¹å™¨ -->
    <div class="toast-container position-fixed top-0 end-0 p-3" id="toast-container">
        <!-- Toast æ¶ˆæ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- CodeMirror JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/markdown/markdown.min.js"></script>
    
    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
    
    <!-- è‡ªå®šä¹‰JS -->
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    
    <!-- åˆå§‹åŒ–åº”ç”¨ -->
    <!-- <script>
        document.addEventListener('DOMContentLoaded', function() {
            App.init();
        });
    </script> -->
    <script>
        // å…¨å±€å˜é‡
        let markdownEditor = null;
        
        // é€šç”¨Toastæç¤ºå‡½æ•°ï¼ˆå¸¦é¢æ¿é˜Ÿåˆ—ï¼‰
        (function() {
          const TYPE_META = {
            success: { bs: 'success', icon: 'check-circle', title: 'æ“ä½œæˆåŠŸ', duration: 2600, text: '#ffffff' },
            error:   { bs: 'danger', icon: 'x-circle', title: 'å‘ç”Ÿé”™è¯¯', duration: 4200, text: '#ffffff' },
            warning: { bs: 'warning', icon: 'exclamation-triangle', title: 'æé†’', duration: 3200, text: '#664d03' },
            info:    { bs: 'primary', icon: 'info-circle', title: 'ç³»ç»Ÿæç¤º', duration: 2800, text: '#ffffff' }
          };
          
          const panelState = new Map(); // panelId -> { visited, queue }
          let activePanelId = null;
          
          const isToastOptions = (value) =>
            value && typeof value === 'object' && !Array.isArray(value);
          
          function ensurePanelState(panelId) {
            if (!panelId) return null;
            if (!panelState.has(panelId)) {
              panelState.set(panelId, { visited: false, queue: [] });
            }
            return panelState.get(panelId);
          }
          
          function emitToast(type, title, message, options = {}) {
            const meta = TYPE_META[type] || TYPE_META.info;
            const duration = typeof options.duration === 'number'
              ? options.duration
              : meta.duration;
            
            let container = document.getElementById('app-toast-container');
            if (!container) {
              container = document.createElement('div');
              container.id = 'app-toast-container';
              container.style.position = 'fixed';
              container.style.top = '20px';
              container.style.right = '20px';
              container.style.zIndex = '1090';
              container.style.display = 'flex';
              container.style.flexDirection = 'column';
              container.style.gap = '12px';
              document.body.appendChild(container);
            }
            
          const toast = document.createElement('div');
          toast.className = `alert alert-${meta.bs} shadow-sm d-flex align-items-start gap-2 mb-0 app-toast`;
          toast.style.minWidth = '260px';
          toast.style.maxWidth = '360px';
          toast.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue(`--bs-${meta.bs}`) || '';
          toast.style.color = meta.text || '#ffffff';
          toast.style.opacity = '1';
            toast.innerHTML = `
              <span class="mt-1"><i class="bi bi-${meta.icon}"></i></span>
              <div class="flex-grow-1">
                <div class="fw-semibold">${title}</div>
                <div class="small">${message}</div>
              </div>
              <button type="button" class="btn btn-sm btn-outline-light border-0 text-white px-2 py-0 app-toast-close">
                <span aria-hidden="true">&times;</span>
              </button>
            `;
            
            const closeBtn = toast.querySelector('.app-toast-close');
            if (meta.bs === 'warning') {
              closeBtn.classList.remove('btn-outline-light', 'text-white');
              closeBtn.classList.add('btn-outline-dark', 'text-dark');
            }
            closeBtn.addEventListener('click', () => {
              toast.remove();
            });
            
            container.appendChild(toast);
            
            if (duration !== null && duration !== Infinity) {
              setTimeout(() => toast.remove(), Math.max(duration, 1500));
            }
            
            return toast;
          }
          
          function parseToastArgs(arg1, arg2, arg3, options = {}) {
            const args = [arg1, arg2, arg3];
            let extraOptions = { ...(options || {}) };
            
            // å°†æœ€å³ä¾§çš„å¯¹è±¡å‚æ•°è§†ä¸ºoptions
            for (let i = args.length - 1; i >= 0; i--) {
              if (isToastOptions(args[i])) {
                extraOptions = { ...args[i], ...extraOptions };
                args[i] = undefined;
                break;
              }
            }
            
            const [a1, a2, a3] = args;
            const isType = (value) => typeof value === 'string' && TYPE_META[value.toLowerCase()];
            
            let type = 'info';
            let title = '';
            let message = '';
            
            if (isType(a1) && typeof a3 !== 'undefined') {
              type = a1.toLowerCase();
              title = a2;
              message = a3;
            } else if (isType(a1) && typeof a3 === 'undefined') {
              type = a1.toLowerCase();
              message = a2;
            } else {
              type = isType(a3) ? a3.toLowerCase() : type;
              title = a1;
              message = typeof a2 === 'string' ? a2 : '';
            }
            
            const meta = TYPE_META[type] || TYPE_META.info;
            title = (title && title.trim()) || meta.title;
            message = message || '';
            
            return {
              type,
              title,
              message,
              options: extraOptions
            };
          }
          
          function flushPanelQueue(panelId) {
            const state = ensurePanelState(panelId);
            if (!state) return;
            if (!state.visited) {
              state.visited = true;
            }
            while (state.queue.length) {
              const payload = state.queue.shift();
              emitToast(payload.type, payload.title, payload.message, payload.options);
            }
          }
          
          function showToast(arg1, arg2, arg3, options = {}) {
            const payload = parseToastArgs(arg1, arg2, arg3, options);
            const panelId = payload.options.panel || payload.options.panelId || activePanelId || null;
            
            if (panelId) {
              payload.options = { ...payload.options, panel: panelId };
              const state = ensurePanelState(panelId);
              if (state && state.visited) {
                emitToast(payload.type, payload.title, payload.message, payload.options);
              } else if (state) {
                state.queue.push(payload);
              } else {
                emitToast(payload.type, payload.title, payload.message, payload.options);
              }
            } else {
              emitToast(payload.type, payload.title, payload.message, payload.options);
            }
          }
          
          function markPanelVisited(panelId) {
            if (!panelId) return;
            ensurePanelState(panelId);
            flushPanelQueue(panelId);
            activePanelId = panelId;
          }
          
          document.addEventListener('DOMContentLoaded', () => {
            const activeNav = document.querySelector('.nav-item.active');
            if (activeNav) {
              const panelId = activeNav.dataset.target;
              if (panelId) {
                ensurePanelState(panelId);
                activePanelId = panelId;
              }
            }
          });
          
          window.ToastRouter = {
            registerPanel: ensurePanelState,
            markVisited: markPanelVisited,
            setActivePanel: markPanelVisited,
            getActivePanel: () => activePanelId
          };
          
          window.showToast = showToast;
        })();
        
        // åˆå§‹åŒ–Markdownç¼–è¾‘å™¨
        function initMarkdownEditor() {
            if (markdownEditor) return;
            
            const textarea = document.getElementById('markdown-editor');
            if (!textarea) return;
            
            // åˆå§‹åŒ–CodeMirror
            markdownEditor = CodeMirror.fromTextArea(textarea, {
                mode: 'markdown',
                theme: 'default',
                lineNumbers: true,
                lineWrapping: true,
                autofocus: true,
                placeholder: 'åœ¨è¿™é‡Œè¾“å…¥Markdownå†…å®¹ï¼Œå³ä¾§å°†å®æ—¶é¢„è§ˆå¾®ä¿¡å…¬ä¼—å·æ•ˆæœ...'
            });
            
            // è®¾ç½®CodeMirrorç¼–è¾‘å™¨é«˜åº¦ä¸º550pxï¼Œä¸é¢„è§ˆçª—å£ä¸€è‡´
            markdownEditor.setSize(null, '550px');
            
            // å°†ç¼–è¾‘å™¨æš´éœ²ä¸ºå…¨å±€å˜é‡ï¼Œä¾›å…¶ä»–è„šæœ¬è®¿é—®
            window.markdownEditor = markdownEditor;
            
            // å®æ—¶é¢„è§ˆåŠŸèƒ½
            markdownEditor.on('change', function() {
                updatePreview();
            });
            
            // ç»‘å®šç¼–è¾‘å™¨æ»šåŠ¨äº‹ä»¶
            markdownEditor.on('scroll', syncScroll);
            
            // åˆå§‹åŒ–é¢„è§ˆ
            updatePreview();
        }
        
        // åŒæ­¥æ»šåŠ¨åŠŸèƒ½
        let isScrolling = false;
        
        function syncScroll() {
            if (isScrolling) return;
            isScrolling = true;
            
            const editorContainer = markdownEditor.getScrollerElement();
            const previewContainer = document.querySelector('.preview-container');
            
            if (!editorContainer || !previewContainer) {
                isScrolling = false;
                return;
            }
            
            const editorScrollTop = editorContainer.scrollTop;
            const editorScrollHeight = editorContainer.scrollHeight - editorContainer.clientHeight;
            const previewScrollHeight = previewContainer.scrollHeight - previewContainer.clientHeight;
            
            if (editorScrollHeight > 0 && previewScrollHeight > 0) {
                const scrollRatio = editorScrollTop / editorScrollHeight;
                previewContainer.scrollTop = scrollRatio * previewScrollHeight;
            }
            
            setTimeout(() => {
                isScrolling = false;
            }, 10);
        }
        
        function reverseSyncScroll() {
            if (isScrolling) return;
            isScrolling = true;
            
            const editorContainer = markdownEditor.getScrollerElement();
            const previewContainer = document.querySelector('.preview-container');
            
            if (!editorContainer || !previewContainer) {
                isScrolling = false;
                return;
            }
            
            const previewScrollTop = previewContainer.scrollTop;
            const previewScrollHeight = previewContainer.scrollHeight - previewContainer.clientHeight;
            const editorScrollHeight = editorContainer.scrollHeight - editorContainer.clientHeight;
            
            if (editorScrollHeight > 0 && previewScrollHeight > 0) {
                const scrollRatio = previewScrollTop / previewScrollHeight;
                editorContainer.scrollTop = scrollRatio * editorScrollHeight;
            }
            
            setTimeout(() => {
                isScrolling = false;
            }, 10);
        }
        
        // æ›´æ–°é¢„è§ˆ
        function updatePreview() {
            if (!markdownEditor) return;
            
            const content = markdownEditor.getValue();
            const previewContainer = document.getElementById('wechat-preview');
            
            if (!content.trim()) {
                previewContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-file-earmark"></i>
                        <h6>æš‚æ— é¢„è§ˆå†…å®¹</h6>
                        <p>åœ¨å·¦ä¾§ç¼–è¾‘å™¨ä¸­è¾“å…¥å†…å®¹ï¼Œè¿™é‡Œå°†æ˜¾ç¤ºå¾®ä¿¡å…¬ä¼—å·æ•ˆæœ</p>
                    </div>
                `;
                return;
            }
            
            try {
                // ä½¿ç”¨marked.jsè§£æMarkdown
                const html = marked.parse(content);
                previewContainer.innerHTML = html;
                
                // ç»‘å®šé¢„è§ˆå®¹å™¨çš„æ»šåŠ¨äº‹ä»¶
                const previewContainerElement = document.querySelector('.preview-container');
                if (previewContainerElement && !previewContainerElement.hasAttribute('data-scroll-bound')) {
                    previewContainerElement.setAttribute('data-scroll-bound', 'true');
                    previewContainerElement.addEventListener('scroll', reverseSyncScroll);
                }
                
                // å¯ç”¨å‘å¸ƒæŒ‰é’®
                document.getElementById('publish-article').disabled = false;
                document.getElementById('save-draft').disabled = false;
            } catch (error) {
                console.error('Markdownè§£æé”™è¯¯:', error);
                previewContainer.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i>
                        Markdownè§£æé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¯­æ³•
                    </div>
                `;
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
  // ç§»åŠ¨ç«¯æ±‰å ¡èœå•åŠŸèƒ½
  const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
  const sidebar = document.querySelector('.sidebar');
  const sidebarOverlay = document.getElementById('sidebar-overlay');
  
  if (mobileMenuToggle) {
    // æ‰“å¼€/å…³é—­ä¾§è¾¹æ 
    mobileMenuToggle.addEventListener('click', function() {
      sidebar.classList.toggle('active');
      sidebarOverlay.classList.toggle('active');
    });
    
    // ç‚¹å‡»é®ç½©å±‚å…³é—­ä¾§è¾¹æ 
    sidebarOverlay.addEventListener('click', function() {
      sidebar.classList.remove('active');
      sidebarOverlay.classList.remove('active');
    });
  }
  
  // ä¾§è¾¹æ å¯¼èˆªåŠŸèƒ½
  const navItems = Array.from(document.querySelectorAll('.sidebar-nav .nav-item[data-target]'));
  const contentPanels = Array.from(document.querySelectorAll('.content-panel'));

  function activatePanel(targetId) {
    const targetPanel = document.getElementById(targetId);
    if (!targetPanel) {
      console.warn('æœªæ‰¾åˆ°ç›®æ ‡é¢æ¿:', targetId);
      return;
    }

      navItems.forEach(nav => nav.classList.remove('active'));
      contentPanels.forEach(panel => panel.classList.remove('active'));
    targetPanel.classList.add('active');
  }

  navItems.forEach(item => {
    item.addEventListener('click', function (e) {
      e.preventDefault();

      const targetId = this.dataset.target;
      activatePanel(targetId);
      this.classList.add('active');

      if (targetId === 'editor-panel' && !(window.markdownEditor)) {
        setTimeout(() => {
          if (typeof initMarkdownEditor === 'function') {
            initMarkdownEditor();
          }
        }, 100);
      }

      if (window.innerWidth <= 768) {
        if (sidebar) sidebar.classList.remove('active');
        if (sidebarOverlay) sidebarOverlay.classList.remove('active');
      }
    });
  });

  // åˆå§‹åŒ–é¡µé¢æ—¶ï¼Œç¡®ä¿è‡³å°‘æœ‰ä¸€ä¸ªé¢æ¿å¤„äºæ¿€æ´»çŠ¶æ€
  const initialActive = document.querySelector('.sidebar-nav .nav-item.active');
  if (initialActive) {
    activatePanel(initialActive.dataset.target);
    initialActive.classList.add('active');
  } else if (navItems.length) {
    navItems[0].classList.add('active');
    activatePanel(navItems[0].dataset.target);
  }
  
  // åˆå§‹åŒ–Markdownç¼–è¾‘å™¨ï¼ˆå¦‚æœé»˜è®¤æ˜¾ç¤ºç¼–è¾‘å™¨é¢æ¿ï¼‰
  const activePanel = document.querySelector('.content-panel.active');
  if (activePanel && activePanel.id === 'editor-panel' && !(window.markdownEditor)) {
    setTimeout(() => {
      if (typeof initMarkdownEditor === 'function') {
        initMarkdownEditor();
      }
    }, 100);
  }
  
  // æ–‡ä»¶å¤¹äº¤äº’åŠŸèƒ½
  function initFileManager() {
    let currentFolderId = 'default'; // å½“å‰æ´»åŠ¨æ–‡ä»¶å¤¹ID
    
    // ä¿å­˜å½“å‰ç¼–è¾‘å™¨å†…å®¹åˆ°æŒ‡å®šæ–‡ä»¶å¤¹
    function saveCurrentContentToFolder(folderId) {
      if (markdownEditor && folderId) {
        const currentContent = markdownEditor.getValue();
        const folderContents = JSON.parse(localStorage.getItem('folderContents') || '{}');
        folderContents[folderId] = currentContent;
        localStorage.setItem('folderContents', JSON.stringify(folderContents));
        console.log('ä¿å­˜å†…å®¹åˆ°æ–‡ä»¶å¤¹:', folderId);
      }
    }
    
    // ä»æŒ‡å®šæ–‡ä»¶å¤¹åŠ è½½å†…å®¹
    function loadContentFromFolder(folderId) {
      if (markdownEditor && folderId) {
        const folderContents = JSON.parse(localStorage.getItem('folderContents') || '{}');
        let content = folderContents[folderId];
        
        // å¦‚æœæ²¡æœ‰ä¿å­˜çš„å†…å®¹ï¼Œä½¿ç”¨é»˜è®¤æ¨¡æ¿
        if (!content) {
          switch(folderId) {
            case 'default':
              content = '';
              break;
            case 'laok-nankantai':
              content = `## **è€kå—çœ‹å°**

### æ¯”èµ›å‰ç»

### æŠ€æœ¯åˆ†æ

### è€kè§‚ç‚¹

> _å£°æ˜ï¼šæœ¬æ–‡åªæ˜¯ä¸ªäººçœ‹æ³•ä»¥åŠå…´è¶£æ‰€åˆ›ï¼Œæ‰€æœ‰æ•°æ®å‡æ¥æºäºå…¬å¼€ä¿¡æ¯ã€‚ç›¸å…³éƒ¨é—¨å·²æš‚åœç½‘ç»œè´­å½©ï¼Œä¸€åˆ‡äº’è”ç½‘å”®å½©çš†ä¸ºéæ³•ï¼Œå¦‚è¦è´­å½©è¯·åˆ°çº¿ä¸‹åˆæ³•å½©ç¥¨é”€å”®ç½‘ç‚¹ã€‚è¯·å¤§å®¶å¥åº·è§‚èµ›ï¼Œç†æ€§äº«å—ä½“è‚²ç«æŠ€é­…åŠ›ã€‚_`;
              break;
            case 'laok-pinglunxi':
              content = `## **è€kè¯„è®ºå¸­**

### çƒ­ç‚¹è¯é¢˜

### æ·±åº¦åˆ†æ

### è€kç‚¹è¯„

> _å£°æ˜ï¼šæœ¬æ–‡åªæ˜¯ä¸ªäººçœ‹æ³•ä»¥åŠå…´è¶£æ‰€åˆ›ï¼Œæ‰€æœ‰æ•°æ®å‡æ¥æºäºå…¬å¼€ä¿¡æ¯ã€‚ç›¸å…³éƒ¨é—¨å·²æš‚åœç½‘ç»œè´­å½©ï¼Œä¸€åˆ‡äº’è”ç½‘å”®å½©çš†ä¸ºéæ³•ï¼Œå¦‚è¦è´­å½©è¯·åˆ°çº¿ä¸‹åˆæ³•å½©ç¥¨é”€å”®ç½‘ç‚¹ã€‚è¯·å¤§å®¶å¥åº·è§‚èµ›ï¼Œç†æ€§äº«å—ä½“è‚²ç«æŠ€é­…åŠ›ã€‚_`;
              break;
            default:
              content = '';
          }
        }
        
        markdownEditor.setValue(content);
        console.log('ä»æ–‡ä»¶å¤¹åŠ è½½å†…å®¹:', folderId);
      }
    }
    
    const folderItems = document.querySelectorAll('.folder-item');
    folderItems.forEach(item => {
      item.addEventListener('click', function() {
        // ä¿å­˜å½“å‰æ–‡ä»¶å¤¹çš„å†…å®¹
        saveCurrentContentToFolder(currentFolderId);
        
        // ç§»é™¤æ‰€æœ‰æ´»åŠ¨çŠ¶æ€
        folderItems.forEach(f => f.classList.remove('active'));
        // æ·»åŠ å½“å‰æ´»åŠ¨çŠ¶æ€
        this.classList.add('active');
        
        // è·å–æ–°çš„æ–‡ä»¶å¤¹ç±»å‹
        const newFolderType = this.getAttribute('data-folder');
        console.log('ä»æ–‡ä»¶å¤¹åˆ‡æ¢:', currentFolderId, '->', newFolderType);
        
        // æ›´æ–°å½“å‰æ–‡ä»¶å¤¹ID
        currentFolderId = newFolderType;
        
        // åŠ è½½æ–°æ–‡ä»¶å¤¹çš„å†…å®¹
        loadContentFromFolder(newFolderType);
      });
      
      // æ·»åŠ åŒå‡»é‡å‘½ååŠŸèƒ½
      const folderName = item.querySelector('.folder-name');
      if (folderName && folderName.getAttribute('data-editable') === 'true') {
        folderName.addEventListener('dblclick', function(e) {
          e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°çˆ¶å…ƒç´ 
          startRename(this);
        });
      }
    });
    
    // é‡å‘½ååŠŸèƒ½
    function startRename(folderNameElement) {
      const currentName = folderNameElement.textContent;
      const input = document.createElement('input');
      input.type = 'text';
      input.value = currentName;
      input.className = 'form-control form-control-sm';
      
      // æ›¿æ¢æ–‡æœ¬ä¸ºè¾“å…¥æ¡†
      folderNameElement.innerHTML = '';
      folderNameElement.appendChild(input);
      folderNameElement.classList.add('editing');
      
      // é€‰ä¸­æ‰€æœ‰æ–‡æœ¬
      input.focus();
      input.select();
      
      // ä¿å­˜é‡å‘½å
      function saveRename() {
        const newName = input.value.trim();
        if (newName && newName !== currentName) {
          folderNameElement.textContent = newName;
          
          // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
          const folderItem = folderNameElement.closest('.folder-item');
          const folderId = folderItem.getAttribute('data-folder');
          saveFolderName(folderId, newName);
          
          console.log('æ–‡ä»¶å¤¹é‡å‘½å:', currentName, '->', newName);
      } else {
          folderNameElement.textContent = currentName;
        }
        folderNameElement.classList.remove('editing');
      }
      
      // å–æ¶ˆé‡å‘½å
      function cancelRename() {
        folderNameElement.textContent = currentName;
        folderNameElement.classList.remove('editing');
      }
      
      // ç»‘å®šäº‹ä»¶
      input.addEventListener('blur', saveRename);
      input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          saveRename();
        } else if (e.key === 'Escape') {
          cancelRename();
        }
      });
    }
    
    // ä¿å­˜æ–‡ä»¶å¤¹åç§°åˆ°æœ¬åœ°å­˜å‚¨
    function saveFolderName(folderId, newName) {
      const savedNames = JSON.parse(localStorage.getItem('folderNames') || '{}');
      savedNames[folderId] = newName;
      localStorage.setItem('folderNames', JSON.stringify(savedNames));
    }
    
    // åŠ è½½ä¿å­˜çš„æ–‡ä»¶å¤¹åç§°
    function loadFolderNames() {
      const savedNames = JSON.parse(localStorage.getItem('folderNames') || '{}');
      Object.keys(savedNames).forEach(folderId => {
        const folderItem = document.querySelector(`[data-folder="${folderId}"]`);
        if (folderItem) {
          const folderName = folderItem.querySelector('.folder-name');
          if (folderName) {
            folderName.textContent = savedNames[folderId];
          }
        }
      });
    }
    
    // åˆå§‹åŒ–æ—¶åŠ è½½ä¿å­˜çš„åç§°
    loadFolderNames();
    
    // æ–°å»ºæ–‡ä»¶å¤¹æŒ‰é’®
    const newFolderBtn = document.getElementById('new-folder-btn');
    if (newFolderBtn) {
      newFolderBtn.addEventListener('click', function() {
        const folderName = prompt('è¯·è¾“å…¥æ–°æ–‡ä»¶å¤¹åç§°:');
        if (folderName && folderName.trim()) {
          const fileTree = document.getElementById('file-tree');
          const newFolder = document.createElement('div');
          newFolder.className = 'folder-item';
          newFolder.setAttribute('data-folder', 'custom-' + Date.now());
          newFolder.innerHTML = `
            <i class="bi bi-folder-fill text-info"></i>
            <span>${folderName.trim()}</span>
          `;
          fileTree.appendChild(newFolder);
          
          // é‡æ–°ç»‘å®šäº‹ä»¶
          initFileManager();
        }
      });
    }
    
    // åˆå§‹åŒ–æ—¶åŠ è½½é»˜è®¤æ–‡ä»¶å¤¹çš„å†…å®¹
    setTimeout(() => {
      loadContentFromFolder(currentFolderId);
    }, 500); // ç­‰å¾…markdownç¼–è¾‘å™¨åˆå§‹åŒ–å®Œæˆ
  }
  
  // åˆå§‹åŒ–æ–‡ä»¶ç®¡ç†å™¨
  initFileManager();
  

  // æç¤ºè¯ç®¡ç†åŠŸèƒ½
  const promptCategorySelect = document.getElementById('prompt-category-select');
  const promptTemplateSelect = document.getElementById('prompt-template-select');
  const promptSummaryBox = document.getElementById('prompt-template-summary');
  const promptEditor = document.getElementById('prompt-editor');
  const promptTitle = document.getElementById('prompt-template-title');
  const promptDesc = document.getElementById('prompt-template-desc');
  const promptMeta = document.getElementById('prompt-template-meta');
  const promptPreview = document.getElementById('prompt-preview-content');
  const promptSaveBtn = document.getElementById('prompt-save-btn');
  const promptResetBtn = document.getElementById('prompt-reset-btn');
  const promptRefreshBtn = document.getElementById('prompt-refresh-btn');

  const promptState = {
    templates: {},
    orderedKeys: [],
    templatesByCategory: {},
    categoryIndex: {},
    selectedKey: null,
    selectedCategory: '',
    dirty: false
  };

  function formatDateTime(value) {
    if (!value) return '-';
    try {
      const date = new Date(value);
      if (isNaN(date.getTime())) return value;
      return date.toLocaleString('zh-CN', { hour12: false });
    } catch (error) {
      return value;
    }
  }

  function highlightPrompt(content) {
    if (!content) {
      return '<small class="text-muted">å†…å®¹ä¸ºç©º</small>';
    }
    return content
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/\{([^}]+)\}/g, '<span class="badge bg-primary me-1">$1</span>')
      .replace(/\n/g, '<br>');
  }

  function clearPromptDetail() {
    if (promptTitle) promptTitle.textContent = 'è¯·é€‰æ‹©å·¦ä¾§æ¨¡æ¿';
    if (promptDesc) promptDesc.textContent = 'æç¤ºè¯åŠŸèƒ½è¯´æ˜å°†æ˜¾ç¤ºåœ¨è¿™é‡Œã€‚';
    if (promptMeta) promptMeta.innerHTML = '';
    if (promptPreview) promptPreview.innerHTML = '<small class="text-muted">é¢„è§ˆå†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º</small>';
    if (promptEditor) {
      promptEditor.value = '';
      promptEditor.disabled = true;
    }
    if (promptTemplateSelect && !promptTemplateSelect.disabled) {
      promptTemplateSelect.value = '';
    }
    promptState.selectedKey = null;
    promptState.dirty = false;
    togglePromptButtons();
    updatePromptSummary();
  }

  function togglePromptButtons() {
    const canEdit = !!promptState.selectedKey;
    const hasChanges = promptState.dirty;
    if (promptSaveBtn) {
      promptSaveBtn.disabled = !(canEdit && hasChanges);
      promptSaveBtn.innerHTML = '<i class="bi bi-save"></i> ä¿å­˜ä¿®æ”¹';
    }
    if (promptResetBtn) {
      promptResetBtn.disabled = !(canEdit && hasChanges);
    }
  }

  function updatePromptPreview() {
    if (!promptPreview) return;
    const content = promptEditor ? promptEditor.value : '';
    if (!content || !content.trim()) {
      promptPreview.innerHTML = '<small class="text-muted">é¢„è§ˆå†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º</small>';
      return;
    }
    promptPreview.innerHTML = highlightPrompt(content);
  }

  function buildPromptCategoryIndex() {
    promptState.categoryIndex = {};
    promptState.templatesByCategory = {};

    promptState.orderedKeys.forEach((key) => {
      const template = promptState.templates[key];
      if (!template) return;
      const categoryKey = String(template.category || 'uncategorized');
      if (!promptState.categoryIndex[categoryKey]) {
        promptState.categoryIndex[categoryKey] = {
          key: categoryKey,
          label: template.category_display || template.category || 'æœªåˆ†ç±»',
          description: template.category_description || ''
        };
        promptState.templatesByCategory[categoryKey] = [];
      }
      promptState.templatesByCategory[categoryKey].push(key);
    });

    Object.values(promptState.templatesByCategory).forEach((keys) => {
      keys.sort((a, b) => {
        const ta = promptState.templates[a];
        const tb = promptState.templates[b];
        return (ta?.name || '').localeCompare(tb?.name || '', 'zh-CN');
      });
    });
  }

  function updatePromptSummary(template = null) {
    if (!promptSummaryBox) return;

    if (template) {
      promptSummaryBox.innerHTML = `
        <div class="fw-semibold mb-1">${template.name || 'æœªå‘½åæ¨¡æ¿'}</div>
        <div class="text-muted small mb-1">åˆ†ç±»ï¼š${template.category_display || template.category || 'æœªåˆ†ç±»'}</div>
        <div class="text-muted small">æ›´æ–°ï¼š${formatDateTime(template.updated_at)} ï½œ ä½¿ç”¨ï¼š${template.usage_count || 0} æ¬¡</div>
      `;
      return;
    }

    if (promptState.selectedCategory && promptState.categoryIndex[promptState.selectedCategory]) {
      const category = promptState.categoryIndex[promptState.selectedCategory];
      promptSummaryBox.innerHTML = `
        <div class="fw-semibold">${category.label}</div>
        <div class="text-muted small">${category.description || 'è¯¥åˆ†ç±»ä¸‹çš„æç¤ºè¯æ¨¡æ¿ä¼šæ˜¾ç¤ºåœ¨ä¸‹æ‹‰èœå•ä¸­ã€‚'}</div>
      `;
      return;
    }

    if (promptState.orderedKeys.length) {
      promptSummaryBox.innerHTML = '<span class="text-muted">è¯·é€‰æ‹©æç¤ºè¯æ¨¡æ¿ã€‚</span>';
    } else {
      promptSummaryBox.innerHTML = '<span class="text-muted">æš‚æ— æç¤ºè¯æ¨¡æ¿ã€‚</span>';
    }
  }

  function renderCategoryOptions() {
    if (!promptCategorySelect) return;

    const previous = promptState.selectedCategory;
    promptCategorySelect.innerHTML = '<option value="">å…¨éƒ¨åˆ†ç±»</option>';

    const categories = Object.values(promptState.categoryIndex)
      .sort((a, b) => a.label.localeCompare(b.label, 'zh-CN'));

    categories.forEach((category) => {
      const option = document.createElement('option');
      option.value = category.key;
      option.textContent = category.label;
      promptCategorySelect.appendChild(option);
    });

    if (previous && promptState.categoryIndex[previous]) {
      promptCategorySelect.value = previous;
    } else {
      promptCategorySelect.value = '';
      promptState.selectedCategory = '';
    }

    promptCategorySelect.disabled = categories.length === 0;
    updatePromptSummary();
  }

  function renderTemplateOptions({ preserveSelection = true } = {}) {
    if (!promptTemplateSelect) return;

    const previousSelection = preserveSelection ? promptState.selectedKey : null;
    const categoryKey = promptState.selectedCategory;
    const keys = categoryKey
      ? (promptState.templatesByCategory[categoryKey] || [])
      : promptState.orderedKeys;

    promptTemplateSelect.innerHTML = '<option value="">è¯·é€‰æ‹©æ¨¡æ¿</option>';

    keys.forEach((key) => {
      const template = promptState.templates[key];
      if (!template) return;
      const option = document.createElement('option');
      const categoryLabel = template.category_display || template.category || 'æœªåˆ†ç±»';
      option.value = key;
      option.textContent = categoryKey ? (template.name || 'æœªå‘½åæ¨¡æ¿') : `[${categoryLabel}] ${template.name || 'æœªå‘½åæ¨¡æ¿'}`;
      promptTemplateSelect.appendChild(option);
    });

    promptTemplateSelect.disabled = keys.length === 0;

    if (previousSelection && keys.includes(previousSelection)) {
      promptTemplateSelect.value = previousSelection;
      } else {
      promptTemplateSelect.value = '';
      if (!preserveSelection) {
        promptState.selectedKey = null;
        promptState.dirty = false;
      }
      if (!keys.includes(previousSelection)) {
        clearPromptDetail();
      }
    }

    updatePromptSummary();
  }

  async function loadPromptTemplates(showToastMessage = false) {
    if (!promptTemplateSelect) return;

    const previousCategory = promptState.selectedCategory;
    const previousKey = promptState.selectedKey;

    if (promptCategorySelect) {
      promptCategorySelect.disabled = true;
      promptCategorySelect.innerHTML = '<option value="">æ­£åœ¨åŠ è½½...</option>';
    }
    promptTemplateSelect.disabled = true;
    promptTemplateSelect.innerHTML = '<option value="">æ­£åœ¨åŠ è½½...</option>';
    if (promptSummaryBox) {
      promptSummaryBox.innerHTML = '<span class="text-muted">æ­£åœ¨åŠ è½½æç¤ºè¯æ¨¡æ¿...</span>';
    }

    try {
      const response = await fetch('/api/prompt-templates');
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }
      const result = await response.json();
      if (!result.success) {
        throw new Error(result.message || 'åŠ è½½å¤±è´¥');
      }

      promptState.templates = {};
      promptState.orderedKeys = [];

      Object.entries(result.data || {}).forEach(([key, template]) => {
        promptState.templates[key] = { ...template, key };
        promptState.orderedKeys.push(key);
      });

      promptState.orderedKeys.sort((a, b) => {
        const ta = promptState.templates[a];
        const tb = promptState.templates[b];
        const catA = (ta?.category_display || ta?.category || '').toString();
        const catB = (tb?.category_display || tb?.category || '').toString();
        if (catA === catB) {
          return (ta?.name || '').localeCompare(tb?.name || '', 'zh-CN');
        }
        return catA.localeCompare(catB, 'zh-CN');
      });

      buildPromptCategoryIndex();

      if (previousCategory && promptState.categoryIndex[previousCategory]) {
        promptState.selectedCategory = previousCategory;
      } else {
        promptState.selectedCategory = '';
      }

      if (previousKey && promptState.templates[previousKey]) {
        promptState.selectedKey = previousKey;
      } else {
        promptState.selectedKey = null;
      }

      renderCategoryOptions();
      renderTemplateOptions({ preserveSelection: !!promptState.selectedKey });

      if (promptState.selectedKey && promptState.templates[promptState.selectedKey]) {
        selectPromptTemplate(promptState.selectedKey, false);
      } else {
        clearPromptDetail();
      }

      if (promptCategorySelect) {
        promptCategorySelect.disabled = Object.keys(promptState.categoryIndex).length === 0;
      }
      if (promptTemplateSelect) {
        promptTemplateSelect.disabled = promptTemplateSelect.options.length <= 1;
      }

      if (showToastMessage && window.showToast) {
        window.showToast('success', 'æç¤ºè¯å·²æ›´æ–°', 'å·²åŠ è½½æœ€æ–°æç¤ºè¯æ¨¡æ¿');
          }
        } catch (error) {
      console.error('åŠ è½½æç¤ºè¯æ¨¡æ¿å¤±è´¥:', error);
      clearPromptDetail();
      if (promptCategorySelect) {
        promptCategorySelect.innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
        promptCategorySelect.disabled = true;
      }
      if (promptTemplateSelect) {
        promptTemplateSelect.innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
        promptTemplateSelect.disabled = true;
      }
      if (promptSummaryBox) {
        promptSummaryBox.innerHTML = `<span class="text-danger">åŠ è½½å¤±è´¥ï¼š${error.message || error}</span>`;
      }
      if (window.showToast) {
        window.showToast('error', 'åŠ è½½æç¤ºè¯å¤±è´¥', error.message || 'è¯·ç¨åé‡è¯•');
      }
    }
  }

  function selectPromptTemplate(key, focusEditor = true) {
    const template = promptState.templates[key];
    if (!template) return;

    promptState.selectedKey = key;
    promptState.dirty = false;

    if (promptTitle) promptTitle.textContent = template.name || 'æœªå‘½åæ¨¡æ¿';
    if (promptDesc) promptDesc.textContent = template.category_description || 'æš‚æ— è¯¦ç»†è¯´æ˜';
    if (promptMeta) {
      promptMeta.innerHTML = `
        <span class="badge bg-secondary me-2">${template.category_display || template.category || 'æœªåˆ†ç±»'}</span>
        <small class="text-muted">
          åˆ›å»ºï¼š${formatDateTime(template.created_at)} ï½œ æ›´æ–°ï¼š${formatDateTime(template.updated_at)} ï½œ ä½¿ç”¨ï¼š${template.usage_count || 0} æ¬¡ ï½œ æˆåŠŸç‡ï¼š${((template.success_rate || 0) * 100).toFixed(1)}%
        </small>
      `;
    }

    if (promptEditor) {
      promptEditor.disabled = false;
      promptEditor.value = template.content || '';
      if (focusEditor) {
        promptEditor.focus();
      }
    }

    updatePromptPreview();
    togglePromptButtons();

    if (promptTemplateSelect) {
      promptTemplateSelect.value = key;
    }

    updatePromptSummary(template);
  }

  function resetCurrentPrompt() {
    if (!promptState.selectedKey) return;
    const template = promptState.templates[promptState.selectedKey];
    if (!template) return;
      if (promptEditor) {
      promptEditor.value = template.content || '';
    }
    promptState.dirty = false;
    updatePromptPreview();
    togglePromptButtons();
    if (window.showToast) {
      window.showToast('info', 'å·²æ¢å¤åŸæ–‡', 'å·²è¿˜åŸä¸ºä¿å­˜çš„æç¤ºè¯å†…å®¹');
    }
  }

  async function saveCurrentPrompt() {
    if (!promptState.selectedKey) {
      if (window.showToast) window.showToast('warning', 'æœªé€‰æ‹©æ¨¡æ¿', 'è¯·å…ˆåœ¨å·¦ä¾§é€‰æ‹©éœ€è¦ç¼–è¾‘çš„æç¤ºè¯æ¨¡æ¿');
      return;
    }
    if (!promptEditor) return;

    const content = promptEditor.value;
    if (!content.trim()) {
      if (window.showToast) window.showToast('warning', 'å†…å®¹ä¸ºç©º', 'è¯·å¡«å†™æç¤ºè¯å†…å®¹åå†ä¿å­˜');
        return;
      }

    const key = promptState.selectedKey;
    try {
      if (promptSaveBtn) {
        promptSaveBtn.disabled = true;
        promptSaveBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> ä¿å­˜ä¸­...';
      }

      const response = await fetch(`/api/prompt-templates/${encodeURIComponent(key)}`, {
        method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ content })
      });
        const result = await response.json();
      if (!result.success) {
        throw new Error(result.message || 'ä¿å­˜å¤±è´¥');
      }

      promptState.templates[key].content = content;
      promptState.templates[key].updated_at = new Date().toISOString();
      promptState.dirty = false;
      togglePromptButtons();
      updatePromptPreview();
      renderTemplateOptions({ preserveSelection: true });
      updatePromptSummary(promptState.templates[key]);

      if (window.showToast) {
        window.showToast('success', 'ä¿å­˜æˆåŠŸ', 'æç¤ºè¯æ¨¡æ¿å·²æ›´æ–°');
              }
            } catch (error) {
      console.error('ä¿å­˜æç¤ºè¯å¤±è´¥:', error);
      if (window.showToast) {
        window.showToast('error', 'ä¿å­˜å¤±è´¥', error.message || 'è¯·ç¨åé‡è¯•');
      }
    } finally {
      if (promptSaveBtn) {
        promptSaveBtn.innerHTML = '<i class="bi bi-save"></i> ä¿å­˜ä¿®æ”¹';
      }
      if (promptState.selectedKey && promptState.templates[promptState.selectedKey]) {
        selectPromptTemplate(promptState.selectedKey, false);
      }
    }
  }

  if (promptEditor) {
    promptEditor.addEventListener('input', () => {
      if (!promptState.selectedKey) return;
      promptState.dirty = true;
      updatePromptPreview();
      togglePromptButtons();
    });
  }

  if (promptResetBtn) {
    promptResetBtn.addEventListener('click', resetCurrentPrompt);
  }

  if (promptSaveBtn) {
    promptSaveBtn.addEventListener('click', saveCurrentPrompt);
  }

  if (promptRefreshBtn) {
    promptRefreshBtn.addEventListener('click', () => loadPromptTemplates(true));
  }

  if (promptCategorySelect) {
    promptCategorySelect.addEventListener('change', (event) => {
      promptState.selectedCategory = event.target.value || '';
      renderTemplateOptions({ preserveSelection: false });
    });
  }

  if (promptTemplateSelect) {
    promptTemplateSelect.addEventListener('change', (event) => {
      const key = event.target.value;
      if (key) {
        selectPromptTemplate(key);
        } else {
        clearPromptDetail();
      }
    });
    loadPromptTemplates(false);
  }

  // åŠŸèƒ½æ¸…å•ä¿å­˜åŠŸèƒ½
  const saveFeaturesBtn = document.getElementById('save-features');
  const resetFeaturesBtn = document.getElementById('reset-features');
  
  if (saveFeaturesBtn) {
    saveFeaturesBtn.addEventListener('click', function() {
      // æ”¶é›†æ‰€æœ‰è®¾ç½®
      const settings = {
        features: {
          autoSave: document.getElementById('feature-auto-save')?.checked,
          imageGen: document.getElementById('feature-image-gen')?.checked,
          schedule: document.getElementById('feature-schedule')?.checked,
          analytics: document.getElementById('feature-analytics')?.checked,
          backup: document.getElementById('feature-backup')?.checked,
          notifications: document.getElementById('feature-notifications')?.checked
        },
        system: {
          language: document.getElementById('setting-language')?.value,
          theme: document.getElementById('setting-theme')?.value,
          timeout: document.getElementById('setting-timeout')?.value,
          retry: document.getElementById('setting-retry')?.value
        }
      };
      
      // æ¨¡æ‹Ÿä¿å­˜
      console.log('ä¿å­˜è®¾ç½®:', settings);
      showToast('ä¿å­˜æˆåŠŸ', 'åŠŸèƒ½é…ç½®å·²ä¿å­˜<br><small class="text-muted">æ³¨ï¼šå½“å‰ä¸ºæ¼”ç¤ºç‰ˆæœ¬ï¼Œè®¾ç½®å°†åœ¨é¡µé¢åˆ·æ–°åé‡ç½®</small>', 'success');
    });
  }
  
  if (resetFeaturesBtn) {
    resetFeaturesBtn.addEventListener('click', function() {
      if (confirm('ç¡®å®šè¦æ¢å¤é»˜è®¤è®¾ç½®å—ï¼Ÿ')) {
        // é‡ç½®æ‰€æœ‰è®¾ç½®
        if (document.getElementById('feature-auto-save')) document.getElementById('feature-auto-save').checked = true;
        if (document.getElementById('feature-image-gen')) document.getElementById('feature-image-gen').checked = true;
        if (document.getElementById('feature-schedule')) document.getElementById('feature-schedule').checked = true;
        if (document.getElementById('feature-analytics')) document.getElementById('feature-analytics').checked = false;
        if (document.getElementById('feature-backup')) document.getElementById('feature-backup').checked = true;
        if (document.getElementById('feature-notifications')) document.getElementById('feature-notifications').checked = false;
        
        if (document.getElementById('setting-language')) document.getElementById('setting-language').value = 'zh-CN';
        if (document.getElementById('setting-theme')) document.getElementById('setting-theme').value = 'light';
        if (document.getElementById('setting-timeout')) document.getElementById('setting-timeout').value = '60';
        if (document.getElementById('setting-retry')) document.getElementById('setting-retry').value = '3';
        
        showToast('é‡ç½®æˆåŠŸ', 'å·²æ¢å¤é»˜è®¤è®¾ç½®', 'success');
      }
    });
  }

  // ç”Ÿå›¾æ¨¡å‹é€‰æ‹©ä¸é˜¿é‡Œäº‘ç™¾ç‚¼è‡ªå®šä¹‰ä¸‹æ‹‰èœå•è”åŠ¨
  const imageModelSelect = document.getElementById('image-model-select');
  const customImagePrompt = document.getElementById('custom-image-prompt');
  const dashscopeDropdown = document.getElementById('dashscope-image-model-dropdown');
  const dashscopeExtraFields = document.getElementById('dashscope-extra-fields');
  if (imageModelSelect && customImagePrompt && dashscopeDropdown && dashscopeExtraFields) {
    imageModelSelect.addEventListener('change', function() {
      if (this.value === 'dashscope') {
        dashscopeDropdown.style.display = '';
        dashscopeExtraFields.style.display = '';
        customImagePrompt.style.display = 'none';
      } else {
        dashscopeDropdown.style.display = 'none';
        dashscopeExtraFields.style.display = 'none';
        customImagePrompt.style.display = '';
      }
    });
    // é¡µé¢åˆå§‹æ—¶æ ¹æ®å½“å‰é€‰é¡¹æ˜¾ç¤º/éšè—
    if (imageModelSelect.value === 'dashscope') {
      dashscopeDropdown.style.display = '';
      dashscopeExtraFields.style.display = '';
      customImagePrompt.style.display = 'none';
    } else {
      dashscopeDropdown.style.display = 'none';
      dashscopeExtraFields.style.display = 'none';
      customImagePrompt.style.display = '';
    }
  }

  const dashscopeDropdownMenu = document.querySelector('#dashscope-image-model-dropdown .dropdown-menu');
  const dashscopeDropdownBtn = document.getElementById('dashscopeImageModelBtn');
  const dashscopeImageModelValue = document.getElementById('dashscope-image-model-value');
  if (dashscopeDropdownMenu && dashscopeDropdownBtn && dashscopeImageModelValue) {
    dashscopeDropdownMenu.addEventListener('click', function(e) {
      const target = e.target.closest('a[data-value]');
      if (target) {
        e.preventDefault();
        const val = target.getAttribute('data-value');
        dashscopeImageModelValue.value = val;
        dashscopeDropdownBtn.textContent = target.textContent.replace(/\s*é™å…\s*$/, '');
      }
    });
    // åŠ¨æ€è°ƒæ•´ä¸‹æ‹‰èœå•å®½åº¦ä»¥é€‚é…æœ€é•¿æ–‡æœ¬
    let maxWidth = dashscopeDropdownBtn.offsetWidth;
    Array.from(dashscopeDropdownMenu.querySelectorAll('a')).forEach(a => {
      const span = document.createElement('span');
      span.style.visibility = 'hidden';
      span.style.position = 'absolute';
      span.style.whiteSpace = 'nowrap';
      span.style.font = window.getComputedStyle(a).font;
      span.innerHTML = a.innerHTML;
      document.body.appendChild(span);
      const w = span.offsetWidth + 40;
      if (w > maxWidth) maxWidth = w;
      document.body.removeChild(span);
    });
    dashscopeDropdownMenu.style.minWidth = maxWidth + 'px';
    dashscopeDropdownBtn.style.width = maxWidth + 'px';
    dashscopeDropdownMenu.style.width = maxWidth + 'px';
    dashscopeDropdownMenu.parentNode.style.maxWidth = maxWidth + 'px';
  }

  // å›¾ç‰‡æ‹–æ‹½åŠŸèƒ½å·²ç§»é™¤

        // ä¼˜å…ˆç”¨åç«¯æ¥å£è·å–IPï¼Œè‹¥ä¸º127.0.0.1æˆ–å†…ç½‘IPåˆ™ç”¨ç¬¬ä¸‰æ–¹APIå…œåº•
        function isLocalIp(ip) {
            return ip === '127.0.0.1' || ip === '::1' || ip.startsWith('192.168.') || ip.startsWith('10.') || ip.startsWith('172.');
        }
        fetch('/api/get_ip').then(res => res.json()).then(data => {
            let ip = data.ip || 'è·å–å¤±è´¥';
            const errorIp = data.wechat_error_ip;
            const ipEl = document.getElementById('user-ip');
            // è‹¥æœ‰æœ€è¿‘ä¸€æ¬¡å¾®ä¿¡é”™è¯¯IPï¼Œä¼˜å…ˆæç¤ºè¯¥IPï¼ˆæ›´æ¥è¿‘å®é™…éœ€è¦åŠ å…¥ç™½åå•çš„å‡ºå£IPï¼‰
            if (errorIp) {
                ipEl.textContent = errorIp;
                ipEl.title = 'æœ€è¿‘ä¸€æ¬¡å¾®ä¿¡è¿”å›çš„å‡ºå£IPï¼ˆè¯·ä¼˜å…ˆåŠ å…¥ç™½åå•ï¼‰';
                return;
            }
            if (isLocalIp(ip)) {
                // ç”¨å…è´¹ç¬¬ä¸‰æ–¹APIå…œåº•
                fetch('https://api.ipify.org?format=json').then(res2 => res2.json()).then(data2 => {
                    ipEl.textContent = data2.ip || ip;
                }).catch(() => {
                    ipEl.textContent = ip;
                });
            } else {
                ipEl.textContent = ip;
            }
        }).catch(() => {
            document.getElementById('user-ip').textContent = 'è·å–å¤±è´¥';
        });
        });
    </script>
    <script>
        
    </script>
    <script>
// ä¸‹æ‹‰æ¡†optionè§’æ ‡æ¸²æŸ“
(function() {
  const select = document.getElementById('dashscope-image-model');
  if (!select) return;
  function renderBadges() {
    // ç§»é™¤æ—§çš„è‡ªå®šä¹‰æ¸²æŸ“
    const wrapper = select.parentNode.querySelector('.custom-select-badge-wrapper');
    if (wrapper) wrapper.remove();
    // åˆ›å»ºè‡ªå®šä¹‰ä¸‹æ‹‰åˆ—è¡¨
    const custom = document.createElement('div');
    custom.className = 'custom-select-badge-wrapper';
    custom.style.position = 'relative';
    custom.style.width = select.offsetWidth + 'px';
    custom.style.marginTop = '-38px';
    custom.style.pointerEvents = 'none';
    Array.from(select.options).forEach((opt, idx) => {
      if (opt.dataset.badge) {
        const badge = document.createElement('span');
        badge.className = 'badge-free';
        badge.innerText = opt.dataset.badge;
        badge.style.top = (6 + idx * 34) + 'px';
        badge.style.right = '8px';
        badge.style.position = 'absolute';
        custom.appendChild(badge);
      }
    });
    select.parentNode.appendChild(custom);
  }
  select.addEventListener('change', renderBadges);
  select.addEventListener('focus', renderBadges);
  renderBadges();
})();
    </script>
    <script>
        // è‡ªåŠ¨è·å–GitHub staræ•°é‡
        fetch('https://api.github.com/repos/wojiadexiaoming-copy/AIWeChatauto')
          .then(res => res.json())
          .then(data => {
            if(data && typeof data.stargazers_count === 'number') {
              document.getElementById('star-num').textContent = data.stargazers_count;
            } else {
              document.getElementById('star-num').textContent = '--';
            }
          })
          .catch(()=>{
            document.getElementById('star-num').textContent = '--';
          });
    </script>
    <script>
        // æ£€æŸ¥æ›´æ–°æŒ‰é’®é€»è¾‘
        document.getElementById('check-update-btn').addEventListener('click', function() {
            this.disabled = true;
            this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> æ£€æŸ¥ä¸­...';
            // 1. è·å–GitHubæœ€æ–°releaseæˆ–commit
            fetch('https://api.github.com/repos/wojiadexiaoming-copy/AIWeChatauto/commits/main')
              .then(res => res.json())
              .then(data => {
                const latestSha = data && data.sha ? data.sha : null;
                // 2. è·å–æœ¬åœ°ç‰ˆæœ¬ï¼ˆéœ€åç«¯APIæ”¯æŒï¼‰
                fetch('/api/local_version')
                  .then(res2 => res2.json())
                  .then(local => {
                    const localSha = local && local.sha ? local.sha : null;
                    if(latestSha && localSha) {
                      if(latestSha === localSha) {
                        alert('å½“å‰å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼\n\næœ¬åœ°ç‰ˆæœ¬ï¼š' + localSha + '\nGitHubç‰ˆæœ¬ï¼š' + latestSha);
                      } else {
                        if(confirm('æ£€æµ‹åˆ°æœ‰æ–°ç‰ˆæœ¬ï¼\n\næœ¬åœ°ç‰ˆæœ¬ï¼š' + localSha + '\nGitHubç‰ˆæœ¬ï¼š' + latestSha + '\n\næ˜¯å¦ä¸‹è½½å¹¶è‡ªåŠ¨æ›´æ–°ï¼Ÿ')) {
                          // 3. è§¦å‘åç«¯è‡ªåŠ¨æ‹‰å–GitHubæœ€æ–°ä»£ç ï¼ˆéœ€åç«¯å®ç°ï¼‰
                          fetch('/api/update_from_github', {method:'POST'})
                            .then(r=>r.json()).then(r=>{
                              if(r.success){
                                alert('æ›´æ–°æˆåŠŸï¼Œè¯·åˆ·æ–°é¡µé¢ï¼');
                                location.reload();
                              } else if (r.needs_confirm) {
                                if(confirm(r.message + "\n\nè­¦å‘Šï¼šæ›´æ–°å°†å¯èƒ½è¦†ç›–æ‚¨çš„æœ¬åœ°ä¿®æ”¹ï¼Œæ˜¯å¦å¼ºåˆ¶æ›´æ–°ï¼Ÿ")) {
                                    // è¿™é‡Œå¯ä»¥å¢åŠ å¼ºåˆ¶æ›´æ–°çš„é€»è¾‘ï¼Œä¾‹å¦‚å†æ¬¡è°ƒç”¨ä¸€ä¸ªå¸¦forceå‚æ•°çš„API
                                    alert('å¦‚éœ€å¼ºåˆ¶æ›´æ–°ï¼Œè¯·è”ç³»å¼€å‘è€…å¼€æ”¾æ­¤åŠŸèƒ½ã€‚');
                                }
                              } else{
                                alert('æ›´æ–°å¤±è´¥ï¼š'+(r.message||'æœªçŸ¥é”™è¯¯'));
                              }
                            }).catch(()=>alert('æ›´æ–°å¤±è´¥ï¼'));
                        }
                      }
                    } else {
                      alert('æ— æ³•è·å–ç‰ˆæœ¬ä¿¡æ¯ï¼Œè¯·ç¨åé‡è¯•');
                    }
                  }).catch(()=>alert('è·å–æœ¬åœ°ç‰ˆæœ¬å¤±è´¥'));
              }).catch(()=>alert('è·å–GitHubæœ€æ–°ç‰ˆæœ¬å¤±è´¥'))
              .finally(()=>{
                this.disabled = false;
                this.innerHTML = '<i class="bi bi-arrow-repeat"></i> æ£€æŸ¥æ›´æ–°';
              });
        });
    </script>
    
    <!-- ç«å½©æ•°æ®ç›¸å…³JavaScript -->
    <!-- é‡æ„ç‰ˆæ¨¡å—ï¼ˆä¼˜å…ˆä½¿ç”¨ï¼‰ -->
    <script src="{{ url_for('static', filename='js/sporttery/SportteryUtils.js') }}" charset="UTF-8"></script>
    <script src="{{ url_for('static', filename='js/sporttery/SportteryState.js') }}" charset="UTF-8"></script>
    <script src="{{ url_for('static', filename='js/sporttery/SportteryDataService.js') }}" charset="UTF-8"></script>
    <script src="{{ url_for('static', filename='js/sporttery/SportteryRenderer.js') }}" charset="UTF-8"></script>
    <script src="{{ url_for('static', filename='js/sporttery/SportteryManager.js') }}" charset="UTF-8"></script>
    
    <!-- å…¶ä»–åŠŸèƒ½æ¨¡å— -->
    <script src="{{ url_for('static', filename='js/sporttery/MatchResultService.js') }}" charset="UTF-8"></script>
    <script src="{{ url_for('static', filename='js/sporttery/DataCollectionMonitor.js') }}" charset="UTF-8"></script>
    <script src="{{ url_for('static', filename='js/sporttery/AppInitializer.js') }}" charset="UTF-8"></script>
    
    <!-- æ—§ç‰ˆä»£ç ï¼ˆå¤‡ä»½ï¼Œå¦‚æœæ–°ç‰ˆæœ¬æœ‰é—®é¢˜å¯ä»¥å–æ¶ˆæ³¨é‡Šæ¢å¤ï¼‰ -->
    <!--
    <script>
        // ç«å½©æ•°æ®ç®¡ç†ï¼ˆæ—§ç‰ˆï¼‰
        class SportteryManagerOld {
            constructor() {
                this.currentData = null;
                this.allResultsData = null; // å­˜å‚¨æ‰€æœ‰èµ›æœæ•°æ®
                this.init();
            }
            
            init() {
                this.bindEvents();
                this.loadInitialData();
            }
            
            bindEvents() {
                // åˆ·æ–°æ•°æ®æŒ‰é’® - å¼ºåˆ¶æŠ“å–æ–°æ•°æ®
                document.getElementById('refresh-sporttery-data').addEventListener('click', () => {
                    this.forceRefreshData();
                });
                
                // æŸ¥çœ‹èµ›æœæŒ‰é’®
                document.getElementById('view-results').addEventListener('click', () => {
                    this.loadResultsData();
                });
                
                // å¿«é€Ÿé¢„æµ‹æŒ‰é’®
                document.getElementById('quick-prediction').addEventListener('click', () => {
                    this.runQuickPrediction();
                });
                
                // æ·±åº¦åˆ†ææŒ‰é’®
                document.getElementById('deep-analysis').addEventListener('click', () => {
                    this.runDeepAnalysis();
                });
                
                // ä¸­æ–­ä»»åŠ¡æŒ‰é’®
                document.getElementById('interrupt-task-btn').addEventListener('click', () => {
                    this.interruptCurrentTask();
                });
                
                // ç»Ÿè®¡å¡ç‰‡
                const accuracyStatsCard = document.getElementById('accuracy-stats-card');
                if (accuracyStatsCard) {
                    console.log('âœ… æ‰¾åˆ°ç»Ÿè®¡å¡ç‰‡å…ƒç´ ï¼Œç»‘å®šç‚¹å‡»äº‹ä»¶');
                    accuracyStatsCard.addEventListener('click', () => {
                        console.log('âœ… ç»Ÿè®¡å¡ç‰‡è¢«ç‚¹å‡»äº†ï¼');
                        // ä½¿ç”¨å…¨å±€çš„ sportteryManager å®ä¾‹
                        if (window.sportteryManager && typeof window.sportteryManager.refreshAccuracyStats === 'function') {
                            console.log('âœ… ä½¿ç”¨ window.sportteryManager.refreshAccuracyStats');
                            window.sportteryManager.refreshAccuracyStats();
                        } else if (this && this.refreshAccuracyStats) {
                            console.log('âœ… ä½¿ç”¨ this.refreshAccuracyStats');
                            // é™çº§åˆ°æ—§ç‰ˆæœ¬æ–¹æ³•
                    this.refreshAccuracyStats();
                        } else {
                            console.error('âŒ refreshAccuracyStats æ–¹æ³•æœªæ‰¾åˆ°');
                            console.log('window.sportteryManager:', window.sportteryManager);
                            console.log('this:', this);
                        }
                });
                } else {
                    console.error('âŒ æœªæ‰¾åˆ°ç»Ÿè®¡å¡ç‰‡å…ƒç´  accuracy-stats-card');
                }
                
                // ä¸€é”®è§¦å‘æŒ‰é’®
                document.getElementById('run-all-workflow').addEventListener('click', () => {
                    this.showRunWorkflowConfirm();
                });
                
                // è§†å›¾åˆ‡æ¢
                document.getElementById('view-matches').addEventListener('change', () => {
                    this.switchView('matches');
                });
                
                document.getElementById('view-results-data').addEventListener('change', () => {
                    this.switchView('results');
                });
                
                // ç¼–è¾‘ç»“æœæŒ‰é’®äº‹ä»¶å§”æ‰˜
                document.addEventListener('click', (e) => {
                    if (e.target.closest('.edit-result-btn')) {
                        const button = e.target.closest('.edit-result-btn');
                        const matchCode = button.dataset.matchCode;
                        const currentScore = button.dataset.currentScore;
                        this.editMatchResult(matchCode, currentScore);
                    }
                });
            }
            
            async loadInitialData() {
                // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è·å–æ•°æ®
                await this.refreshMatchesData();
            }
            
            async forceRefreshData() {
                // å¼ºåˆ¶æŠ“å–æ–°æ•°æ®ï¼ˆç”¨äº"èµ›ç¨‹æ›´æ–°"æŒ‰é’®ï¼‰
                const button = document.getElementById('refresh-sporttery-data');
                const originalText = button.innerHTML;
                
                try {
                    // ä¿å­˜æŒ‰é’®çŠ¶æ€å¹¶æ˜¾ç¤ºä¸­æ–­æŒ‰é’®
                    this._refreshButtonState = { originalText };
                    button.disabled = true;
                    button.innerHTML = '<i class="bi bi-hourglass-split"></i> æ‰§è¡Œä¸­...';
                    this.showInterruptButton(true);
                    
                this.showLoading(true);
                this.updateStatus('æ­£åœ¨å¼ºåˆ¶æ›´æ–°æ•°æ®...', 'warning');
                    
                } catch (error) {
                    console.error('å‡†å¤‡å¼ºåˆ¶æ›´æ–°æ•°æ®å¤±è´¥:', error);
                }
                
                try {
                    const collectResponse = await fetch('/api/lottery/collect-schedule', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (!collectResponse.ok) {
                        throw new Error('æ”¶é›†èµ›ç¨‹å¤±è´¥');
                    }
                    
                    const collectResult = await collectResponse.json();
                    
                    const result = {
                        status: 'success',
                        data: collectResult.data.matches,
                        count: collectResult.data.count
                    };
                    
                    if (result.status === 'success') {
                        // åˆå¹¶æ–‡ç« ç”ŸæˆçŠ¶æ€ï¼Œä¾¿äºæ¸²æŸ“"æŸ¥çœ‹æ–‡ç« "å…¥å£
                        try {
                            await this.mergeArticleStatus(result.data);
                        } catch (e) { console.warn('åˆå¹¶æ–‡ç« çŠ¶æ€å¤±è´¥', e); }
                        this.currentData = result.data;
                        this.renderMatchesTable(result.data);
                        this.updateStatus(`å·²æ›´æ–° ${result.count} åœºæ¯”èµ›`, 'success');
                        this.updateLastUpdateTime(new Date().toLocaleString());
                        
                        showToast('success', 'èµ›ç¨‹æ•°æ®å¼ºåˆ¶æ›´æ–°æˆåŠŸ', `æˆåŠŸè·å– ${result.count} åœºæ¯”èµ›æ•°æ®`);
                        
                        // åˆå§‹åŒ–tooltip
                        this.initializeTooltips();
                        
                        // åŠ è½½ç»Ÿè®¡æ•°æ®
                        this.refreshAccuracyStats();
                    }
                } catch (error) {
                    console.error('å¼ºåˆ¶æ›´æ–°æ•°æ®å¤±è´¥:', error);
                    this.updateStatus('å¼ºåˆ¶æ›´æ–°æ•°æ®å¤±è´¥', 'error');
                    showToast('error', 'å¼ºåˆ¶æ›´æ–°æ•°æ®å¤±è´¥', error.message);
                } finally {
                    this.showLoading(false);
                    // æ¢å¤æŒ‰é’®çŠ¶æ€å¹¶éšè—ä¸­æ–­æŒ‰é’®
                    const button = document.getElementById('refresh-sporttery-data');
                    if (this._refreshButtonState && button) {
                        button.disabled = false;
                        button.innerHTML = this._refreshButtonState.originalText;
                        this._refreshButtonState = null;
                    }
                    this.showInterruptButton(false);
                }
            }
            
            async refreshMatchesData() {
                this.showLoading(true);
                this.updateStatus('æ­£åœ¨è·å–æ•°æ®...', 'warning');
                
                try {
                    // ä»…ä»ç¼“å­˜è·å–æ•°æ®ï¼Œæ·»åŠ æ—¶é—´æˆ³é¿å…ç¼“å­˜
                    const cacheResponse = await fetch(`/api/lottery/schedule?t=${Date.now()}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'Cache-Control': 'no-cache'
                        }
                    });
                    
                    let result;
                    
                    if (cacheResponse.ok) {
                        const cacheResult = await cacheResponse.json();
                        
                        // æ£€æŸ¥ç¼“å­˜æ˜¯å¦æœ‰æ•°æ®
                        if (cacheResult.status === 'success' && cacheResult.data && cacheResult.data.length > 0) {
                            // ä½¿ç”¨ç¼“å­˜æ•°æ®
                            result = {
                                status: 'success',
                                data: cacheResult.data,
                                count: cacheResult.count
                            };
                            this.updateStatus('æ­£åœ¨åŠ è½½ç¼“å­˜æ•°æ®...', 'info');
                            
                            // éå†result.dataç¡®ä¿çŠ¶æ€å­—æ®µä¸€è‡´æ€§
                            result.data.forEach(match => {
                                if (match.source_type === 'deep') {
                                    match.prediction_type = 'deep';
                                } else if (!match.prediction_type) {
                                    match.prediction_type = 'waiting';
                                }
                            });
                            
                            // åˆå¹¶æ–‡ç« çŠ¶æ€ï¼Œç¡®ä¿å†å²æ–‡ç« æœ‰å…¥å£
                            try {
                                await this.mergeArticleStatus(result.data);
                            } catch (e) { console.warn('åˆå¹¶æ–‡ç« çŠ¶æ€å¤±è´¥', e); }
                        } else {
                            // ç¼“å­˜ä¸ºç©ºï¼Œæ˜¾ç¤º"æ— èµ›ç¨‹"
                            result = {
                                status: 'success',
                                data: [],
                                count: 0
                            };
                            this.updateStatus('æš‚æ— èµ›ç¨‹æ•°æ®', 'info');
                        }
                    } else {
                        // è·å–ç¼“å­˜å¤±è´¥ï¼Œæ˜¾ç¤º"æ— èµ›ç¨‹"
                        result = {
                            status: 'success',
                            data: [],
                            count: 0
                        };
                        this.updateStatus('æš‚æ— èµ›ç¨‹æ•°æ®', 'info');
                    }
                    
                    if (result.status === 'success') {
                        this.currentData = result.data;
                        this.renderMatchesTable(result.data);
                        
                        if (result.count > 0) {
                            this.updateStatus(`å·²åŠ è½½ ${result.count} åœºæ¯”èµ›`, 'success');
                            this.updateLastUpdateTime(new Date().toLocaleString());
                            showToast('success', 'åŠ è½½èµ›ç¨‹æˆåŠŸ', `å·²åŠ è½½ ${result.count} åœºæ¯”èµ›`);
                        } else {
                            this.updateStatus('æš‚æ— èµ›ç¨‹æ•°æ®', 'info');
                            showToast('info', 'æš‚æ— èµ›ç¨‹æ•°æ®', 'è¯·ç‚¹å‡»"èµ›ç¨‹æ›´æ–°"æŒ‰é’®æŠ“å–æœ€æ–°æ•°æ®');
                        }
                        
                        // åˆå§‹åŒ–tooltip
                        this.initializeTooltips();
                        
                        // åŠ è½½ç»Ÿè®¡æ•°æ®
                        this.loadStats();
                    } else {
                        this.updateStatus('æ•°æ®è·å–å¤±è´¥', 'danger');
                        showToast('error', 'æ•°æ®è·å–å¤±è´¥', result.message || 'æœªçŸ¥é”™è¯¯');
                    }
                } catch (error) {
                    this.updateStatus('ç½‘ç»œé”™è¯¯', 'danger');
                    showToast('error', 'ç½‘ç»œé”™è¯¯', 'æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨');
                    console.error('è·å–ç«å½©æ•°æ®å¤±è´¥:', error);
                } finally {
                    this.showLoading(false);
                }
            }
            
            async loadResultsData() {
                const button = document.getElementById('view-results');
                const originalText = button.innerHTML;
                
                try {
                    // ä¿å­˜æŒ‰é’®çŠ¶æ€å¹¶æ˜¾ç¤ºä¸­æ–­æŒ‰é’®
                    this._resultsButtonState = { originalText };
                    button.disabled = true;
                    button.innerHTML = '<i class="bi bi-hourglass-split"></i> æ‰§è¡Œä¸­...';
                    this.showInterruptButton(true);
                    
                this.showLoading(true);
                    this.updateStatus('æ­£åœ¨æŠ“å–èµ›æœ...', 'warning');
                    
                } catch (error) {
                    console.error('å‡†å¤‡è·å–èµ›æœå¤±è´¥:', error);
                }
                
                try {
                    // å…ˆè°ƒç”¨æ‰‹åŠ¨èµ›æœæŠ“å–API
                    const updateResponse = await fetch('/api/lottery/update-results', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    const updateResult = await updateResponse.json();
                    
                    if (updateResult.status === 'success') {
                        this.updateStatus('èµ›æœæŠ“å–å®Œæˆï¼Œæ­£åœ¨åŠ è½½æ•°æ®...', 'info');
                        
                        // ç„¶åè·å–å·²ç»“æŸçš„æ¯”èµ›ï¼ˆåŒ…å«é¢„æµ‹å’Œèµ›æœï¼‰
                        const response = await fetch('/api/lottery/completed-matches?days_back=7');
                    const result = await response.json();
                    
                        if (result.status === 'success') {
                            // ä¿å­˜æ‰€æœ‰èµ›æœæ•°æ®
                            this.allResultsData = result.data;
                            
                            // æ¸²æŸ“æ—¥æœŸå¯¼èˆªæ 
                            this.renderResultsDateNavbar(result.data);
                            
                            // æ˜¾ç¤ºæ‰€æœ‰èµ›æœï¼ˆä¸åˆ†ç»„ï¼‰
                        this.renderResultsTable(result.data);
                            
                            this.updateStatus(`å·²åŠ è½½ ${result.count} åœºå·²ç»“æŸæ¯”èµ›`, 'success');
                            showToast('success', 'èµ›æœæ•°æ®è·å–æˆåŠŸ', `æˆåŠŸè·å– ${result.count} åœºå·²ç»“æŸæ¯”èµ›çš„é¢„æµ‹å’Œèµ›æœæ•°æ®`);
                    } else {
                            this.updateStatus('è·å–èµ›æœæ•°æ®å¤±è´¥', 'error');
                            showToast('error', 'è·å–èµ›æœæ•°æ®å¤±è´¥', result.message || 'æœªçŸ¥é”™è¯¯');
                        }
                    } else {
                        this.updateStatus('èµ›æœæŠ“å–å¤±è´¥', 'error');
                        showToast('error', 'èµ›æœæŠ“å–å¤±è´¥', updateResult.message || 'æœªçŸ¥é”™è¯¯');
                    }
                } catch (error) {
                    console.error('è·å–èµ›æœæ•°æ®å¤±è´¥:', error);
                    this.updateStatus('è·å–èµ›æœæ•°æ®å¤±è´¥', 'error');
                    showToast('error', 'è·å–èµ›æœæ•°æ®å¤±è´¥', error.message);
                } finally {
                    this.showLoading(false);
                    // æ¢å¤æŒ‰é’®çŠ¶æ€å¹¶éšè—ä¸­æ–­æŒ‰é’®
                    const button = document.getElementById('view-results');
                    if (this._resultsButtonState && button) {
                        button.disabled = false;
                        button.innerHTML = this._resultsButtonState.originalText;
                        this._resultsButtonState = null;
                    }
                    this.showInterruptButton(false);
                }
            }
            
            async loadExistingResultsOnly() {
                /** åªåŠ è½½å·²æœ‰æ•°æ®ï¼Œä¸è§¦å‘æŠ“å–ï¼ˆç”¨äºé¡µé¢åˆå§‹åŒ–ï¼‰ */
                try {
                    this.showLoading(true);
                    this.updateStatus('æ­£åœ¨åŠ è½½å·²æœ‰èµ›æœæ•°æ®...', 'info');
                    
                    // åªè·å–å·²ç»“æŸçš„æ¯”èµ›ï¼ˆåŒ…å«é¢„æµ‹å’Œèµ›æœï¼‰ï¼Œä¸è§¦å‘æŠ“å–
                    const response = await fetch('/api/lottery/completed-matches?days_back=7');
                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        // ä¿å­˜æ‰€æœ‰èµ›æœæ•°æ®
                        this.allResultsData = result.data;
                        
                        // æ¸²æŸ“æ—¥æœŸå¯¼èˆªæ 
                        this.renderResultsDateNavbar(result.data);
                        
                        // ä¸åœ¨è¿™é‡Œæ¸²æŸ“è¡¨æ ¼ï¼Œç­‰ç”¨æˆ·åˆ‡æ¢åˆ°"èµ›æœ"tabæ—¶å†æ¸²æŸ“
                        // é»˜è®¤æ˜¾ç¤ºç¬¬ä¸€ä¸ªæ—¥æœŸçš„æ•°æ®ï¼ˆå¦‚æœç”¨æˆ·å·²ç»åœ¨"èµ›æœ"tabï¼‰
                        const firstDateKey = Object.keys(this.dateGroups || {}).sort()[0];
                        if (firstDateKey) {
                            this.showResultsDateContent(firstDateKey);
                        } else {
                            // å¦‚æœæ²¡æœ‰æ—¥æœŸåˆ†ç»„ï¼Œæ¸…ç©ºè¡¨æ ¼
                            this.renderResultsTable([]);
                        }
                        
                        if (result.count > 0) {
                            this.updateStatus(`å·²åŠ è½½ ${result.count} åœºå·²ç»“æŸæ¯”èµ›`, 'success');
                        } else {
                            this.updateStatus('æš‚æ— å·²ç»“æŸçš„æ¯”èµ›æ•°æ®', 'info');
                        }
                    } else {
                        this.updateStatus('åŠ è½½èµ›æœæ•°æ®å¤±è´¥', 'error');
                    }
                } catch (error) {
                    console.error('åŠ è½½å·²æœ‰èµ›æœæ•°æ®å¤±è´¥:', error);
                    this.updateStatus('åŠ è½½æ•°æ®å¤±è´¥', 'error');
                } finally {
                    this.showLoading(false);
                }
            }
            
            showQuickPredictionProgressPanel(totalMatches) {
                // åˆ›å»ºå¿«é€Ÿé¢„æµ‹è¿›åº¦é¢æ¿HTML
                const panelHtml = `
                    <div id="quick-progress-panel" class="progress-panel">
                        <div class="progress-header">
                            <h5><i class="bi bi-lightning-fill"></i> å¿«é€Ÿé¢„æµ‹è¿›è¡Œä¸­</h5>
                            <button class="btn-close-panel" onclick="sportteryManager.minimizeQuickProgressPanel()">
                                <i class="bi bi-dash-lg"></i>
                            </button>
                        </div>
                        <div class="progress-body">
                            <div class="progress-info">
                                <div class="progress-step">
                                    <span id="quick-progress-step-text">æ­£åœ¨æ‰§è¡Œå¿«é€Ÿé¢„æµ‹...</span>
                                </div>
                                <div class="progress-matches">
                                    <span id="quick-progress-matches-text">å·²å®Œæˆ 0/${totalMatches} åœº</span>
                                </div>
                                <div class="progress-eta">
                                    <i class="bi bi-clock"></i>
                                    <span id="quick-progress-eta-text">é¢„è®¡å‰©ä½™ ${Math.ceil(totalMatches * 0.5)} åˆ†é’Ÿ</span>
                                </div>
                            </div>
                            <div class="progress-bar-container">
                                <div class="progress">
                                    <div id="quick-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-warning" 
                                         role="progressbar" style="width: 0%">0%</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // ç§»é™¤æ—§çš„å¿«é€Ÿé¢„æµ‹è¿›åº¦é¢æ¿
                const oldPanel = document.getElementById('quick-progress-panel');
                if (oldPanel) oldPanel.remove();
                
                // æ’å…¥æ–°çš„è¿›åº¦é¢æ¿
                document.body.insertAdjacentHTML('beforeend', panelHtml);
            }
            
            minimizeQuickProgressPanel() {
                const panel = document.getElementById('quick-progress-panel');
                if (panel) {
                    panel.classList.toggle('minimized');
                }
            }
            
            updateQuickPredictionProgress(current, total) {
                const progressBar = document.getElementById('quick-progress-bar');
                const matchesText = document.getElementById('quick-progress-matches-text');
                const etaText = document.getElementById('quick-progress-eta-text');
                
                if (progressBar) {
                    const percentage = Math.round((current / total) * 100);
                    progressBar.style.width = `${percentage}%`;
                    progressBar.textContent = `${percentage}%`;
                }
                
                if (matchesText) {
                    matchesText.textContent = `å·²å®Œæˆ ${current}/${total} åœº`;
                }
                
                if (etaText) {
                    const remaining = Math.max(0, total - current);
                    const estimatedMinutes = Math.ceil(remaining * 0.5);
                    etaText.textContent = `é¢„è®¡å‰©ä½™ ${estimatedMinutes} åˆ†é’Ÿ`;
                }
            }
            
            closeQuickProgressPanel() {
                const panel = document.getElementById('quick-progress-panel');
                if (panel) panel.remove();
            }
            
            async runQuickPrediction() {
                const button = document.getElementById('quick-prediction');
                const originalText = button.innerHTML;
                
                try {
                    // æ˜¾ç¤ºæ‰§è¡Œä¸­çŠ¶æ€
                    button.disabled = true;
                    button.innerHTML = '<i class="bi bi-hourglass-split"></i> æ‰§è¡Œä¸­...';
                    this.updateStatus('æ­£åœ¨å¯åŠ¨å¿«é€Ÿé¢„æµ‹...', 'warning');
                    
                    // è·å–å½“å‰é€‰ä¸­çš„æ—¥æœŸï¼Œä¿æŒåŸæ ¼å¼ï¼ˆå¯èƒ½æ˜¯MM-DDæ ¼å¼ç”¨äºgroup_dateåŒ¹é…ï¼‰
                    let targetDate = this.currentDate;
                    
                    // è°ƒç”¨åç«¯å¿«é€Ÿé¢„æµ‹APIï¼Œä¼ é€’å½“å‰é€‰ä¸­çš„æ—¥æœŸ
                    const response = await fetch('/api/lottery/trigger-quick-predictions', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            date: targetDate 
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        // è·å–ä»»åŠ¡IDå’Œä»»åŠ¡æ•°æ®
                        const taskData = data.task_data;
                        const taskId = data.task_id;
                        
                        // ä¿å­˜å½“å‰ä»»åŠ¡IDå¹¶æ˜¾ç¤ºä¸­æ–­æŒ‰é’®
                        this.currentTaskId = taskId;
                        this.showInterruptButton(true);
                        
                        // æ˜¾ç¤ºå¿«é€Ÿé¢„æµ‹è¿›åº¦é¢æ¿
                        this.showQuickPredictionProgressPanel(data.total_matches);
                        
                        // ä¿å­˜æŒ‰é’®çŠ¶æ€ï¼Œç”¨äºä¸­æ–­åæ¢å¤
                        this._quickPredictionButtonState = { originalText };
                        
                        // å¼€å§‹è½®è¯¢ä»»åŠ¡çŠ¶æ€
                        this.pollQuickPredictionStatus(taskId);
                        
                    } else {
                        this.updateStatus('å¿«é€Ÿé¢„æµ‹å¤±è´¥', 'danger');
                        showToast('error', 'å¿«é€Ÿé¢„æµ‹å¤±è´¥', data.message || 'æœªçŸ¥é”™è¯¯');
                        // å¤±è´¥æ‰æ¢å¤æŒ‰é’®
                        button.disabled = false;
                        button.innerHTML = originalText;
                    }
                } catch (error) {
                    this.updateStatus('ç½‘ç»œé”™è¯¯', 'danger');
                    showToast('error', 'ç½‘ç»œé”™è¯¯', 'æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨');
                    console.error('å¿«é€Ÿé¢„æµ‹å¤±è´¥:', error);
                    // å¤±è´¥æ‰æ¢å¤æŒ‰é’®
                    button.disabled = false;
                    button.innerHTML = originalText;
                }
            }
            
            async runDeepAnalysis() {
                const button = document.getElementById('deep-analysis');
                const originalText = button.innerHTML;
                
                try {
                    // æ˜¾ç¤ºæ‰§è¡Œä¸­çŠ¶æ€
                    button.disabled = true;
                    button.innerHTML = '<i class="bi bi-hourglass-split"></i> æ‰§è¡Œä¸­...';
                    this.updateStatus('æ­£åœ¨å¯åŠ¨æ·±åº¦åˆ†æ...', 'warning');
                    
                    // è·å–å½“å‰é€‰ä¸­çš„æ—¥æœŸï¼Œè½¬æ¢ä¸ºYYYY-MM-DDæ ¼å¼
                    let targetDate = this.currentDate;
                    if (targetDate && targetDate.includes('-') && targetDate.length === 5) {
                        // å¦‚æœæ˜¯MM-DDæ ¼å¼ï¼Œè½¬æ¢ä¸ºYYYY-MM-DD
                        const currentYear = new Date().getFullYear();
                        targetDate = `${currentYear}-${targetDate}`;
                    } else if (!targetDate) {
                        targetDate = new Date().toISOString().split('T')[0];
                    }
                    
                    // è°ƒç”¨åç«¯æ·±åº¦åˆ†æAPIï¼ˆå¼‚æ­¥ä»»åŠ¡ï¼‰
                    const response = await fetch('/api/lottery/deep-analysis', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            date: targetDate
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        // ä»»åŠ¡å·²å¯åŠ¨ï¼Œæ˜¾ç¤ºè¿›åº¦é¢æ¿
                        const taskData = data.data;
                        this.showProgressPanel(taskData);
                        
                        // ä¿å­˜task_idåˆ°localStorageä»¥ä¾¿æ–­ç‚¹æ¢å¤
                        localStorage.setItem('deep_analysis_task_id', taskData.task_id);
                        localStorage.setItem('deep_analysis_task_start', taskData.started_at);
                        
                        // ä¿å­˜å½“å‰ä»»åŠ¡IDå¹¶æ˜¾ç¤ºä¸­æ–­æŒ‰é’®
                        this.currentTaskId = taskData.task_id;
                        this.showInterruptButton(true);
                        
                        // å¼€å§‹è½®è¯¢ä»»åŠ¡çŠ¶æ€
                        this.pollTaskStatus(taskData.task_id);
                        
                        // åœ¨ä»»åŠ¡è¿è¡ŒæœŸé—´ä¿æŒæŒ‰é’®ç¦ç”¨ä¸æ–‡æ¡ˆ
                        this._deepAnalysisButtonState = { originalText };
                    } else {
                        this.updateStatus('æ·±åº¦åˆ†æå¤±è´¥', 'danger');
                        showToast('error', 'æ·±åº¦åˆ†æå¤±è´¥', data.message || 'æœªçŸ¥é”™è¯¯');
                        // å¤±è´¥æ‰æ¢å¤æŒ‰é’®
                        button.disabled = false;
                        button.innerHTML = originalText;
                    }
                } catch (error) {
                    this.updateStatus('ç½‘ç»œé”™è¯¯', 'danger');
                    showToast('error', 'ç½‘ç»œé”™è¯¯', 'æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨');
                    console.error('æ·±åº¦åˆ†æå¤±è´¥:', error);
                    // å‡ºé”™æ¢å¤æŒ‰é’®
                    button.disabled = false;
                    button.innerHTML = originalText;
                }
            }
            
            showProgressPanel(taskData) {
                // åˆ›å»ºè¿›åº¦é¢æ¿HTML
                const panelHtml = `
                    <div id="progress-panel" class="progress-panel">
                        <div class="progress-header">
                            <h5><i class="bi bi-gear-fill"></i> æ·±åº¦åˆ†æè¿›è¡Œä¸­</h5>
                            <button class="btn-close-panel" onclick="app.minimizeProgressPanel()">
                                <i class="bi bi-dash-lg"></i>
                            </button>
                        </div>
                        <div class="progress-body">
                            <div class="progress-info">
                                <div class="progress-step">
                                    <span id="progress-step-text">æ­£åœ¨é€‰æ‹©æ¯”èµ›...</span>
                                </div>
                                <div class="progress-matches">
                                    <span id="progress-matches-text">å·²å®Œæˆ 0/${taskData.total_matches} åœº</span>
                                </div>
                                <div class="progress-eta">
                                    <i class="bi bi-clock"></i>
                                    <span id="progress-eta-text">é¢„è®¡å‰©ä½™ ${Math.ceil((taskData.estimated_seconds || 0) / 60)} åˆ†é’Ÿ</span>
                                </div>
                            </div>
                            <div class="progress-bar-container">
                                <div class="progress">
                                    <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                         role="progressbar" style="width: 0%">0%</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // ç§»é™¤æ—§çš„è¿›åº¦é¢æ¿
                const oldPanel = document.getElementById('progress-panel');
                if (oldPanel) oldPanel.remove();
                
                // æ’å…¥æ–°çš„è¿›åº¦é¢æ¿
                document.body.insertAdjacentHTML('beforeend', panelHtml);
            }
            
            minimizeProgressPanel() {
                const panel = document.getElementById('progress-panel');
                if (panel) {
                    panel.classList.toggle('minimized');
                }
            }
            
            async pollTaskStatus(taskId) {
                const pollInterval = 2000; // æ¯2ç§’è½®è¯¢ä¸€æ¬¡
                
                const poll = async () => {
                    try {
                        const response = await fetch(`/api/lottery/deep-analysis/status/${taskId}`);
                        const data = await response.json();
                        
                        if (data.status === 'success') {
                            const task = data.data;
                            
                            // æ›´æ–°è¿›åº¦æ˜¾ç¤º
                            this.updateProgressPanel(task);
                            
                            // æ£€æŸ¥ä»»åŠ¡æ˜¯å¦å®Œæˆ
                            if (task.status === 'completed') {
                                // ä»»åŠ¡å®Œæˆ
                                this.onTaskCompleted(task);
                                return;
                            } else if (task.status === 'failed') {
                                // ä»»åŠ¡å¤±è´¥
                                this.onTaskFailed(task);
                                return;
                            } else if (task.status === 'interrupted') {
                                // ä»»åŠ¡è¢«ä¸­æ–­
                                this.onTaskInterrupted(task);
                                return;
                            }
                            
                            // ç»§ç»­è½®è¯¢
                            setTimeout(poll, pollInterval);
                        } else {
                            // ä»»åŠ¡ä¸å­˜åœ¨ï¼Œåœæ­¢è½®è¯¢
                            this.closeProgressPanel();
                        }
                    } catch (error) {
                        console.error('è½®è¯¢ä»»åŠ¡çŠ¶æ€å¤±è´¥:', error);
                        // ç»§ç»­è½®è¯¢
                        setTimeout(poll, pollInterval);
                    }
                };
                
                // å¼€å§‹è½®è¯¢
                poll();
            }
            
            async pollQuickPredictionStatus(taskId) {
                const pollInterval = 2000; // æ¯2ç§’è½®è¯¢ä¸€æ¬¡
                
                const poll = async () => {
                    try {
                        const response = await fetch(`/api/lottery/deep-analysis/status/${taskId}`);
                        const data = await response.json();
                        
                        if (data.status === 'success') {
                            const task = data.data;
                            
                            // æ›´æ–°å¿«é€Ÿé¢„æµ‹è¿›åº¦æ˜¾ç¤º
                            this.updateQuickPredictionProgressPanel(task);
                            
                            // æ£€æŸ¥ä»»åŠ¡æ˜¯å¦å®Œæˆ
                            if (task.status === 'completed') {
                                // ä»»åŠ¡å®Œæˆ
                                this.onQuickPredictionCompleted(task);
                                return;
                            } else if (task.status === 'failed') {
                                // ä»»åŠ¡å¤±è´¥
                                this.onQuickPredictionFailed(task);
                                return;
                            } else if (task.status === 'interrupted') {
                                // ä»»åŠ¡è¢«ä¸­æ–­
                                this.onQuickPredictionInterrupted(task);
                                return;
                            }
                            
                            // ç»§ç»­è½®è¯¢
                            setTimeout(poll, pollInterval);
                        } else {
                            // ä»»åŠ¡ä¸å­˜åœ¨ï¼Œåœæ­¢è½®è¯¢
                            this.closeQuickProgressPanel();
                        }
                    } catch (error) {
                        console.error('è½®è¯¢å¿«é€Ÿé¢„æµ‹ä»»åŠ¡çŠ¶æ€å¤±è´¥:', error);
                        // ç»§ç»­è½®è¯¢
                        setTimeout(poll, pollInterval);
                    }
                };
                
                // å¼€å§‹è½®è¯¢
                poll();
            }
            
            updateProgressPanel(task) {
                const progressBar = document.getElementById('progress-bar');
                const stepText = document.getElementById('progress-step-text');
                const matchesText = document.getElementById('progress-matches-text');
                const etaText = document.getElementById('progress-eta-text');
                
                if (!progressBar) return;
                
                // è®¡ç®—è¿›åº¦ç™¾åˆ†æ¯”
                const progress = task.total_matches > 0 
                    ? Math.round((task.completed_matches / task.total_matches) * 100)
                    : 0;
                
                // æ›´æ–°è¿›åº¦æ¡
                progressBar.style.width = `${progress}%`;
                progressBar.textContent = `${progress}%`;
                
                // æ›´æ–°æ­¥éª¤æ–‡æœ¬
                let stepDesc = 'æ­£åœ¨å¤„ç†...';
                if (task.current_step === 'select') stepDesc = 'æ­£åœ¨é€‰æ‹©æ¯”èµ›...';
                else if (task.current_step === 'collect') stepDesc = `æ­£åœ¨æœé›†èµ„æ–™: ${task.current_match || ''}`;
                else if (task.current_step === 'generate') stepDesc = `æ­£åœ¨ç”Ÿæˆæ–‡ç« : ${task.current_match || ''}`;
                stepText.textContent = stepDesc;
                
                // æ›´æ–°å·²å®Œæˆæ•°
                matchesText.textContent = `å·²å®Œæˆ ${task.completed_matches}/${task.total_matches} åœº`;
                
                // æ›´æ–°å‰©ä½™æ—¶é—´ï¼ˆåªæ˜¾ç¤ºåˆ†é’Ÿï¼‰
                if (task.remaining_seconds !== undefined) {
                    const minutes = Math.max(0, Math.ceil(task.remaining_seconds / 60));
                    etaText.textContent = `é¢„è®¡å‰©ä½™ ${minutes} åˆ†é’Ÿ`;
                }

                // è‹¥ä»»åŠ¡ç»“æŸï¼Œåˆ™æ¢å¤æŒ‰é’®
                if (task.status === 'completed' || task.status === 'failed') {
                    const button = document.getElementById('deep-analysis');
                    if (button && this._deepAnalysisButtonState) {
                        button.disabled = false;
                        button.innerHTML = this._deepAnalysisButtonState.originalText;
                        this._deepAnalysisButtonState = null;
                    }
                }
            }
            
            formatTime(seconds) {
                // å¤„ç†æ— æ•ˆæˆ–è´Ÿæ•°æ—¶é—´
                if (!seconds || seconds < 0 || isNaN(seconds)) {
                    return '0ç§’';
                }
                
                if (seconds < 60) {
                    return `${Math.floor(seconds)}ç§’`;
                } else {
                    const minutes = Math.floor(seconds / 60);
                    const secs = Math.floor(seconds % 60);
                    return `${minutes}åˆ†${secs}ç§’`;
                }
            }
            
            onTaskCompleted(task) {
                this.closeProgressPanel();
                this.updateStatus('æ·±åº¦åˆ†æå®Œæˆ', 'success');
                
                // éšè—ä¸­æ–­æŒ‰é’®
                this.showInterruptButton(false);
                this.currentTaskId = null;
                
                // æ¸…é™¤localStorage
                localStorage.removeItem('deep_analysis_task_id');
                localStorage.removeItem('deep_analysis_task_start');
                
                // æ¢å¤æŒ‰é’®
                const button = document.getElementById('deep-analysis');
                if (button && this._deepAnalysisButtonState) {
                    button.disabled = false;
                    button.innerHTML = this._deepAnalysisButtonState.originalText;
                    this._deepAnalysisButtonState = null;
                }
                
                // ç»Ÿè®¡æˆåŠŸ/å¤±è´¥æ•°
                const successCount = task.results.filter(r => r.status === 'success').length;
                const failedCount = task.results.filter(r => r.status === 'failed').length;
                
                // åˆ·æ–°èµ›ç¨‹æ•°æ®ä»¥æ˜¾ç¤ºæ·±åº¦åˆ†ææŒ‰é’®ï¼Œæ·»åŠ å»¶è¿Ÿç¡®ä¿çŠ¶æ€æ›´æ–°
                setTimeout(async () => {
                    try {
                        console.log('å¼€å§‹åˆ·æ–°èµ›ç¨‹æ•°æ®ä»¥æ›´æ–°æŒ‰é’®çŠ¶æ€...');
                        
                        // å¤šæ¬¡å°è¯•åˆ·æ–°æ•°æ®ï¼Œç¡®ä¿çŠ¶æ€æ›´æ–°
                        let retryCount = 0;
                        const maxRetries = 3;
                        let refreshSuccess = false;
                        
                        while (retryCount < maxRetries && !refreshSuccess) {
                            try {
                                console.log(`ç¬¬ ${retryCount + 1} æ¬¡å°è¯•åˆ·æ–°æ•°æ®...`);
                                await this.refreshMatchesData();
                                refreshSuccess = true;
                                console.log('æ•°æ®åˆ·æ–°æˆåŠŸ');
                            } catch (refreshError) {
                                retryCount++;
                                console.warn(`ç¬¬ ${retryCount} æ¬¡åˆ·æ–°å¤±è´¥:`, refreshError);
                                if (retryCount < maxRetries) {
                                    console.log(`ç­‰å¾… 500ms åé‡è¯•...`);
                                    await new Promise(resolve => setTimeout(resolve, 500));
                                }
                            }
                        }
                        
                        if (!refreshSuccess) {
                            console.error('å¤šæ¬¡åˆ·æ–°æ•°æ®å¤±è´¥ï¼Œä½¿ç”¨å½“å‰æ•°æ®');
                        }
                        
                        // éªŒè¯çŠ¶æ€æ›´æ–°æ˜¯å¦æˆåŠŸ
                        const matches = this.currentData?.matches || [];
                        const deepAnalysisMatches = matches.filter(match => match.source_type === 'deep');
                        console.log(`çŠ¶æ€æ›´æ–°éªŒè¯: æ‰¾åˆ° ${deepAnalysisMatches.length} ä¸ªæ·±åº¦åˆ†ææ¯”èµ›`);
                        
                        deepAnalysisMatches.forEach(match => {
                            console.log(`æ¯”èµ› ${match.match_code}: source_type=${match.source_type}, prediction_type=${match.prediction_type}`);
                        });
                        
                        // é¢å¤–éªŒè¯ï¼šæ£€æŸ¥æŒ‰é’®çŠ¶æ€æ˜¯å¦æ­£ç¡®æ›´æ–°
                        const waitingButtons = document.querySelectorAll('button[title="ç­‰å¾…æ·±åº¦åˆ†æ"]');
                        const deepAnalysisButtons = document.querySelectorAll('button[title="ç‚¹å‡»æŸ¥çœ‹æ–‡ç« "]');
                        console.log(`æŒ‰é’®çŠ¶æ€éªŒè¯: ç­‰å¾…åˆ†ææŒ‰é’® ${waitingButtons.length} ä¸ªï¼Œæ·±åº¦åˆ†ææŒ‰é’® ${deepAnalysisButtons.length} ä¸ª`);
                        
                        // æ˜¾ç¤ºå®Œæˆå¼¹çª—ï¼ŒåŒ…å«æŸ¥çœ‹æ–‡ç« å…¥å£
                        const message = `æˆåŠŸç”Ÿæˆ ${successCount} ç¯‡æ–‡ç« ${failedCount > 0 ? `ï¼Œ${failedCount} ç¯‡å¤±è´¥` : ''}`;
                        
                        // åˆ›å»ºå¸¦"æŸ¥çœ‹æ–‡ç« "æŒ‰é’®çš„è‡ªå®šä¹‰å¼¹çª—
                        this.showCompletionModal(successCount, failedCount, task.results);
                    } catch (error) {
                        console.error('åˆ·æ–°èµ›ç¨‹æ•°æ®å¤±è´¥:', error);
                        // å³ä½¿åˆ·æ–°å¤±è´¥ä¹Ÿæ˜¾ç¤ºå®Œæˆå¼¹çª—
                        this.showCompletionModal(successCount, failedCount, task.results);
                    }
                }, 1000);
            }
            
            onTaskFailed(task) {
                this.closeProgressPanel();
                this.updateStatus('æ·±åº¦åˆ†æå¤±è´¥', 'danger');
                
                // éšè—ä¸­æ–­æŒ‰é’®
                this.showInterruptButton(false);
                this.currentTaskId = null;
                
                // æ¸…é™¤localStorage
                localStorage.removeItem('deep_analysis_task_id');
                localStorage.removeItem('deep_analysis_task_start');
                
                showToast('error', 'æ·±åº¦åˆ†æå¤±è´¥', task.error || 'æœªçŸ¥é”™è¯¯');
            }
            
            onTaskInterrupted(task) {
                this.closeProgressPanel();
                this.updateStatus('æ·±åº¦åˆ†æå·²ä¸­æ–­', 'warning');
                
                // éšè—ä¸­æ–­æŒ‰é’®
                this.showInterruptButton(false);
                this.currentTaskId = null;
                
                // æ¸…é™¤localStorage
                localStorage.removeItem('deep_analysis_task_id');
                localStorage.removeItem('deep_analysis_task_start');
                
                // æ¢å¤æŒ‰é’®
                const button = document.getElementById('deep-analysis');
                if (button && this._deepAnalysisButtonState) {
                    button.disabled = false;
                    button.innerHTML = this._deepAnalysisButtonState.originalText;
                    this._deepAnalysisButtonState = null;
                }
                
                showToast('warning', 'ä»»åŠ¡å·²ä¸­æ–­', 'æ·±åº¦åˆ†æä»»åŠ¡å·²è¢«ç”¨æˆ·ä¸­æ–­');
            }
            
            updateQuickPredictionProgressPanel(task) {
                const progressBar = document.getElementById('quick-progress-bar');
                const matchesText = document.getElementById('quick-progress-matches-text');
                const etaText = document.getElementById('quick-progress-eta-text');
                
                if (!progressBar) return;
                
                // è®¡ç®—è¿›åº¦ç™¾åˆ†æ¯”
                const progress = task.total_matches > 0 
                    ? Math.round((task.completed_matches / task.total_matches) * 100)
                    : 0;
                
                // æ›´æ–°è¿›åº¦æ¡
                progressBar.style.width = `${progress}%`;
                progressBar.setAttribute('aria-valuenow', progress);
                progressBar.textContent = `${progress}%`;
                
                if (matchesText) {
                    matchesText.textContent = `å·²å®Œæˆ ${task.completed_matches}/${task.total_matches} åœº`;
                }
                
                if (etaText && task.remaining_seconds) {
                    etaText.textContent = `é¢„è®¡å‰©ä½™ ${this.formatTime(task.remaining_seconds)}`;
                }
            }
            
            onQuickPredictionCompleted(task) {
                this.closeQuickProgressPanel();
                
                // éšè—ä¸­æ–­æŒ‰é’®
                this.showInterruptButton(false);
                this.currentTaskId = null;
                
                // è·å–æˆåŠŸç»Ÿè®¡
                const successCount = task.success_count || 0;
                const totalMatches = task.total_matches || 0;
                
                this.updateStatus(`å¿«é€Ÿé¢„æµ‹å®Œæˆï¼ŒæˆåŠŸé¢„æµ‹ ${successCount}/${totalMatches} åœºæ¯”èµ›`, 'success');
                showToast('success', 'å¿«é€Ÿé¢„æµ‹å®Œæˆ', `${successCount}/${totalMatches} åœºæ¯”èµ›é¢„æµ‹å®Œæˆ`);
                
                // æ¢å¤æŒ‰é’®
                const button = document.getElementById('quick-prediction');
                if (button && this._quickPredictionButtonState) {
                    button.disabled = false;
                    button.innerHTML = this._quickPredictionButtonState.originalText;
                    this._quickPredictionButtonState = null;
                }
                
                // åˆ·æ–°æ•°æ®ä»¥æ˜¾ç¤ºé¢„æµ‹ç»“æœ
                this.refreshMatchesData();
            }
            
            onQuickPredictionFailed(task) {
                this.closeQuickProgressPanel();
                
                // éšè—ä¸­æ–­æŒ‰é’®
                this.showInterruptButton(false);
                this.currentTaskId = null;
                
                this.updateStatus('å¿«é€Ÿé¢„æµ‹å¤±è´¥', 'danger');
                showToast('error', 'å¿«é€Ÿé¢„æµ‹å¤±è´¥', task.error || 'æœªçŸ¥é”™è¯¯');
                
                // æ¢å¤æŒ‰é’®
                const button = document.getElementById('quick-prediction');
                if (button && this._quickPredictionButtonState) {
                    button.disabled = false;
                    button.innerHTML = this._quickPredictionButtonState.originalText;
                    this._quickPredictionButtonState = null;
                }
            }
            
            onQuickPredictionInterrupted(task) {
                this.closeQuickProgressPanel();
                
                // éšè—ä¸­æ–­æŒ‰é’®
                this.showInterruptButton(false);
                this.currentTaskId = null;
                
                this.updateStatus('å¿«é€Ÿé¢„æµ‹å·²ä¸­æ–­', 'warning');
                showToast('warning', 'ä»»åŠ¡å·²ä¸­æ–­', 'å¿«é€Ÿé¢„æµ‹ä»»åŠ¡å·²è¢«ç”¨æˆ·ä¸­æ–­');
                
                // æ¢å¤æŒ‰é’®
                const button = document.getElementById('quick-prediction');
                if (button && this._quickPredictionButtonState) {
                    button.disabled = false;
                    button.innerHTML = this._quickPredictionButtonState.originalText;
                    this._quickPredictionButtonState = null;
                }
            }
            
            closeProgressPanel() {
                const panel = document.getElementById('progress-panel');
                if (panel) panel.remove();
            }
            
            showInterruptButton(show) {
                const interruptBtn = document.getElementById('interrupt-task-btn');
                if (interruptBtn) {
                    interruptBtn.style.display = show ? 'block' : 'none';
                }
            }
            
            async interruptCurrentTask() {
                try {
                    // ç¡®è®¤ä¸­æ–­æ“ä½œ
                    if (!confirm('ç¡®å®šè¦ä¸­æ–­æ‰€æœ‰æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡å—ï¼Ÿ')) {
                        return;
                    }
                    
                    console.log('å°è¯•ä¸­æ–­æ‰€æœ‰ä»»åŠ¡');
                    
                    // è°ƒç”¨å…¨å±€ä¸­æ–­API
                    const response = await fetch('/api/lottery/interrupt-all-tasks', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    console.log(`å…¨å±€ä¸­æ–­APIå“åº”çŠ¶æ€: ${response.status}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    console.log('å…¨å±€ä¸­æ–­APIå“åº”æ•°æ®:', data);
                    
                    if (data.status === 'success') {
                        showToast('success', 'ä»»åŠ¡å·²ä¸­æ–­', data.message);
                        
                        // ç«‹å³éšè—ä¸­æ–­æŒ‰é’®
                        this.showInterruptButton(false);
                        this.currentTaskId = null;
                        
                        // å…³é—­æ‰€æœ‰è¿›åº¦é¢æ¿
                        this.closeProgressPanel();
                        this.closeQuickProgressPanel();
                        
                        // æ¢å¤æ‰€æœ‰æŒ‰é’®çŠ¶æ€
                        this.restoreAllButtonStates();
                        
                        // æ›´æ–°çŠ¶æ€
                        this.updateStatus('æ‰€æœ‰ä»»åŠ¡å·²ä¸­æ–­', 'warning');
                    } else {
                        console.error('å…¨å±€ä¸­æ–­å¤±è´¥å“åº”:', data);
                        showToast('error', 'ä¸­æ–­å¤±è´¥', data.message || 'æ— æ³•ä¸­æ–­ä»»åŠ¡ï¼Œè¯·æ£€æŸ¥ä»»åŠ¡çŠ¶æ€');
                    }
                } catch (error) {
                    console.error('å…¨å±€ä¸­æ–­ä»»åŠ¡å¤±è´¥:', error);
                    showToast('error', 'ç½‘ç»œé”™è¯¯', `ä¸­æ–­å¤±è´¥: ${error.message}`);
                }
            }
            
            // æ–°å¢æ–¹æ³•ï¼šæ¢å¤æ‰€æœ‰æŒ‰é’®çŠ¶æ€
            restoreAllButtonStates() {
                // æ¢å¤æ·±åº¦åˆ†ææŒ‰é’®çŠ¶æ€
                const deepAnalysisButton = document.getElementById('deep-analysis');
                if (deepAnalysisButton && this._deepAnalysisButtonState) {
                    deepAnalysisButton.disabled = false;
                    deepAnalysisButton.innerHTML = this._deepAnalysisButtonState.originalText;
                    this._deepAnalysisButtonState = null;
                }
                
                // æ¢å¤å¿«é€Ÿé¢„æµ‹æŒ‰é’®çŠ¶æ€
                const quickPredictionButton = document.getElementById('quick-prediction');
                if (quickPredictionButton && this._quickPredictionButtonState) {
                    quickPredictionButton.disabled = false;
                    quickPredictionButton.innerHTML = this._quickPredictionButtonState.originalText;
                    this._quickPredictionButtonState = null;
                }
                
                // æ¢å¤èµ›ç¨‹æ›´æ–°æŒ‰é’®çŠ¶æ€
                const refreshButton = document.getElementById('refresh-sporttery-data');
                if (refreshButton && this._refreshButtonState) {
                    refreshButton.disabled = false;
                    refreshButton.innerHTML = this._refreshButtonState.originalText;
                    this._refreshButtonState = null;
                }
                
                // æ¢å¤èµ›æœæ›´æ–°æŒ‰é’®çŠ¶æ€
                const resultsButton = document.getElementById('view-results');
                if (resultsButton && this._resultsButtonState) {
                    resultsButton.disabled = false;
                    resultsButton.innerHTML = this._resultsButtonState.originalText;
                    this._resultsButtonState = null;
                }
                
                // æ¢å¤ä¸€é”®è§¦å‘æŒ‰é’®çŠ¶æ€
                const workflowButton = document.getElementById('run-all-workflow');
                if (workflowButton && this._workflowButtonState) {
                    workflowButton.disabled = false;
                    workflowButton.innerHTML = this._workflowButtonState.originalText;
                    this._workflowButtonState = null;
                }
            }
            
            async checkRunningTasks() {
                try {
                    // ä½¿ç”¨å…¨å±€APIæ£€æŸ¥æ‰€æœ‰è¿è¡Œä¸­çš„ä»»åŠ¡
                    const response = await fetch('/api/lottery/all-running-tasks');
                    const data = await response.json();
                    
                    if (data.status === 'success' && data.data.has_running_tasks) {
                        // æœ‰è¿è¡Œä¸­çš„ä»»åŠ¡ï¼Œæ˜¾ç¤ºä¸­æ–­æŒ‰é’®
                        this.showInterruptButton(true);
                        
                        // è·å–ç¬¬ä¸€ä¸ªä»»åŠ¡IDï¼ˆç”¨äºçŠ¶æ€è½®è¯¢ï¼‰
                        const allTasks = data.data.all_running_tasks;
                        if (allTasks.length > 0) {
                            this.currentTaskId = allTasks[0].task_id;
                            
                            // å¦‚æœæ˜¯æ·±åº¦åˆ†ææˆ–å¿«é€Ÿé¢„æµ‹ä»»åŠ¡ï¼Œå¼€å§‹è½®è¯¢çŠ¶æ€
                            if (allTasks[0].source === 'task_manager') {
                                this.pollTaskStatus(allTasks[0].task_id);
                            }
                        }
                        
                        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                        const taskTypes = [...new Set(allTasks.map(t => t.task_type))];
                        this.updateStatus(`æ£€æµ‹åˆ°è¿è¡Œä¸­çš„ä»»åŠ¡: ${taskTypes.join(', ')}`, 'warning');
                        
                        console.log(`æ£€æµ‹åˆ°è¿è¡Œä¸­çš„ä»»åŠ¡:`, allTasks);
                    } else {
                        // æ²¡æœ‰è¿è¡Œä¸­çš„ä»»åŠ¡ï¼Œç¡®ä¿ä¸­æ–­æŒ‰é’®éšè—
                        this.showInterruptButton(false);
                        this.currentTaskId = null;
                        
                        // æ¸…ç†localStorageä¸­çš„ä»»åŠ¡è®°å½•
                        localStorage.removeItem('deep_analysis_task_id');
                        localStorage.removeItem('deep_analysis_task_start');
                    }
                } catch (error) {
                    console.error('æ£€æŸ¥è¿è¡Œä¸­ä»»åŠ¡å¤±è´¥:', error);
                    // å‡ºé”™æ—¶ä¹Ÿéšè—ä¸­æ–­æŒ‰é’®
                    this.showInterruptButton(false);
                    this.currentTaskId = null;
                }
            }
            
            showCompletionModal(successCount, failedCount, results) {
                const modalHtml = `
                    <div class="modal fade" id="completionModal" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header bg-success text-white">
                                    <h5 class="modal-title"><i class="bi bi-check-circle"></i> æ·±åº¦åˆ†æå®Œæˆ</h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <p class="mb-3">
                                        <strong>æˆåŠŸç”Ÿæˆ ${successCount} ç¯‡æ·±åº¦åˆ†ææ–‡ç« </strong>
                                        ${failedCount > 0 ? `<br><span class="text-warning">${failedCount} ç¯‡ç”Ÿæˆå¤±è´¥</span>` : ''}
                                    </p>
                                    <div class="list-group">
                                        ${results.map(r => `
                                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                                <div>
                                                    <span class="${r.status === 'success' ? 'text-success' : 'text-danger'}">
                                                        <i class="bi bi-${r.status === 'success' ? 'check-circle' : 'x-circle'}"></i>
                                                        ${r.match_code}
                                                    </span>
                                                    ${r.status === 'failed' ? `<br><small class="text-muted">${r.error}</small>` : ''}
                                                </div>
                                                ${r.status === 'success' ? `
                                                <button type="button" class="btn btn-sm btn-primary" onclick="sportteryManager.viewArticleInWorkbench('${r.match_code}')">
                                                    <i class="bi bi-file-text"></i> æŸ¥çœ‹æ–‡ç« 
                                                </button>` : ''}
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // ç§»é™¤æ—§çš„modal
                const oldModal = document.getElementById('completionModal');
                if (oldModal) oldModal.remove();
                
                // æ’å…¥æ–°modal
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
                // æ˜¾ç¤ºmodal
                const modal = new bootstrap.Modal(document.getElementById('completionModal'));
                modal.show();
            }
            
            viewGeneratedArticles() {
                // è·³è½¬åˆ°æ–‡ç« å·¥ä½œå°
                window.location.hash = '#editor';
                
                // å…³é—­modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('completionModal'));
                if (modal) modal.hide();
                
                // åˆ‡æ¢åˆ°æ–‡ç« å·¥ä½œå°tabå¹¶æ»šåŠ¨
                setTimeout(() => {
                    const articleTab = document.querySelector('a[href="#editor"]');
                    if (articleTab) articleTab.click();
                    const container = document.querySelector('#article-workspace, #editor, [data-section="editor"]');
                    if (container && container.scrollIntoView) {
                        container.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }, 150);
            }
            
            // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æ˜¯å¦æœ‰æœªå®Œæˆçš„ä»»åŠ¡
            checkPendingTask() {
                const taskId = localStorage.getItem('deep_analysis_task_id');
                if (taskId) {
                    // æ¢å¤è¿›åº¦é¢æ¿
                    const taskStart = localStorage.getItem('deep_analysis_task_start');
                    this.showProgressPanel({
                        task_id: taskId,
                        started_at: taskStart,
                        estimated_seconds: 330,
                        total_matches: 3
                    });
                    
                    // ç»§ç»­è½®è¯¢
                    this.pollTaskStatus(taskId);
                }
            }
            
            renderMatchesTable(matches) {
                if (!matches || matches.length === 0) {
                    this.renderEmptyMatches();
                    return;
                }
                
                // æ¸²æŸ“å‰å†æ¬¡å°è¯•åˆå¹¶æ–‡ç« çŠ¶æ€ï¼Œé¿å…æ¼æ‰
                if (Array.isArray(matches) && !matches.__articleStatusMerged) {
                    this.mergeArticleStatus(matches).catch(()=>{});
                }
                
                // æŒ‰æ—¥æœŸåˆ†ç»„æ¯”èµ›æ•°æ®
                const groupedMatches = this.groupMatchesByDate(matches);
                const sortedDates = Object.keys(groupedMatches).sort();
                
                // æ˜¾ç¤ºæ—¥æœŸå¯¼èˆªæ 
                this.renderDateNavbar(sortedDates);
                
                // æ¸²æŸ“æ¯ä¸ªæ—¥æœŸçš„å†…å®¹
                this.renderDateContents(groupedMatches, sortedDates);
                
                // é»˜è®¤æ˜¾ç¤ºç¬¬ä¸€ä¸ªæ—¥æœŸ
                if (sortedDates.length > 0) {
                    this.showDateContent(sortedDates[0]);
                }
            }
            
            groupMatchesByDate(matches) {
                const grouped = {};
                
                matches.forEach(match => {
                    // ä¼˜å…ˆä½¿ç”¨ç«å½©ç½‘çš„åˆ†ç»„æ—¥æœŸï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨æ¯”èµ›æ—¶é—´
                    let dateKey = 'æœªçŸ¥æ—¥æœŸ';
                    
                    // é¦–å…ˆå°è¯•ä½¿ç”¨group_dateï¼ˆç«å½©ç½‘çš„åˆ†ç»„æ—¥æœŸï¼‰
                    if (match.group_date) {
                        try {
                            // group_dateæ ¼å¼ï¼šYYYY-MM-DD -> MM-DD
                            const datePart = match.group_date;
                            if (datePart.length >= 10) {
                                dateKey = `${datePart.slice(5, 7)}-${datePart.slice(8, 10)}`;
                                // æ·»åŠ è°ƒè¯•ä¿¡æ¯
                                console.log(`âœ… ä½¿ç”¨group_dateåˆ†ç»„: ${match.match_code} -> ${dateKey} (åŸå§‹: ${match.group_date})`);
                            }
                        } catch (e) {
                            console.warn('åˆ†ç»„æ—¥æœŸè§£æå¤±è´¥:', match.group_date);
                        }
                    }
                    
                    // å¦‚æœgroup_dateä¸å­˜åœ¨ï¼Œåˆ™ä½¿ç”¨match_timeä½œä¸ºå¤‡é€‰
                    if (dateKey === 'æœªçŸ¥æ—¥æœŸ') {
                        const matchTime = match.match_time || match.time_display || '';
                    if (matchTime) {
                        try {
                            if (matchTime.includes(' ')) {
                                const datePart = matchTime.split(' ')[0];
                                if (datePart.length >= 10) {
                                        // æ­£ç¡®æå–æœˆæ—¥ï¼šYYYY-MM-DD -> MM-DD
                                    dateKey = `${datePart.slice(5, 7)}-${datePart.slice(8, 10)}`;
                                        console.log(`âš ï¸ ä½¿ç”¨match_timeåˆ†ç»„: ${match.match_code} -> ${dateKey} (åŸå§‹: ${matchTime})`);
                                }
                                } else if (matchTime.includes('-') && matchTime.length >= 5) {
                                    // å¤„ç†å·²ç»æ˜¯ MM-DD æ ¼å¼çš„æƒ…å†µ
                                    dateKey = matchTime;
                                    console.log(`âš ï¸ ä½¿ç”¨match_timeåˆ†ç»„(MM-DD): ${match.match_code} -> ${dateKey} (åŸå§‹: ${matchTime})`);
                            }
                        } catch (e) {
                                console.warn('æ¯”èµ›æ—¶é—´è§£æå¤±è´¥:', matchTime);
                            }
                        }
                    }
                    
                    if (!grouped[dateKey]) {
                        grouped[dateKey] = [];
                    }
                    grouped[dateKey].push(match);
                });
                
                return grouped;
            }
            
            renderDateNavbar(sortedDates) {
                const navbar = document.getElementById('date-navbar');
                const navbarContainer = navbar.querySelector('.d-flex');
                
                if (sortedDates.length <= 1) {
                    navbar.style.display = 'none';
                    return;
                }
                
                navbar.style.display = 'block';
                navbarContainer.innerHTML = sortedDates.map(date => `
                    <button class="date-nav-item" onclick="sportteryManager.showDateContent('${date}')" data-date="${date}">
                        ${date}
                    </button>
                `).join('');
            }
            
            renderDateContents(groupedMatches, sortedDates) {
                const contentContainer = document.getElementById('sporttery-matches-content');
                
                // æ¸…ç©ºç°æœ‰å†…å®¹
                contentContainer.innerHTML = '';
                
                // ä¸ºæ¯ä¸ªæ—¥æœŸåˆ›å»ºå†…å®¹åŒºåŸŸ
                sortedDates.forEach(date => {
                    const matches = groupedMatches[date];
                    const dateContent = document.createElement('div');
                    dateContent.className = 'date-content';
                    dateContent.id = `date-content-${date}`;
                    
                    dateContent.innerHTML = `
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>æ¯”èµ›ç¼–å·</th>
                                        <th>è”èµ›</th>
                                        <th>å¯¹é˜µ</th>
                                        <th>å¼€èµ›æ—¶é—´</th>
                                        <th>é¢„æµ‹ç»“æœ</th>
                                        <th>å®é™…æ¯”åˆ†</th>
                                        <th>é¢„æµ‹ç±»å‹</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${matches.map(match => {
                                        const isDeepAnalysis = match.source_type === 'deep';
                                        const scores = match.scores || [];
                                        // ç¡®ä¿æ¯”åˆ†æ ¼å¼ä¸º"2-1,1-0"æ ¼å¼
                                        const formattedScores = scores.map(score => {
                                            if (typeof score === 'string') {
                                                // å¦‚æœåŒ…å«å†’å·ï¼Œè½¬æ¢ä¸ºè¿å­—ç¬¦
                                                return score.replace(':', '-');
                                            }
                                            return score;
                                        });
                                        const scoresText = formattedScores.length > 0 ? formattedScores.join(',') : 'æš‚æ— é¢„æµ‹';
                                        const actualScore = match.actual_score || '';
                                        const actualScoreDisplay = actualScore ? `<strong class="text-danger">${actualScore}</strong>` : '<span class="text-muted">æœªå½•å…¥</span>';
                                        
                                        // åªæ˜¾ç¤ºå¼€èµ›æ—¶é—´ï¼Œä¸æ˜¾ç¤ºå€’è®¡æ—¶
                                        let timeDisplay = match.time_display || match.match_time || '';
                                        
                                        return `
                                        <tr class="${isDeepAnalysis ? 'table-warning' : ''}">
                                            <td><span class="badge bg-primary">${match.match_code}</span></td>
                                            <td>${match.league_display || match.league || ''}</td>
                                            <td>
                                                <strong>${match.home_team}</strong> vs <strong>${match.away_team}</strong>
                                            </td>
                                            <td>${timeDisplay}</td>
                                            <td>
                                                <div class="prediction-info">
                                                    <div class="prediction-scores">${scoresText}</div>
                                                    ${match.source_type === 'quick' && match.reason ? 
                                                        `<div class="quick-reason-tooltip" data-bs-toggle="tooltip" data-bs-placement="top" title="${match.reason}">
                                                            <i class="bi bi-info-circle text-muted"></i>
                                                        </div>` : 
                                                        match.reason ? `<small class="text-muted">${match.reason}</small>` : ''
                                                    }
                                                </div>
                                            </td>
                                            <td>${actualScoreDisplay}</td>
                <td>
                    ${isDeepAnalysis ? `
                        <button class="btn btn-sm btn-warning" onclick="sportteryManager.viewArticleInWorkbench('${match.match_code}')" title="ç‚¹å‡»æŸ¥çœ‹æ–‡ç« ">
                            <i class="bi bi-target"></i> æ·±åº¦åˆ†æ
                        </button>
                    ` : scores.length > 0 ? `
                        <span class="badge bg-info">
                            <i class="bi bi-lightning"></i> å¿«é€Ÿé¢„æµ‹
                        </span>
                    ` : `
                        <button class="btn btn-sm btn-secondary" onclick="alert('è¯·ç‚¹å‡»ä¸Šæ–¹çš„æ·±åº¦åˆ†ææŒ‰é’®å¼€å§‹æ‰¹é‡åˆ†æ')" title="ç­‰å¾…æ·±åº¦åˆ†æ">
                            <i class="bi bi-hourglass-split"></i> ç­‰å¾…åˆ†æ
                        </button>
                    `}
                </td>
                <td>
                    <div class="d-flex gap-1">
                        <button class="btn btn-sm btn-outline-warning edit-result-btn" data-match-code="${match.match_code}" data-current-score="${actualScore}">
                            <i class="bi bi-pencil"></i> ç¼–è¾‘ç»“æœ
                        </button>
                    </div>
                </td>
                                        </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                    
                    contentContainer.appendChild(dateContent);
                });
            }
            
            showDateContent(date) {
                // éšè—æ‰€æœ‰æ—¥æœŸå†…å®¹
                document.querySelectorAll('.date-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                // æ˜¾ç¤ºé€‰ä¸­çš„æ—¥æœŸå†…å®¹
                const targetContent = document.getElementById(`date-content-${date}`);
                if (targetContent) {
                    targetContent.classList.add('active');
                }
                
                // æ›´æ–°å¯¼èˆªæ æ´»åŠ¨çŠ¶æ€
                document.querySelectorAll('.date-nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                const activeNav = document.querySelector(`[data-date="${date}"]`);
                if (activeNav) {
                    activeNav.classList.add('active');
                }
                
                // ä¿å­˜å½“å‰é€‰ä¸­çš„æ—¥æœŸ
                this.currentDate = date;
            }
            
            renderEmptyMatches() {
                const contentContainer = document.getElementById('sporttery-matches-content');
                const navbar = document.getElementById('date-navbar');
                
                navbar.style.display = 'none';
                contentContainer.innerHTML = `
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>æ¯”èµ›ç¼–å·</th>
                                    <th>è”èµ›</th>
                                    <th>å¯¹é˜µ</th>
                                    <th>æ¯”èµ›æ—¶é—´</th>
                                    <th>çŠ¶æ€</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="6" class="text-center text-muted py-4">
                                        <i class="bi bi-info-circle"></i> æš‚æ— æ¯”èµ›æ•°æ®
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            renderResultsTable(results) {
                const tbody = document.getElementById('sporttery-results-tbody');
                
                if (!results || results.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center text-muted py-4">
                                <i class="bi bi-info-circle"></i> æš‚æ— èµ›æœæ•°æ®
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                // æŒ‰æ¯”èµ›ç¼–å·æ’åºï¼ˆæ­£åºï¼š001åœ¨ä¸Šï¼Œ015åœ¨ä¸‹ï¼‰
                const sortedResults = results.sort((a, b) => {
                    // æå–æ¯”èµ›ç¼–å·ä¸­çš„æ•°å­—éƒ¨åˆ†è¿›è¡Œæ’åº
                    const getMatchNumber = (matchCode) => {
                        const match = matchCode.match(/(\d+)$/);
                        return match ? parseInt(match[1]) : 0;
                    };
                    
                    const numA = getMatchNumber(a.match_code);
                    const numB = getMatchNumber(b.match_code);
                    
                    return numA - numB; // æ­£åºæ’åº
                });
                
                // æ˜¾ç¤ºæ’åºåçš„æ¯”èµ›
                let html = sortedResults.map(result => {
                    const predictedScore = result.predicted_score || '--';
                    const actualScore = result.actual_score || '--';
                    const isHit = result.is_hit;
                    const hitStatus = isHit ? 'å‘½ä¸­' : (actualScore !== '--' ? 'æœªå‘½ä¸­' : 'å¾…ç¡®è®¤');
                    const hitClass = isHit ? 'bg-success' : (actualScore !== '--' ? 'bg-danger' : 'bg-secondary');
                    
                    return `
                    <tr>
                        <td><span class="badge bg-primary">${result.match_code}</span></td>
                            <td>${result.league || result.league_display || 'æœªçŸ¥è”èµ›'}</td>
                        <td>
                            <strong>${result.home_team}</strong> vs <strong>${result.away_team}</strong>
                        </td>
                        <td>
                                <span class="badge bg-warning">${predictedScore}</span>
                        </td>
                        <td>
                                <span class="badge bg-info">${actualScore}</span>
                        </td>
                            <td>
                                <span class="badge ${hitClass}">${hitStatus}</span>
                            </td>
                            <td>${this.formatTime(result.match_time || result.time_display)}</td>
                    </tr>
                    `;
                }).join('');
                
                tbody.innerHTML = html;
            }
            
            // æ¸²æŸ“èµ›æœæ—¥æœŸå¯¼èˆªæ 
            renderResultsDateNavbar(results) {
                const navbar = document.getElementById('results-date-navbar');
                const navbarContainer = navbar.querySelector('.d-flex');
                
                if (!results || results.length === 0) {
                    navbar.style.display = 'none';
                    return;
                }
                
                // æŒ‰å®é™…æ¯”èµ›æ—¥æœŸåˆ†ç»„ï¼ˆé¿å…match_codeå‰ç¼€å¯¼è‡´é‡å¤åˆ†ç»„ï¼‰
                const dateGroups = {};
                
                results.forEach(result => {
                    // ä¼˜å…ˆä½¿ç”¨match_timeï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨result_scraped_atæˆ–time_display
                    let timeStr = result.match_time || result.result_scraped_at || result.time_display;
                    if (timeStr) {
                        try {
                            // ä½¿ç”¨å®é™…æ—¥æœŸä½œä¸ºåˆ†ç»„é”®
                            const matchDate = new Date(timeStr);
                            // æ£€æŸ¥æ—¥æœŸæ˜¯å¦æœ‰æ•ˆ
                            if (!isNaN(matchDate.getTime())) {
                                const month = String(matchDate.getMonth() + 1).padStart(2, '0');
                                const day = String(matchDate.getDate()).padStart(2, '0');
                                const dateKey = `${month}-${day}`;
                                
                                if (!dateGroups[dateKey]) {
                                    dateGroups[dateKey] = [];
                                }
                                dateGroups[dateKey].push(result);
                            } else {
                                console.warn('æ— æ•ˆçš„æ¯”èµ›æ—¶é—´:', timeStr);
                            }
                        } catch (e) {
                            console.warn('è§£ææ¯”èµ›æ—¶é—´å¤±è´¥:', timeStr, e);
                        }
                    }
                });
                
                // è½¬æ¢ä¸ºæ˜¾ç¤ºé¡¹
                const displayItems = [];
                Object.keys(dateGroups).forEach(dateKey => {
                    const matches = dateGroups[dateKey];
                    if (matches.length > 0) {
                        displayItems.push({
                            dateKey: dateKey,
                            displayDate: dateKey,
                            matches: matches
                        });
                    }
                });
                
                // æŒ‰æ—¥æœŸå€’åºæ’åˆ—ï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
                displayItems.sort((a, b) => {
                    return b.dateKey.localeCompare(a.dateKey);
                });
                
                if (displayItems.length <= 1) {
                    navbar.style.display = 'none';
                    return;
                }
                
                navbar.style.display = 'block';
                navbarContainer.innerHTML = displayItems.map(item => `
                    <button class="date-nav-item" onclick="sportteryManager.showResultsDateContent('${item.dateKey}')" data-date="${item.dateKey}">
                        ${item.displayDate}
                    </button>
                `).join('');
            }
            
            // æ˜¾ç¤ºæŒ‡å®šæ—¥æœŸçš„èµ›æœå†…å®¹
            showResultsDateContent(dateKey) {
                // æ›´æ–°å¯¼èˆªæ æ´»åŠ¨çŠ¶æ€
                const navbar = document.getElementById('results-date-navbar');
                const buttons = navbar.querySelectorAll('.date-nav-item');
                buttons.forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.getAttribute('data-date') === dateKey) {
                        btn.classList.add('active');
                    }
                });
                
                // æŒ‰å®é™…æ¯”èµ›æ—¥æœŸè¿‡æ»¤
                if (this.allResultsData) {
                    const filteredResults = this.allResultsData.filter(result => {
                        // ä¼˜å…ˆä½¿ç”¨match_timeï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨result_scraped_atæˆ–time_display
                        let timeStr = result.match_time || result.result_scraped_at || result.time_display;
                        if (!timeStr) return false;
                        try {
                            const matchDate = new Date(timeStr);
                            if (isNaN(matchDate.getTime())) return false;
                            const month = String(matchDate.getMonth() + 1).padStart(2, '0');
                            const day = String(matchDate.getDate()).padStart(2, '0');
                            const resultDateKey = `${month}-${day}`;
                            return resultDateKey === dateKey;
                        } catch (e) {
                            return false;
                        }
                    });
                    
                    this.renderResultsTable(filteredResults);
                }
            }
            
            groupResultsByDate(results) {
                const grouped = {};
                const now = new Date();
                
                results.forEach(result => {
                    // ä»æ¯”èµ›æ—¶é—´ä¸­æå–æ—¥æœŸ
                    let date = '';
                    let matchDate = null;
                    
                    if (result.match_time) {
                        try {
                            matchDate = new Date(result.match_time);
                            // åªå¤„ç†å·²ç»“æŸçš„æ¯”èµ›ï¼ˆæ¯”èµ›æ—¶é—´åœ¨å½“å‰æ—¶é—´ä¹‹å‰ï¼‰
                            if (matchDate <= now) {
                                const month = String(matchDate.getMonth() + 1).padStart(2, '0');
                                const day = String(matchDate.getDate()).padStart(2, '0');
                                date = `${month}-${day}`;
                            }
                        } catch (e) {
                            // æ—¥æœŸè§£æå¤±è´¥ï¼Œè·³è¿‡
                            return;
                        }
                    } else if (result.time_display) {
                        // å°è¯•ä»time_displayä¸­æå–æ—¥æœŸ
                        const timeMatch = result.time_display.match(/(\d{4}-\d{2}-\d{2})/);
                        if (timeMatch) {
                            try {
                                matchDate = new Date(timeMatch[1]);
                                // åªå¤„ç†å·²ç»“æŸçš„æ¯”èµ›
                                if (matchDate <= now) {
                                    const month = String(matchDate.getMonth() + 1).padStart(2, '0');
                                    const day = String(matchDate.getDate()).padStart(2, '0');
                                    date = `${month}-${day}`;
                                }
                            } catch (e) {
                                // æ—¥æœŸè§£æå¤±è´¥ï¼Œè·³è¿‡
                                return;
                            }
                        }
                    }
                    
                    // åªå¤„ç†æœ‰æ•ˆçš„è¿‡å»æ—¥æœŸ
                    if (date && date !== 'æœªçŸ¥æ—¥æœŸ') {
                        if (!grouped[date]) {
                            grouped[date] = [];
                        }
                        grouped[date].push(result);
                    }
                });
                
                // æŒ‰æ—¥æœŸæ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
                const sortedDates = Object.keys(grouped).sort((a, b) => {
                    return new Date(b) - new Date(a);
                });
                
                const sortedGrouped = {};
                sortedDates.forEach(date => {
                    sortedGrouped[date] = grouped[date];
                });
                
                return sortedGrouped;
            }
            
            switchView(viewType) {
                const matchesContent = document.getElementById('sporttery-matches-content');
                const resultsContent = document.getElementById('sporttery-results-content');
                const scheduleNavbar = document.getElementById('date-navbar');
                const resultsNavbar = document.getElementById('results-date-navbar');
                
                if (viewType === 'matches') {
                    matchesContent.style.display = 'block';
                    resultsContent.style.display = 'none';
                    // æ˜¾ç¤ºèµ›ç¨‹çš„æ—¥æœŸå¯¼èˆªæ ï¼Œéšè—èµ›æœçš„æ—¥æœŸå¯¼èˆªæ 
                    if (scheduleNavbar) scheduleNavbar.style.display = 'block';
                    if (resultsNavbar) resultsNavbar.style.display = 'none';
                } else {
                    matchesContent.style.display = 'none';
                    resultsContent.style.display = 'block';
                    // æ˜¾ç¤ºèµ›æœçš„æ—¥æœŸå¯¼èˆªæ ï¼Œéšè—èµ›ç¨‹çš„æ—¥æœŸå¯¼èˆªæ 
                    if (scheduleNavbar) scheduleNavbar.style.display = 'none';
                    if (resultsNavbar) resultsNavbar.style.display = 'block';
                    
                    // åˆ‡æ¢åˆ°èµ›æœtabæ—¶ï¼Œå¦‚æœå·²æœ‰æ•°æ®åˆ™é‡æ–°æ¸²æŸ“
                    if (this.allResultsData && this.allResultsData.length > 0) {
                        this.renderResultsDateNavbar(this.allResultsData);
                        // é»˜è®¤æ˜¾ç¤ºç¬¬ä¸€ä¸ªæ—¥æœŸçš„æ•°æ®
                        const firstDateKey = Object.keys(this.dateGroups || {}).sort()[0];
                        if (firstDateKey) {
                            this.showResultsDateContent(firstDateKey);
                        } else {
                            // å¦‚æœæ²¡æœ‰æ—¥æœŸåˆ†ç»„ï¼Œæ˜¾ç¤ºæ‰€æœ‰æ•°æ®
                            this.renderResultsTable(this.allResultsData);
                        }
                    } else {
                        // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œå°è¯•åŠ è½½
                        this.loadExistingResultsOnly();
                    }
                }
            }
            
            selectMatch(matchCode) {
                // é€‰æ‹©æ¯”èµ›ï¼Œå¯ä»¥ç”¨äºåç»­çš„æ–‡ç« ç”Ÿæˆ
                showToast('info', 'æ¯”èµ›å·²é€‰æ‹©', `å·²é€‰æ‹©æ¯”èµ› ${matchCode}ï¼Œå¯ç”¨äºæ–‡ç« ç”Ÿæˆ`);
                console.log('é€‰æ‹©çš„æ¯”èµ›:', matchCode);
            }
            
            // æ–°å¢ï¼šAIé€‰æ‹©3åœºæ¯”èµ›
            async aiSelectMatches() {
                try {
                    this.updateStatus('AIæ­£åœ¨é€‰æ‹©æ¯”èµ›...', 'warning');
                    
                    const response = await fetch('/api/lottery/select-matches', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ date: this.getCurrentDate() })
                    });
                    
                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        this.updateStatus('AIé€‰æ‹©å®Œæˆ', 'success');
                        showToast('success', 'AIé€‰æ‹©å®Œæˆ', `å·²é€‰æ‹© ${result.data.count} åœºæ¯”èµ›è¿›è¡Œæ·±åº¦åˆ†æ`);
                        
                        // åˆ·æ–°æ˜¾ç¤º
                        await this.refreshMatchesData();
                    } else {
                        this.updateStatus('AIé€‰æ‹©å¤±è´¥', 'danger');
                        showToast('error', 'AIé€‰æ‹©å¤±è´¥', result.message || 'æœªçŸ¥é”™è¯¯');
                    }
                } catch (error) {
                    this.updateStatus('ç½‘ç»œé”™è¯¯', 'danger');
                    showToast('error', 'ç½‘ç»œé”™è¯¯', 'æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨');
                    console.error('AIé€‰æ‹©æ¯”èµ›å¤±è´¥:', error);
                }
            }
            
            // æ–°å¢ï¼šç”Ÿæˆæ·±åº¦åˆ†æ
            async generateAnalysis() {
                try {
                    this.updateStatus('æ­£åœ¨ç”Ÿæˆæ·±åº¦åˆ†æ...', 'warning');
                    
                    // è·å–é€‰ä¸­çš„æ¯”èµ›
                    const selectedMatches = this.getSelectedMatches();
                    if (selectedMatches.length === 0) {
                        showToast('warning', 'æ²¡æœ‰é€‰ä¸­çš„æ¯”èµ›', 'è¯·å…ˆä½¿ç”¨AIé€‰æ‹©3åœºæ¯”èµ›');
                        return;
                    }
                    
                    const response = await fetch('/api/lottery/generate-analysis', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ match_codes: selectedMatches })
                    });
                    
                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        this.updateStatus('æ·±åº¦åˆ†æç”Ÿæˆå®Œæˆ', 'success');
                        showToast('success', 'æ·±åº¦åˆ†æç”Ÿæˆå®Œæˆ', 'è¯·æŸ¥çœ‹æ¯”èµ›é¢„æµ‹ç»“æœ');
                        
                        // åˆ·æ–°æ˜¾ç¤º
                        await this.refreshMatchesData();
                    } else {
                        this.updateStatus('æ·±åº¦åˆ†æç”Ÿæˆå¤±è´¥', 'danger');
                        showToast('error', 'æ·±åº¦åˆ†æç”Ÿæˆå¤±è´¥', result.message || 'æœªçŸ¥é”™è¯¯');
                    }
                } catch (error) {
                    this.updateStatus('ç½‘ç»œé”™è¯¯', 'danger');
                    showToast('error', 'ç½‘ç»œé”™è¯¯', 'æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨');
                    console.error('ç”Ÿæˆæ·±åº¦åˆ†æå¤±è´¥:', error);
                }
            }
            
            // æ–°å¢ï¼šç”Ÿæˆæ–‡ç« åŠŸèƒ½
            async generateArticles() {
                try {
                    this.updateStatus('æ­£åœ¨ç”Ÿæˆæ–‡ç« ...', 'warning');
                    
                    // è·å–é€‰ä¸­çš„æ¯”èµ›
                    const selectedMatches = this.getSelectedMatches();
                    if (selectedMatches.length === 0) {
                        showToast('warning', 'æ²¡æœ‰é€‰ä¸­çš„æ¯”èµ›', 'è¯·å…ˆä½¿ç”¨AIé€‰æ‹©3åœºæ¯”èµ›');
                    return;
                }
                
                    // ä¸ºæ¯ä¸ªé€‰ä¸­çš„æ¯”èµ›ç”Ÿæˆæ–‡ç« 
                    const results = [];
                    for (const matchCode of selectedMatches) {
                        try {
                            const response = await fetch(`/api/lottery/generate-article/${matchCode}`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                }
                            });
                            
                    const result = await response.json();
                            results.push({ matchCode, result });
                    
                            if (result.status === 'success') {
                                showToast('success', `æ–‡ç« ç”ŸæˆæˆåŠŸ`, `æ¯”èµ› ${matchCode} çš„æ–‡ç« å·²ç”Ÿæˆ`);
                    } else {
                                showToast('error', `æ–‡ç« ç”Ÿæˆå¤±è´¥`, `æ¯”èµ› ${matchCode}: ${result.message || 'æœªçŸ¥é”™è¯¯'}`);
                    }
                } catch (error) {
                            console.error(`ç”Ÿæˆæ¯”èµ› ${matchCode} æ–‡ç« å¤±è´¥:`, error);
                            showToast('error', `ç½‘ç»œé”™è¯¯`, `æ— æ³•ä¸ºæ¯”èµ› ${matchCode} ç”Ÿæˆæ–‡ç« `);
                        }
                    }
                    
                    this.updateStatus('æ–‡ç« ç”Ÿæˆå®Œæˆ', 'success');
                    
                    // åˆ·æ–°æ˜¾ç¤º
                    await this.refreshMatchesData();
                    
                } catch (error) {
                    this.updateStatus('æ–‡ç« ç”Ÿæˆå¤±è´¥', 'danger');
                    showToast('error', 'æ–‡ç« ç”Ÿæˆå¤±è´¥', 'æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨');
                    console.error('ç”Ÿæˆæ–‡ç« å¤±è´¥:', error);
                }
            }
            
            // æ–°å¢ï¼šåŠ è½½ç»Ÿè®¡æ•°æ®
            async loadStats() {
                try {
                    const response = await fetch('/api/lottery/stats');
                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        const stats = result.data;
                        const quick = stats.quick_prediction;
                        const deep = stats.deep_analysis;
                        
                        // æ›´æ–°å¿«é€Ÿé¢„æµ‹ç»Ÿè®¡
                        document.getElementById('quick-total').textContent = quick.total_predictions || 0;
                        document.getElementById('quick-hits').textContent = quick.hit_count || 0;
                        document.getElementById('quick-rate').textContent = (quick.hit_rate || 0).toFixed(1) + '%';
                        
                        // æ›´æ–°æ·±åº¦åˆ†æç»Ÿè®¡
                        document.getElementById('deep-total').textContent = deep.total_predictions || 0;
                        document.getElementById('deep-hits').textContent = deep.hit_count || 0;
                        document.getElementById('deep-rate').textContent = (deep.hit_rate || 0).toFixed(1) + '%';
                        
                        // æ˜¾ç¤ºç»Ÿè®¡é¢æ¿
                        document.getElementById('stats-panel').style.display = 'block';
                    }
                } catch (error) {
                    console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
                }
            }
            
            // æ–°å¢ï¼šè·å–å½“å‰æ—¥æœŸ
            getCurrentDate() {
                const today = new Date();
                return today.toISOString().split('T')[0];
            }
            
            // æ–°å¢ï¼šè·å–é€‰ä¸­çš„æ¯”èµ›
            getSelectedMatches() {
                const selectedMatches = [];
                const rows = document.querySelectorAll('#sporttery-matches-tbody tr');
                rows.forEach(row => {
                    if (row.classList.contains('selected-for-analysis')) {
                        const matchCode = row.querySelector('td:first-child').textContent;
                        selectedMatches.push(matchCode);
                    }
                });
                return selectedMatches;
            }
            
            // æ–°å¢ï¼šæŸ¥çœ‹æ–‡ç« 
            async viewArticle(matchCode) {
                try {
                    const response = await fetch(`/api/lottery/article/${encodeURIComponent(matchCode)}`);
                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        // æ˜¾ç¤ºæ–‡ç« å†…å®¹
                        this.showArticleModal(result.data);
                    } else {
                        showToast('è·å–æ–‡ç« å¤±è´¥', result.message || 'æœªçŸ¥é”™è¯¯', 'error');
                    }
                } catch (error) {
                    showToast('ç½‘ç»œé”™è¯¯', 'æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨', 'error');
                    console.error('è·å–æ–‡ç« å¤±è´¥:', error);
                }
            }
            
            // æ–°å¢ï¼šåœ¨æ–‡ç« å·¥ä½œå°ä¸­æŸ¥çœ‹æ–‡ç« 
            async viewArticleInWorkbench(matchCode) {
                try {
                    const response = await fetch(`/api/lottery/article/${encodeURIComponent(matchCode)}`);
                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        // è·³è½¬åˆ°æ–‡ç« å·¥ä½œå°
                        this.navigateToWorkbench(result.data);
                    } else {
                        const reason = result.message || 'æœªçŸ¥é”™è¯¯';
                        showToast('è·å–æ–‡ç« å¤±è´¥', reason, 'error');
                    }
                } catch (error) {
                    showToast('ç½‘ç»œé”™è¯¯', 'æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨', 'error');
                    console.error('è·å–æ–‡ç« å¤±è´¥:', error);
                }
            }
            
            // æ–°å¢ï¼šè·³è½¬åˆ°æ–‡ç« å·¥ä½œå°å¹¶æ˜¾ç¤ºæ–‡ç« å†…å®¹
            navigateToWorkbench(articleData) {
                // åˆ‡æ¢åˆ°æ–‡ç« å·¥ä½œå°
                const workbenchLink = document.querySelector('a[href="#editor"]');
                if (workbenchLink) {
                    workbenchLink.click();
                }
                
                // ç­‰å¾…é¡µé¢åˆ‡æ¢åè®¾ç½®æ–‡ç« å†…å®¹
                setTimeout(() => {
                    this.setArticleInWorkbench(articleData);
                }, 500);
            }
            
            // æ–°å¢ï¼šåœ¨æ–‡ç« å·¥ä½œå°ä¸­è®¾ç½®æ–‡ç« å†…å®¹
            setArticleInWorkbench(articleData) {
                console.log('è®¾ç½®æ–‡ç« å†…å®¹:', articleData);
                
                // æ£€æŸ¥CodeMirrorç¼–è¾‘å™¨æ˜¯å¦å·²åˆå§‹åŒ–
                if (window.markdownEditor) {
                    console.log('ä½¿ç”¨CodeMirrorç¼–è¾‘å™¨è®¾ç½®å†…å®¹');
                    const content = articleData.article_content || articleData.content || '';
                    window.markdownEditor.setValue(content);
                    showToast('success', 'æ–‡ç« å·²åŠ è½½', 'æ·±åº¦åˆ†ææ–‡ç« å·²åŠ è½½åˆ°ç¼–è¾‘å™¨ä¸­');
                    } else {
                    // å¦‚æœæ²¡æœ‰CodeMirrorï¼Œç›´æ¥æ“ä½œtextarea
                    let editorElement = document.getElementById('markdown-editor');
                    
                    if (!editorElement) {
                        // å¦‚æœæ²¡æ‰¾åˆ°ï¼Œå°è¯•å…¶ä»–é€‰æ‹©å™¨
                        editorElement = document.querySelector('textarea[placeholder*="markdown"], textarea[id*="markdown"]');
                    }
                    
                    if (editorElement) {
                        console.log('æ‰¾åˆ°textareaç¼–è¾‘å™¨:', editorElement);
                        const content = articleData.article_content || articleData.content || '';
                        editorElement.value = content;
                        // è§¦å‘inputäº‹ä»¶ä»¥æ›´æ–°é¢„è§ˆ
                        editorElement.dispatchEvent(new Event('input', { bubbles: true }));
                        showToast('success', 'æ–‡ç« å·²åŠ è½½', 'æ·±åº¦åˆ†ææ–‡ç« å·²åŠ è½½åˆ°ç¼–è¾‘å™¨ä¸­');
                    } else {
                        console.log('ç¼–è¾‘å™¨æœªæ‰¾åˆ°');
                        showToast('warning', 'ç¼–è¾‘å™¨æœªæ‰¾åˆ°', 'è¯·ç¡®ä¿æ–‡ç« å·¥ä½œå°å·²æ­£ç¡®åŠ è½½');
                    }
                }
            }
            
            // æ–°å¢ï¼šåˆå§‹åŒ–tooltip
            initializeTooltips() {
                // åˆå§‹åŒ–Bootstrap tooltip
                const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                tooltipTriggerList.map(function (tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl);
                });
            }
            
            // æ–°å¢ï¼šé¢„è§ˆæ–‡ç« 
            async previewArticle(matchCode) {
                try {
                    const response = await fetch(`/api/lottery/preview/${matchCode}`);
                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        // æ˜¾ç¤ºé¢„è§ˆ
                        this.showPreviewModal(result.data);
                    } else {
                        showToast('error', 'è·å–é¢„è§ˆå¤±è´¥', result.message || 'æœªçŸ¥é”™è¯¯');
                    }
                } catch (error) {
                    showToast('error', 'ç½‘ç»œé”™è¯¯', 'æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨');
                    console.error('è·å–é¢„è§ˆå¤±è´¥:', error);
                }
            }
            
            // æ–°å¢ï¼šå®¡æ ¸é€šè¿‡
            async approveAnalysis(matchCode) {
                try {
                    const response = await fetch(`/api/lottery/approve/${matchCode}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        showToast('success', 'å®¡æ ¸é€šè¿‡', 'æ·±åº¦åˆ†æå·²å®¡æ ¸é€šè¿‡');
                        // åˆ·æ–°æ˜¾ç¤º
                        await this.refreshMatchesData();
                    } else {
                        showToast('error', 'å®¡æ ¸å¤±è´¥', result.message || 'æœªçŸ¥é”™è¯¯');
                    }
                } catch (error) {
                    showToast('error', 'ç½‘ç»œé”™è¯¯', 'æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨');
                    console.error('å®¡æ ¸å¤±è´¥:', error);
                }
            }
            
            // æ–°å¢ï¼šæ˜¾ç¤ºæ–‡ç« æ¨¡æ€æ¡†
            showArticleModal(articleData) {
                const modal = document.createElement('div');
                modal.className = 'modal fade';
                modal.innerHTML = `
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">æ·±åº¦åˆ†ææ–‡ç«  - ${articleData.match_display}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="article-content">
                                    <h6>é¢„æµ‹ç»“æœï¼š${articleData.scores.join(', ')}</h6>
                                    <div class="article-text">
                                        ${articleData.content}
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                                <button type="button" class="btn btn-success" onclick="sportteryManager.approveAnalysis('${articleData.match_code}')">
                                    <i class="bi bi-check-circle"></i> å®¡æ ¸é€šè¿‡
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                const modalInstance = new bootstrap.Modal(modal);
                modalInstance.show();
                
                modal.addEventListener('hidden.bs.modal', () => {
                    document.body.removeChild(modal);
                });
            }
            
            // æ–°å¢ï¼šæ˜¾ç¤ºé¢„è§ˆæ¨¡æ€æ¡†
            showPreviewModal(previewData) {
                const modal = document.createElement('div');
                modal.className = 'modal fade';
                modal.innerHTML = `
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">æ–‡ç« é¢„è§ˆ - ${previewData.match_display}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="preview-content">
                                    <h6>é¢„æµ‹ç»“æœï¼š${previewData.scores.join(', ')}</h6>
                                    <div class="preview-text">
                                        ${previewData.preview}
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                const modalInstance = new bootstrap.Modal(modal);
                modalInstance.show();
                
                modal.addEventListener('hidden.bs.modal', () => {
                    document.body.removeChild(modal);
                });
            }
            
            showLoading(show) {
                const loading = document.getElementById('sporttery-loading');
                if (loading) {
                    loading.style.display = show ? 'block' : 'none';
                } else {
                    console.warn('sporttery-loadingå…ƒç´ æœªæ‰¾åˆ°');
                }
            }
            
            updateStatus(message, type) {
                const status = document.getElementById('sporttery-status');
                if (status) {
                status.textContent = message;
                    status.className = `badge status-badge bg-${type} w-100 text-start`;
                }
            }
            
            updateLastUpdateTime(timestamp) {
                const lastUpdate = document.getElementById('sporttery-last-update');
                if (timestamp) {
                    const date = new Date(timestamp);
                    lastUpdate.textContent = `æœ€åæ›´æ–°: ${date.toLocaleString()}`;
                }
            }
            
            formatTime(timestamp) {
                if (!timestamp) return '--';
                const date = new Date(timestamp);
                // æ£€æŸ¥æ—¥æœŸæ˜¯å¦æœ‰æ•ˆ
                if (isNaN(date.getTime())) return '--';
                return date.toLocaleString();
            }
            
            editMatchResult(matchCode, currentScore) {
                // æ‰¾åˆ°å¯¹åº”çš„è¡¨æ ¼è¡Œï¼ˆä½¿ç”¨ç¬¬ä¸€ä¸ªè¡¨æ ¼ï¼Œå› ä¸ºè¿™æ˜¯èµ›ç¨‹è¡¨æ ¼ï¼‰
                const tables = document.querySelectorAll('table');
                let targetRow = null;
                
                // åœ¨ç¬¬ä¸€ä¸ªè¡¨æ ¼ä¸­æŸ¥æ‰¾
                const firstTable = tables[0];
                if (firstTable) {
                    const rows = firstTable.querySelectorAll('tr');
                    for (let row of rows) {
                        const matchCodeCell = row.cells[0]; // æ¯”èµ›ç¼–å·åœ¨ç¬¬ä¸€åˆ—
                        if (matchCodeCell && matchCodeCell.textContent.trim() === matchCode) {
                            targetRow = row;
                            break;
                        }
                    }
                }
                
                if (!targetRow) {
                    showToast('error', 'é”™è¯¯', 'æœªæ‰¾åˆ°å¯¹åº”çš„æ¯”èµ›è¡Œ');
                    return;
                }
                
                // æ‰¾åˆ°å®é™…æ¯”åˆ†åˆ—ï¼ˆç¬¬6åˆ—ï¼Œç´¢å¼•5ï¼‰
                const scoreCell = targetRow.cells[5];
                if (!scoreCell) {
                    showToast('error', 'é”™è¯¯', 'æœªæ‰¾åˆ°æ¯”åˆ†åˆ—');
                    return;
                }
                
                // åˆ›å»ºè¾“å…¥æ¡†
                const inputGroup = document.createElement('div');
                inputGroup.className = 'input-group input-group-sm';
                inputGroup.innerHTML = `
                    <input type="text" class="form-control score-input" 
                           value="${currentScore === 'æœªå½•å…¥' ? '' : currentScore}" 
                           placeholder="ä¾‹å¦‚: 2-1" maxlength="10">
                    <button class="btn btn-success btn-sm" type="button" onclick="sportteryManager.saveMatchResult('${matchCode}', this)">
                        <i class="bi bi-check"></i>
                    </button>
                    <button class="btn btn-secondary btn-sm" type="button" onclick="sportteryManager.cancelEdit(this)">
                        <i class="bi bi-x"></i>
                    </button>
                `;
                
                // ä¿å­˜åŸå§‹å†…å®¹
                inputGroup.dataset.originalContent = scoreCell.innerHTML;
                
                // æ›¿æ¢å•å…ƒæ ¼å†…å®¹
                scoreCell.innerHTML = '';
                scoreCell.appendChild(inputGroup);
                
                // èšç„¦è¾“å…¥æ¡†
                const input = inputGroup.querySelector('.score-input');
                input.focus();
                input.select();
            }
            
            cancelEdit(button) {
                const inputGroup = button.closest('.input-group');
                const scoreCell = inputGroup.parentElement;
                scoreCell.innerHTML = inputGroup.dataset.originalContent;
            }
            
            async saveMatchResult(matchCode, button) {
                const inputGroup = button.closest('.input-group');
                const input = inputGroup.querySelector('.score-input');
                const actualScore = input.value.trim();
                
                // å¦‚æœè¾“å…¥ä¸ºç©ºï¼Œåˆ™ä¿å­˜ä¸º"æœªå½•å…¥"
                if (!actualScore) {
                    try {
                        // æ˜¾ç¤ºä¿å­˜ä¸­çŠ¶æ€
                        button.disabled = true;
                        button.innerHTML = '<i class="bi bi-hourglass-split"></i>';
                        
                        const response = await fetch(`/api/lottery/match/${matchCode}/result`, {
                            method: 'PUT',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({actual_score: ''})
                        });
                        
                        if (!response.ok) {
                            throw new Error('ä¿å­˜å¤±è´¥');
                        }
                        
                        // æ›´æ–°æ˜¾ç¤º
                        const scoreCell = inputGroup.parentElement;
                        scoreCell.innerHTML = '<span class="text-muted">æœªå½•å…¥</span>';
                        
                        showToast('success', 'ä¿å­˜æˆåŠŸ', 'å·²è®¾ç½®ä¸ºæœªå½•å…¥');
                } catch (error) {
                        console.error('ä¿å­˜å¤±è´¥:', error);
                        showToast('error', 'ä¿å­˜å¤±è´¥', error.message);
                        // æ¢å¤æŒ‰é’®çŠ¶æ€
                        button.disabled = false;
                        button.innerHTML = '<i class="bi bi-check"></i>';
                    }
                    return;
                }
                    
                if (!/^\d+-\d+$/.test(actualScore)) {
                    showToast('error', 'æ ¼å¼é”™è¯¯', 'æ¯”åˆ†æ ¼å¼é”™è¯¯ï¼Œåº”ä¸º"æ•°å­—-æ•°å­—"æ ¼å¼ï¼Œå¦‚"2-1"');
                    input.focus();
                    input.select();
                    return;
                }
                    
                try {
                    // æ˜¾ç¤ºä¿å­˜ä¸­çŠ¶æ€
                    button.disabled = true;
                    button.innerHTML = '<i class="bi bi-hourglass-split"></i>';
                    
                    const response = await fetch(`/api/lottery/match/${matchCode}/result`, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({actual_score: actualScore})
                    });
                    
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        showToast('success', 'ä¿å­˜æˆåŠŸ', `æ¯”èµ›ç»“æœå·²æ›´æ–°: ${matchCode} -> ${actualScore}`);
                        
                        // æ›´æ–°å•å…ƒæ ¼æ˜¾ç¤º
                        const scoreCell = inputGroup.parentElement;
                        scoreCell.innerHTML = actualScore;
                        
                        // åˆ·æ–°æ•°æ®
                        this.refreshMatchesData();
                    } else {
                        showToast('error', 'ä¿å­˜å¤±è´¥', data.message || 'æœªçŸ¥é”™è¯¯');
                        // æ¢å¤æŒ‰é’®çŠ¶æ€
                        button.disabled = false;
                        button.innerHTML = '<i class="bi bi-check"></i>';
                    }
                } catch (error) {
                    showToast('error', 'ç½‘ç»œé”™è¯¯', 'æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨');
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    button.disabled = false;
                    button.innerHTML = '<i class="bi bi-check"></i>';
                }
            }
            
            async refreshAccuracyStats() {
                // æ˜¾ç¤ºçŠ¶æ€æç¤º
                this.updateStatus('æ­£åœ¨ç»Ÿè®¡å‘½ä¸­ç‡...', 'warning');
                
                try {
                    const response = await fetch('/api/lottery/accuracy/refresh', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({})
                    });
                    
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        // æ›´æ–°ç»Ÿè®¡å¡ç‰‡æ˜¾ç¤º
                        this.updateStatsCard(data.data);
                        
                        // æ˜¾ç¤ºæˆåŠŸçŠ¶æ€
                        const stats = data.data || {};
                        const quickText = stats.quick_total > 0 
                            ? `å¿«é€Ÿé¢„æµ‹ ${stats.quick_hits}/${stats.quick_total} (${(stats.quick_accuracy * 100).toFixed(1)}%)`
                            : 'å¿«é€Ÿé¢„æµ‹ æš‚æ— æ•°æ®';
                        const deepText = stats.deep_total > 0
                            ? `æ·±åº¦åˆ†æ ${stats.deep_hits}/${stats.deep_total} (${(stats.deep_accuracy * 100).toFixed(1)}%)`
                            : 'æ·±åº¦åˆ†æ æš‚æ— æ•°æ®';
                        
                        this.updateStatus(`å‘½ä¸­ç‡ç»Ÿè®¡å®Œæˆ: ${quickText}, ${deepText}`, 'success');
                        showToast('success', 'å‡†ç¡®ç‡ç»Ÿè®¡å·²åˆ·æ–°', data.message || 'ç»Ÿè®¡æ•°æ®å·²æ›´æ–°');
                    } else {
                        this.updateStatus('å‘½ä¸­ç‡ç»Ÿè®¡å¤±è´¥', 'danger');
                        showToast('error', 'åˆ·æ–°å¤±è´¥', data.message || 'æœªçŸ¥é”™è¯¯');
                    }
                } catch (error) {
                    console.error('åˆ·æ–°å‘½ä¸­ç‡å¤±è´¥:', error);
                    this.updateStatus('å‘½ä¸­ç‡ç»Ÿè®¡å¤±è´¥: ç½‘ç»œé”™è¯¯', 'danger');
                    showToast('error', 'ç½‘ç»œé”™è¯¯', 'æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨');
                }
            }
            
            updateStatsCard(stats) {
                const quickAccuracyEl = document.getElementById('quick-accuracy');
                const deepAccuracyEl = document.getElementById('deep-accuracy');
                
                if (quickAccuracyEl && stats.quick_accuracy !== undefined) {
                    quickAccuracyEl.textContent = (stats.quick_accuracy * 100).toFixed(1) + '%';
                }
                
                if (deepAccuracyEl && stats.deep_accuracy !== undefined) {
                    deepAccuracyEl.textContent = (stats.deep_accuracy * 100).toFixed(1) + '%';
                }
            }
            
            // æ˜¾ç¤ºæ‰‹åŠ¨è§¦å‘å·¥ä½œæµç¡®è®¤å¼¹çª—
            showRunWorkflowConfirm() {
                const modal = new bootstrap.Modal(document.getElementById('runWorkflowModal'));
                modal.show();
            }
            
            // æ‰§è¡Œæ‰€æœ‰å·¥ä½œæµä»»åŠ¡
            async runAllWorkflow() {
                const button = document.getElementById('run-all-workflow');
                const originalText = button.innerHTML;
                
                try {
                    // å…³é—­ç¡®è®¤å¼¹çª—
                    bootstrap.Modal.getInstance(document.getElementById('runWorkflowModal')).hide();
                    
                    // ä¿å­˜æŒ‰é’®çŠ¶æ€å¹¶æ˜¾ç¤ºä¸­æ–­æŒ‰é’®
                    this._workflowButtonState = { originalText };
                    button.disabled = true;
                    button.innerHTML = '<i class="bi bi-hourglass-split"></i> æ‰§è¡Œä¸­...';
                    this.showInterruptButton(true);
                    
                    // æ˜¾ç¤ºæ‰§è¡Œä¸­çŠ¶æ€
                    showToast('info', 'å¼€å§‹æ‰§è¡Œ', 'æ­£åœ¨æ‰§è¡Œæ‰€æœ‰å·¥ä½œæµä»»åŠ¡ï¼Œè¯·ç¨å€™...');
                    
                    // è°ƒç”¨åç«¯API
                    const response = await fetch('/api/lottery/scheduler/run-all-tasks', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'}
                    });
                    
                    const data = await response.json();
                        
                    if (data.status === 'success') {
                        this.displayWorkflowResults(data.data);
                        showToast('success', 'æ‰§è¡Œå®Œæˆ', `æˆåŠŸæ‰§è¡Œ ${data.data.success_tasks}/${data.data.total_tasks} ä¸ªä»»åŠ¡`);
                    } else {
                        showToast('error', 'æ‰§è¡Œå¤±è´¥', data.message);
                    }
                    
                } catch (error) {
                    showToast('error', 'ç½‘ç»œé”™è¯¯', 'æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨');
                    console.error('æ‰§è¡Œå·¥ä½œæµå¤±è´¥:', error);
                } finally {
                    // æ¢å¤æŒ‰é’®çŠ¶æ€å¹¶éšè—ä¸­æ–­æŒ‰é’®
                    if (this._workflowButtonState && button) {
                        button.disabled = false;
                        button.innerHTML = this._workflowButtonState.originalText;
                        this._workflowButtonState = null;
                    }
                    this.showInterruptButton(false);
                }
            }
            
            // æ˜¾ç¤ºå·¥ä½œæµæ‰§è¡Œç»“æœ
            displayWorkflowResults(results) {
                const { total_tasks, success_tasks, failed_tasks, task_results } = results;
                
                // è®¡ç®—æˆåŠŸç‡
                const successRate = total_tasks > 0 ? (success_tasks / total_tasks * 100).toFixed(1) : 0;
                
                // æ„å»ºç»“æœHTML
                let resultHTML = `
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <div class="card border-primary">
                                <div class="card-body text-center">
                                    <h5 class="card-title text-primary">${total_tasks}</h5>
                                    <p class="card-text">æ€»ä»»åŠ¡æ•°</p>
                        </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card border-success">
                                <div class="card-body text-center">
                                    <h5 class="card-title text-success">${success_tasks}</h5>
                                    <p class="card-text">æˆåŠŸä»»åŠ¡</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card border-danger">
                                <div class="card-body text-center">
                                    <h5 class="card-title text-danger">${failed_tasks}</h5>
                                    <p class="card-text">å¤±è´¥ä»»åŠ¡</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert ${failed_tasks === 0 ? 'alert-success' : 'alert-warning'}">
                        <i class="bi bi-${failed_tasks === 0 ? 'check-circle' : 'exclamation-triangle'}"></i>
                        <strong>æ‰§è¡Œç»“æœï¼š</strong> æˆåŠŸç‡ ${successRate}% (${success_tasks}/${total_tasks})
                    </div>
                    
                    <h6 class="mb-3">ä»»åŠ¡è¯¦æƒ…ï¼š</h6>
                    <div class="list-group">
                `;
                
                // æ·»åŠ æ¯ä¸ªä»»åŠ¡çš„æ‰§è¡Œç»“æœ
                for (const [taskName, taskResult] of Object.entries(task_results)) {
                    const iconClass = taskResult.status === 'success' ? 'bi-check-circle-fill text-success' : 'bi-x-circle-fill text-danger';
                    const statusText = taskResult.status === 'success' ? 'æˆåŠŸ' : 'å¤±è´¥';
                    
                    resultHTML += `
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between align-items-center">
                                <h6 class="mb-1">
                                    <i class="bi ${iconClass}"></i>
                                    ${taskName}
                                </h6>
                                <span class="badge ${taskResult.status === 'success' ? 'bg-success' : 'bg-danger'}">${statusText}</span>
                            </div>
                            <p class="mb-1 small text-muted">${taskResult.message || 'æ— è¯¦ç»†ä¿¡æ¯'}</p>
                        </div>
                    `;
                }
                
                resultHTML += `
                    </div>
                    
                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="bi bi-info-circle"></i>
                            æ‰§è¡Œæ—¶é—´ï¼š${new Date().toLocaleString()}
                        </small>
                    </div>
                `;
                
                // å¡«å……ç»“æœå†…å®¹å¹¶æ˜¾ç¤ºå¼¹çª—
                document.getElementById('workflowResultContent').innerHTML = resultHTML;
                
                const resultModal = new bootstrap.Modal(document.getElementById('workflowResultModal'));
                resultModal.show();
            }
            
            // åˆå¹¶æ–‡ç« çŠ¶æ€æ‘˜è¦åˆ°æ¯”èµ›æ•°æ®ï¼Œæ ‡è®°å¯æŸ¥çœ‹æ–‡ç« 
            async mergeArticleStatus(matches) {
                try {
                    const resp = await fetch('/api/lottery/articles/status-summary');
                    if (!resp.ok) return;
                    const data = await resp.json();
                    if (data.status !== 'success' || !data.data) return;
                    const generatedMap = new Set((data.data.generated || []).map(x => x.match_code || x));
                    matches.forEach(m => {
                        if (generatedMap.has(m.match_code)) {
                            m.source_type = 'deep';
                            m.article_generated = true;
                        }
                    });
                    // æ ‡è®°å·²åˆå¹¶ï¼Œé¿å…é‡å¤
                    Object.defineProperty(matches, '__articleStatusMerged', { value: true, enumerable: false });
                } catch (e) {
                    console.warn('åˆå¹¶æ–‡ç« çŠ¶æ€å¤±è´¥', e);
                }
            }
        }
    </script>
    -->
    
    <!-- æ‰€æœ‰å†…è”JavaScriptä»£ç å·²ç§»è‡³æ¨¡å—æ–‡ä»¶ -->
    <!-- æ¨¡å—æ–‡ä»¶ï¼š
         - MatchResultService.js: æ¯”èµ›ç»“æœä¿å­˜æœåŠ¡
         - DataCollectionMonitor.js: æ•°æ®æœé›†çŠ¶æ€ç›‘æ§
         - AppInitializer.js: åº”ç”¨åˆå§‹åŒ–é€»è¾‘
         - ConfigManager: ä½¿ç”¨app.jsä¸­å·²å­˜åœ¨çš„ConfigManagerç±»
    -->



    <!-- æ‰‹åŠ¨è§¦å‘å·¥ä½œæµç¡®è®¤å¼¹çª— -->
    <div class="modal fade" id="runWorkflowModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-exclamation-triangle text-warning"></i> 
                        ç¡®è®¤æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="bi bi-info-circle"></i>
                        <strong>æ³¨æ„ï¼š</strong>æ­¤æ“ä½œå°†é‡æ–°æ‰§è¡Œæ‰€æœ‰å®šæ—¶ä»»åŠ¡ï¼ŒåŒ…æ‹¬ï¼š
                    </div>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-trophy text-warning"></i> èµ›æœæŠ“å–</span>
                            <small class="text-muted">æ”¶é›†æ˜¨æ—¥æ¯”èµ›ç»“æœ</small>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-calendar-event text-info"></i> èµ›ç¨‹æŠ“å–</span>
                            <small class="text-muted">è·å–ä»Šæ—¥æ¯”èµ›ä¿¡æ¯</small>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-lightning text-success"></i> å¿«é€Ÿé¢„æµ‹</span>
                            <small class="text-muted">AIå¿«é€Ÿæ¯”åˆ†é¢„æµ‹</small>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-search text-primary"></i> æ·±åº¦åˆ†æé€‰æ‹©</span>
                            <small class="text-muted">é€‰æ‹©é‡ç‚¹åˆ†ææ¯”èµ›</small>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-newspaper text-danger"></i> æ–‡ç« ç”Ÿæˆ</span>
                            <small class="text-muted">ç”Ÿæˆæ·±åº¦åˆ†ææ–‡ç« </small>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-graph-up-arrow text-secondary"></i> å‡†ç¡®ç‡æ›´æ–°</span>
                            <small class="text-muted">æ›´æ–°é¢„æµ‹å‡†ç¡®ç‡ç»Ÿè®¡</small>
                        </li>
                    </ul>
                    <div class="mt-3">
                        <p class="text-danger mb-0">
                            <i class="bi bi-exclamation-triangle"></i>
                            <strong>ç¡®å®šè¦é‡æ–°æ‰§è¡Œæ‰€æœ‰å·¥ä½œæµä»»åŠ¡å—ï¼Ÿ</strong>
                        </p>
                        <small class="text-muted">æ­¤æ“ä½œå¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´å®Œæˆã€‚</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-danger" id="confirmRunWorkflow">
                        <i class="bi bi-arrow-clockwise"></i> ç¡®è®¤æ‰§è¡Œ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- å·¥ä½œæµæ‰§è¡Œç»“æœå¼¹çª— -->
    <div class="modal fade" id="workflowResultModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-check-circle text-success"></i> 
                        å·¥ä½œæµæ‰§è¡Œç»“æœ
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="workflowResultContent">
                        <!-- æ‰§è¡Œç»“æœå†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€å¡«å…… -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>


</body>
</html>